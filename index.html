<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>CashReward Admin Panel - Game Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* ... (all existing CSS remains the same) ... */
    </style>
</head>
<body>
    <!-- ... (all existing HTML structure remains the same until adnetwork section) ... -->
    
    <!-- Ad Network Functions - UPDATED WITH CORRECT MONETAG CONFIGURATION -->
    <script type="module">
        // ... (all existing Firebase and initialization code remains the same) ... 
        
        // Ad Network Functions - FIXED FOR MONETAG
        async function loadAdNetwork() {
            const page = document.getElementById('adnetwork');
            page.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Ad Network Configuration</h1>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">Ad Network Settings</h2>
                    <p class="text-gray-600 mb-6">Configure ad networks for your app. These IDs will be used to display ads in the app.</p>
                    
                    <!-- Ad Network Rotation Settings -->
                    <div class="mb-8 border border-gray-200 rounded-lg p-4 bg-gray-50">
                        <h3 class="text-lg font-semibold mb-3 text-gray-800">Ad Network Rotation System</h3>
                        <p class="text-sm text-gray-600 mb-4">
                            <strong>Rotation Logic:</strong> When both enabled, ads will rotate between both networks with the fastest response. 
                            When only one enabled, show that network's ads. When both disabled, show "ads not available".
                        </p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="feature-toggle">
                                <div>
                                    <label class="feature-label text-gray-700">Taddy.pro</label>
                                    <p class="text-sm text-gray-500">Enable/disable Taddy.pro ads</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="taddy-enabled">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                            <div class="feature-toggle">
                                <div>
                                    <label class="feature-label text-gray-700">Monetag</label>
                                    <p class="text-sm text-gray-500">Enable/disable Monetag ads</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="monetag-enabled">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Taddy.pro Configuration -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold mb-3 text-green-700">Taddy.pro</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="block font-medium mb-1 text-gray-700">Public ID</label>
                                    <input type="text" id="taddy-publicid" class="input-field" placeholder="Enter Taddy.pro Public ID">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Monetag Configuration - FIXED -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold mb-3 text-purple-700">Monetag</h3>
                            <p class="text-sm text-gray-600 mb-4">
                                Monetag uses script-based ads. For In-App Interstitial ads, you need to provide the Zone ID only.
                                No API key is required for interstitial ads.
                            </p>
                            <div class="space-y-3">
                                <div>
                                    <label class="block font-medium mb-1 text-gray-700">In-App Interstitial Zone ID</label>
                                    <input type="text" id="monetag-interstitialid" class="input-field" placeholder="Enter Monetag Zone ID (e.g., 10533857)">
                                    <p class="text-sm text-gray-500 mt-1">This is the Zone ID for in-app interstitial ads</p>
                                </div>
                                <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                                    <h4 class="font-semibold text-blue-800 mb-2">Monetag Script Example</h4>
                                    <code class="text-sm text-gray-700 bg-gray-100 p-2 rounded block">
                                        &lt;script src='//libtl.com/sdk.js' data-zone='YOUR_ZONE_ID' data-sdk='show_YOUR_ZONE_ID'&gt;&lt;/script&gt;
                                    </code>
                                    <p class="text-sm text-gray-600 mt-2">
                                        <strong>For In-App Interstitial Ads:</strong> No capping, no interval settings needed.
                                        The script will automatically handle ad display.
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- RichAds Configuration -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold mb-3 text-blue-700">RichAds Network</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="block font-medium mb-1 text-gray-700">Pub ID</label>
                                    <input type="text" id="richads-pubid" class="input-field" placeholder="Enter RichAds Publisher ID">
                                </div>
                                <div>
                                    <label class="block font-medium mb-1 text-gray-700">App ID</label>
                                    <input type="text" id="richads-appid" class="input-field" placeholder="Enter RichAds Application ID">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Adsgram Configuration -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold mb-3 text-orange-700">Adsgram</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="block font-medium mb-1 text-gray-700">Reward ID</label>
                                    <input type="text" id="adsgram-rewardid" class="input-field" placeholder="Enter Adsgram Reward ID">
                                </div>
                                <div>
                                    <label class="block font-medium mb-1 text-gray-700">Interstitial ID</label>
                                    <input type="text" id="adsgram-interstitialid" class="input-field" placeholder="Enter Adsgram Interstitial ID">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8">
                        <button onclick="saveAdNetworkConfig()" class="btn btn-primary px-8 py-3">
                            <i data-lucide="save" class="w-5 h-5 mr-2"></i> Save Ad Network Settings
                        </button>
                    </div>
                </div>
            `;
            
            // Load existing ad network settings
            try {
                await loadAdNetworkData();
                lucide.createIcons();
            } catch (error) {
                console.error("Error loading ad network:", error);
                showAlert("❌ Error loading ad network settings: " + error.message, true);
            }
        }

        async function loadAdNetworkData() {
            try {
                const configSnap = await getDoc(doc(db, "config", "adnetwork"));
                
                if (configSnap.exists()) {
                    const config = configSnap.data();
                    
                    if (config.richadsPubId) {
                        document.getElementById('richads-pubid').value = config.richadsPubId;
                    }
                    
                    if (config.richadsAppId) {
                        document.getElementById('richads-appid').value = config.richadsAppId;
                    }
                    
                    if (config.taddyPublicId) {
                        document.getElementById('taddy-publicid').value = config.taddyPublicId;
                    }
                    
                    if (config.taddyEnabled !== undefined) {
                        document.getElementById('taddy-enabled').checked = config.taddyEnabled;
                    }
                    
                    // FIXED: Load Monetag settings correctly
                    if (config.monetagInterstitialId) {
                        document.getElementById('monetag-interstitialid').value = config.monetagInterstitialId;
                    }
                    
                    if (config.monetagEnabled !== undefined) {
                        document.getElementById('monetag-enabled').checked = config.monetagEnabled;
                    }
                    
                    // Note: Monetag doesn't use API key for interstitial ads
                    
                    if (config.adsgramRewardId) {
                        document.getElementById('adsgram-rewardid').value = config.adsgramRewardId;
                    }
                    
                    if (config.adsgramInterstitialId) {
                        document.getElementById('adsgram-interstitialid').value = config.adsgramInterstitialId;
                    }
                }
            } catch (error) {
                console.error("Error loading ad network config:", error);
            }
        }

        async function saveAdNetworkConfig() {
            loader.style.display = 'flex';
            try {
                // Get Monetag Zone ID
                const monetagInterstitialId = document.getElementById('monetag-interstitialid').value.trim();
                
                if (document.getElementById('monetag-enabled').checked && !monetagInterstitialId) {
                    showAlert("Please enter Monetag Interstitial Zone ID when Monetag is enabled.");
                    return;
                }
                
                const adNetworkConfig = {
                    richadsPubId: document.getElementById('richads-pubid').value.trim(),
                    richadsAppId: document.getElementById('richads-appid').value.trim(),
                    taddyPublicId: document.getElementById('taddy-publicid').value.trim(),
                    taddyEnabled: document.getElementById('taddy-enabled').checked,
                    // FIXED: Save Monetag settings correctly
                    monetagInterstitialId: monetagInterstitialId,
                    monetagEnabled: document.getElementById('monetag-enabled').checked,
                    // Note: Monetag doesn't use API key for interstitial ads
                    monetagApiKey: "", // Keep empty as Monetag doesn't need API key for interstitial
                    adsgramRewardId: document.getElementById('adsgram-rewardid').value.trim(),
                    adsgramInterstitialId: document.getElementById('adsgram-interstitialid').value.trim(),
                    updatedAt: serverTimestamp()
                };
                
                // Save to Firebase
                await setDoc(doc(db, "config", "adnetwork"), adNetworkConfig);
                
                showToast("✅ Ad network settings saved successfully!");
                
            } catch (error) {
                console.error("Error saving ad network config:", error);
                showAlert("❌ Error saving ad network settings: " + error.message, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        // ... (all remaining functions remain the same) ...
        
        // Initialize Monetag helper function for the mini-app (for reference)
        function initializeMonetagAds(zoneId) {
            if (!zoneId) return null;
            
            // This is how the mini-app would initialize Monetag ads
            const script = document.createElement('script');
            script.src = '//libtl.com/sdk.js';
            script.setAttribute('data-zone', zoneId);
            script.setAttribute('data-sdk', `show_${zoneId}`);
            
            return {
                script: script,
                showInterstitial: function() {
                    // This function would be called in the mini-app to show interstitial ads
                    if (typeof window[`show_${zoneId}`] === 'function') {
                        window[`show_${zoneId}`]({
                            type: 'inApp',
                            inAppSettings: {
                                frequency: 2,
                                capping: 0.1,
                                interval: 30,
                                timeout: 5,
                                everyPage: false
                            }
                        });
                    }
                }
            };
        }

                // Ad Network Functions - FIXED FOR MONETAG
        async function loadAdNetwork() {
            const page = document.getElementById('adnetwork');
            page.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Ad Network Configuration</h1>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">Ad Network Settings</h2>
                    <p class="text-gray-600 mb-6">Configure ad networks for your app. These IDs will be used to display ads in the app.</p>
                    
                    <!-- Ad Network Rotation Settings -->
                    <div class="mb-8 border border-gray-200 rounded-lg p-4 bg-gray-50">
                        <h3 class="text-lg font-semibold mb-3 text-gray-800">Ad Network Rotation System</h3>
                        <p class="text-sm text-gray-600 mb-4">
                            <strong>Rotation Logic:</strong> When both enabled, ads will rotate between both networks with the fastest response. 
                            When only one enabled, show that network's ads. When both disabled, show "ads not available".
                        </p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="feature-toggle">
                                <div>
                                    <label class="feature-label text-gray-700">Taddy.pro</label>
                                    <p class="text-sm text-gray-500">Enable/disable Taddy.pro ads</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="taddy-enabled">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                            <div class="feature-toggle">
                                <div>
                                    <label class="feature-label text-gray-700">Monetag</label>
                                    <p class="text-sm text-gray-500">Enable/disable Monetag ads</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="monetag-enabled">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Taddy.pro Configuration -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold mb-3 text-green-700">Taddy.pro</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="block font-medium mb-1 text-gray-700">Public ID</label>
                                    <input type="text" id="taddy-publicid" class="input-field" placeholder="Enter Taddy.pro Public ID">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Monetag Configuration - FIXED -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold mb-3 text-purple-700">Monetag</h3>
                            <p class="text-sm text-gray-600 mb-4">
                                <strong>Important:</strong> Monetag uses script-based ads. For In-App Interstitial ads, you only need the Zone ID.
                                No API key is required for interstitial ads.
                            </p>
                            <div class="space-y-3">
                                <div>
                                    <label class="block font-medium mb-1 text-gray-700">In-App Interstitial Zone ID</label>
                                    <input type="text" id="monetag-interstitialid" class="input-field" placeholder="Enter Monetag Zone ID (e.g., 10533857)">
                                    <p class="text-sm text-gray-500 mt-1">This is the Zone ID from your Monetag dashboard</p>
                                </div>
                                <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                                    <h4 class="font-semibold text-blue-800 mb-2">Monetag Script Example</h4>
                                    <div class="bg-gray-800 text-gray-100 p-3 rounded text-sm font-mono overflow-x-auto">
                                        &lt;script src='//libtl.com/sdk.js' data-zone='10533857' data-sdk='show_10533857'&gt;&lt;/script&gt;
                                    </div>
                                    <p class="text-sm text-gray-600 mt-2">
                                        <strong>In-App Interstitial Ad Configuration:</strong><br>
                                        - No capping<br>
                                        - No interval settings needed<br>
                                        - The script handles ad display automatically
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- RichAds Configuration -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold mb-3 text-blue-700">RichAds Network</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="block font-medium mb-1 text-gray-700">Pub ID</label>
                                    <input type="text" id="richads-pubid" class="input-field" placeholder="Enter RichAds Publisher ID">
                                </div>
                                <div>
                                    <label class="block font-medium mb-1 text-gray-700">App ID</label>
                                    <input type="text" id="richads-appid" class="input-field" placeholder="Enter RichAds Application ID">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Adsgram Configuration -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold mb-3 text-orange-700">Adsgram</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="block font-medium mb-1 text-gray-700">Reward ID</label>
                                    <input type="text" id="adsgram-rewardid" class="input-field" placeholder="Enter Adsgram Reward ID">
                                </div>
                                <div>
                                    <label class="block font-medium mb-1 text-gray-700">Interstitial ID</label>
                                    <input type="text" id="adsgram-interstitialid" class="input-field" placeholder="Enter Adsgram Interstitial ID">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8">
                        <button onclick="saveAdNetworkConfig()" class="btn btn-primary px-8 py-3">
                            <i data-lucide="save" class="w-5 h-5 mr-2"></i> Save Ad Network Settings
                        </button>
                    </div>
                </div>
            `;
            
            // Load existing ad network settings
            try {
                await loadAdNetworkData();
                lucide.createIcons();
            } catch (error) {
                console.error("Error loading ad network:", error);
                showAlert("❌ Error loading ad network settings: " + error.message, true);
            }
        }

        async function loadAdNetworkData() {
            try {
                const configSnap = await getDoc(doc(db, "config", "adnetwork"));
                
                if (configSnap.exists()) {
                    const config = configSnap.data();
                    
                    if (config.richadsPubId) {
                        document.getElementById('richads-pubid').value = config.richadsPubId;
                    }
                    
                    if (config.richadsAppId) {
                        document.getElementById('richads-appid').value = config.richadsAppId;
                    }
                    
                    if (config.taddyPublicId) {
                        document.getElementById('taddy-publicid').value = config.taddyPublicId;
                    }
                    
                    if (config.taddyEnabled !== undefined) {
                        document.getElementById('taddy-enabled').checked = config.taddyEnabled;
                    }
                    
                    // FIXED: Load Monetag settings correctly
                    if (config.monetagInterstitialId) {
                        document.getElementById('monetag-interstitialid').value = config.monetagInterstitialId;
                    }
                    
                    if (config.monetagEnabled !== undefined) {
                        document.getElementById('monetag-enabled').checked = config.monetagEnabled;
                    }
                    
                    // Note: Monetag doesn't use API key for interstitial ads
                    
                    if (config.adsgramRewardId) {
                        document.getElementById('adsgram-rewardid').value = config.adsgramRewardId;
                    }
                    
                    if (config.adsgramInterstitialId) {
                        document.getElementById('adsgram-interstitialid').value = config.adsgramInterstitialId;
                    }
                }
            } catch (error) {
                console.error("Error loading ad network config:", error);
            }
        }

        async function saveAdNetworkConfig() {
            loader.style.display = 'flex';
            try {
                // Get Monetag Zone ID
                const monetagInterstitialId = document.getElementById('monetag-interstitialid').value.trim();
                const monetagEnabled = document.getElementById('monetag-enabled').checked;
                
                if (monetagEnabled && !monetagInterstitialId) {
                    showAlert("Please enter Monetag Interstitial Zone ID when Monetag is enabled.");
                    return;
                }
                
                const adNetworkConfig = {
                    richadsPubId: document.getElementById('richads-pubid').value.trim(),
                    richadsAppId: document.getElementById('richads-appid').value.trim(),
                    taddyPublicId: document.getElementById('taddy-publicid').value.trim(),
                    taddyEnabled: document.getElementById('taddy-enabled').checked,
                    // FIXED: Save Monetag settings correctly
                    monetagInterstitialId: monetagInterstitialId,
                    monetagEnabled: monetagEnabled,
                    // Note: Monetag doesn't use API key for interstitial ads
                    monetagApiKey: "", // Keep empty as Monetag doesn't need API key for interstitial
                    adsgramRewardId: document.getElementById('adsgram-rewardid').value.trim(),
                    adsgramInterstitialId: document.getElementById('adsgram-interstitialid').value.trim(),
                    updatedAt: serverTimestamp()
                };
                
                // Save to Firebase
                await setDoc(doc(db, "config", "adnetwork"), adNetworkConfig);
                
                showToast("✅ Ad network settings saved successfully!");
                
            } catch (error) {
                console.error("Error saving ad network config:", error);
                showAlert("❌ Error saving ad network settings: " + error.message, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        // Withdrawals Functions
        async function loadWithdrawals() {
            const page = document.getElementById('withdrawals');
            page.innerHTML = `
                <h1 class="text-3xl font-bold mb-6 text-gray-800">Withdrawal Requests</h1>
                <div class="mb-4 flex space-x-4">
                    <button onclick="filterWithdrawals('all')" class="btn btn-primary">All</button>
                    <button onclick="filterWithdrawals('pending')" class="btn btn-warning">Pending</button>
                    <button onclick="filterWithdrawals('approved')" class="btn btn-success">Approved</button>
                    <button onclick="filterWithdrawals('rejected')" class="btn btn-danger">Rejected</button>
                </div>
                <div class="bg-white shadow rounded-lg p-4">
                    <div class="overflow-x-auto">
                        <div id="withdrawals-table-container">Loading...</div>
                    </div>
                </div>
            `;
            
            await loadWithdrawalsData('all');
        }

        async function loadWithdrawalsData(filter = 'all') {
            let q;
            if (filter === 'all') {
                q = query(collection(db, "withdrawals"), orderBy("requestedAt", "desc"));
            } else {
                q = query(collection(db, "withdrawals"), where("status", "==", filter), orderBy("requestedAt", "desc"));
            }
            
            const withdrawalsSnap = await getDocs(q);
            
            if (withdrawalsSnap.empty) {
                document.getElementById('withdrawals-table-container').innerHTML = 
                    `<p class="text-center p-4 text-gray-500">No withdrawal requests found.</p>`;
                return;
            }

            let tableHTML = `<table class="w-full text-sm text-left">
                <thead class="text-xs uppercase bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-gray-700">User</th>
                        <th class="px-6 py-3 text-gray-700">Amount</th>
                        <th class="px-6 py-3 text-gray-700">Method</th>
                        <th class="px-6 py-3 text-gray-700">Details</th>
                        <th class="px-6 py-3 text-gray-700">Country</th>
                        <th class="px-6 py-3 text-gray-700">Requested At</th>
                        <th class="px-6 py-3 text-gray-700">Status</th>
                        <th class="px-6 py-3 text-gray-700">Actions</th>
                    </tr>
                </thead>
                <tbody>`;
            
            withdrawalsSnap.forEach(doc => {
                const req = doc.data();
                const requestedDate = req.requestedAt?.toDate().toLocaleString() || 'N/A';
                const statusClass = req.status === 'approved' ? 'status-approved' : 
                                  req.status === 'pending' ? 'status-pending' : 'status-rejected';
                const country = req.country || 'N/A';
                
                tableHTML += `<tr class="bg-white border-b">
                    <td class="px-6 py-4">
                        <div class="flex items-center space-x-2">
                            <span class="text-gray-700">${req.userName || 'N/A'}</span>
                            <button onclick="viewUserPointHistory('${req.userId}', '${req.userName}')" 
                                    class="view-points-btn btn-sm">View Points</button>
                        </div>
                    </td>
                    <td class="px-6 py-4 font-semibold text-gray-700">${req.amount}</td>
                    <td class="px-6 py-4 text-gray-700">${req.method}</td>
                    <td class="px-6 py-4 truncate max-w-xs text-gray-700" title="${req.paymentDetail}">${req.paymentDetail || 'N/A'}</td>
                    <td class="px-6 py-4 text-gray-700">${country}</td>
                    <td class="px-6 py-4 text-gray-500 text-sm">${requestedDate}</td>
                    <td class="px-6 py-4"><span class="status-badge ${statusClass}">${req.status}</span></td>
                    <td class="px-6 py-4">
                        ${req.status === 'pending' ? `
                        <div class="flex space-x-2">
                            <button onclick="processWithdrawal('${doc.id}', 'approved')" class="btn-success text-xs px-2 py-1 rounded">Approve</button>
                            <button onclick="processWithdrawal('${doc.id}', 'rejected')" class="btn-danger text-xs px-2 py-1 rounded">Reject</button>
                        </div>
                        ` : '—'}
                    </td>
                </tr>`;
            });
            
            tableHTML += `</tbody></table>`;
            document.getElementById('withdrawals-table-container').innerHTML = tableHTML;
        }

        function filterWithdrawals(status) {
            loadWithdrawalsData(status);
        }

        // Notifications Functions
        function loadNotifications() {
            const page = document.getElementById('notifications');
            page.innerHTML = `
                <h1 class="text-3xl font-bold mb-6 text-gray-800">Send Notification</h1>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="stat-card p-6">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">Send to All Users</h2>
                        <div class="mb-4">
                            <label for="notification-title" class="block font-semibold mb-2 text-gray-700">Title</label>
                            <input type="text" id="notification-title" class="input-field" placeholder="Notification title">
                        </div>
                        <div class="mb-6">
                            <label for="notification-message" class="block font-semibold mb-2 text-gray-700">Message</label>
                            <textarea id="notification-message" rows="4" class="input-field" placeholder="Notification message"></textarea>
                        </div>
                        <button id="send-notification-btn" class="btn btn-primary w-full">Send to All Users</button>
                    </div>
                    
                    <div class="stat-card p-6">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">Telegram Bot Configuration</h2>
                        <div class="mb-4">
                            <label for="telegram-bot-token" class="block font-semibold mb-2 text-gray-700">Bot Token</label>
                            <input type="text" id="telegram-bot-token" class="input-field" placeholder="Enter bot token">
                        </div>
                        <div class="mb-6">
                            <label for="telegram-chat-id" class="block font-semibold mb-2 text-gray-700">Chat ID</label>
                            <input type="text" id="telegram-chat-id" class="input-field" placeholder="Enter chat ID">
                        </div>
                        <button onclick="testTelegramConnection()" class="btn btn-warning w-full mb-2">Test Connection</button>
                        <button onclick="saveTelegramConfig()" class="btn btn-success w-full">Save Configuration</button>
                    </div>
                </div>
                
                <div class="mt-8">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Notification History</h2>
                    <div id="notification-history" class="bg-white shadow rounded-lg p-4">
                        Loading...
                    </div>
                </div>
            `;
            
            document.getElementById('send-notification-btn').addEventListener('click', sendNotification);
            loadNotificationHistory();
            loadTelegramConfig();
        }

        async function sendNotification() {
            const title = document.getElementById('notification-title').value;
            const message = document.getElementById('notification-message').value;
            
            if (!title || !message) {
                showAlert("Please enter both title and message.");
                return;
            }
            
            loader.style.display = 'flex';
            try {
                // Save to Firebase
                await addDoc(collection(db, "notifications"), {
                    title,
                    message,
                    createdAt: serverTimestamp(),
                    sentToAll: true
                });
                
                // Send to Telegram if configured
                await sendTelegramNotification(title, message);
                
                showToast("✅ Notification sent successfully!");
                document.getElementById('notification-title').value = '';
                document.getElementById('notification-message').value = '';
                loadNotificationHistory();
            } catch (error) {
                console.error("Error sending notification:", error);
                showAlert("❌ Error sending notification: " + error.message, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        async function sendTelegramNotification(title, message) {
            const configSnap = await getDoc(doc(db, "config", "telegram"));
            if (!configSnap.exists()) return;
            
            const config = configSnap.data();
            if (!config.botToken || !config.chatId) return;
            
            const telegramMessage = `*${title}*\n\n${message}`;
            
            try {
                const response = await fetch(`https://api.telegram.org/bot${config.botToken}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: config.chatId,
                        text: telegramMessage,
                        parse_mode: 'Markdown'
                    })
                });
                
                const result = await response.json();
                if (!result.ok) {
                    console.error("Telegram API error:", result);
                    throw new Error(result.description || 'Telegram API error');
                }
            } catch (error) {
                console.error("Error sending to Telegram:", error);
                throw error;
            }
        }

        async function loadNotificationHistory() {
            const notificationsSnap = await getDocs(query(
                collection(db, "notifications"), 
                orderBy("createdAt", "desc"), 
                limit(10)
            ));
            
            let html = `<table class="w-full">
                <thead><tr>
                    <th class="text-gray-700">Title</th>
                    <th class="text-gray-700">Message</th>
                    <th class="text-gray-700">Sent At</th>
                </tr></thead>
                <tbody>`;
            
            if (notificationsSnap.empty) {
                html += `<tr><td colspan="3" class="text-center py-4 text-gray-500">No notifications sent yet</td></tr>`;
            } else {
                notificationsSnap.forEach(doc => {
                    const notification = doc.data();
                    const sentAt = notification.createdAt?.toDate().toLocaleString() || 'N/A';
                    html += `<tr class="border-b">
                        <td class="py-2 font-semibold text-gray-700">${notification.title}</td>
                        <td class="py-2 text-gray-700">${notification.message}</td>
                        <td class="py-2 text-gray-500 text-sm">${sentAt}</td>
                    </tr>`;
                });
            }
            
            html += `</tbody></table>`;
            document.getElementById('notification-history').innerHTML = html;
        }

        async function loadTelegramConfig() {
            const configSnap = await getDoc(doc(db, "config", "telegram"));
            if (configSnap.exists()) {
                const config = configSnap.data();
                document.getElementById('telegram-bot-token').value = config.botToken || '';
                document.getElementById('telegram-chat-id').value = config.chatId || '';
            }
        }

        async function saveTelegramConfig() {
            const botToken = document.getElementById('telegram-bot-token').value;
            const chatId = document.getElementById('telegram-chat-id').value;
            
            if (!botToken || !chatId) {
                showAlert("Please enter both Bot Token and Chat ID.");
                return;
            }
            
            loader.style.display = 'flex';
            try {
                await setDoc(doc(db, "config", "telegram"), {
                    botToken,
                    chatId,
                    updatedAt: serverTimestamp()
                });
                showToast("✅ Telegram configuration saved successfully!");
            } catch (error) {
                console.error("Error saving Telegram config:", error);
                showAlert("❌ Error saving configuration: " + error.message, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        async function testTelegramConnection() {
            const botToken = document.getElementById('telegram-bot-token').value;
            const chatId = document.getElementById('telegram-chat-id').value;
            
            if (!botToken || !chatId) {
                showAlert("Please enter both Bot Token and Chat ID to test.");
                return;
            }
            
            loader.style.display = 'flex';
            try {
                // Test bot token
                const botResponse = await fetch(`https://api.telegram.org/bot${botToken}/getMe`);
                const botResult = await botResponse.json();
                
                if (!botResult.ok) {
                    showAlert("❌ Bot connection failed: " + botResult.description, true);
                    return;
                }
                
                // Test sending message
                const messageResponse = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: "✅ Test message from CashReward Admin Panel",
                        parse_mode: 'Markdown'
                    })
                });
                
                const messageResult = await messageResponse.json();
                if (messageResult.ok) {
                    showAlert("✅ Telegram connection successful! Test message sent.");
                } else {
                    showAlert("❌ Failed to send test message: " + messageResult.description, true);
                }
            } catch (error) {
                showAlert("❌ Error testing connection: " + error.message, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        // Settings Functions
        async function loadSettings() {
            const page = document.getElementById('settings');
            page.innerHTML = `
                <h1 class="text-3xl font-bold mb-6 text-gray-800">App Settings</h1>
                <div class="space-y-8">
                    <!-- Payment Settings -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">Payment & Withdrawal Settings</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="font-semibold text-gray-700">Min Withdrawal (Points)</label>
                                <input type="number" id="minWithdrawal" class="input-field" placeholder="e.g., 1000">
                                <p class="text-sm text-gray-500 mt-1">Minimum points required for withdrawal</p>
                            </div>
                            <div>
                                <label class="font-semibold text-gray-700">Conversion Rate</label>
                                <div class="flex items-center space-x-2">
                                    <input type="number" id="conversionRatePoints" class="input-field" placeholder="1000">
                                    <span class="text-gray-500">points =</span>
                                    <input type="number" id="conversionRateTaka" class="input-field" placeholder="10">
                                    <span class="text-gray-500">Taka</span>
                                </div>
                                <p class="text-sm text-gray-500 mt-1">Example: 1000 points = 10 Taka</p>
                            </div>
                            <div>
                                <label class="font-semibold text-gray-700">Daily Ad Watch Limit</label>
                                <input type="number" id="dailyAdLimit" class="input-field" value="100">
                                <p class="text-sm text-gray-500 mt-1">Maximum ads a user can watch per day</p>
                            </div>
                            <div>
                                <label class="font-semibold text-gray-700">Ad Watch Reward (Points)</label>
                                <input type="number" id="adWatchReward" class="input-field" placeholder="e.g., 10">
                            </div>
                            <div>
                                <label class="font-semibold text-gray-700">Payment Methods (comma separated)</label>
                                <input type="text" id="paymentMethods" class="input-field" placeholder="Bkash, Nagad, Rocket">
                                <p class="text-sm text-gray-500 mt-1">Enter payment methods separated by commas</p>
                            </div>
                            <div class="col-span-2">
                                <div class="feature-toggle">
                                    <div>
                                        <label class="feature-label text-gray-700">Payment Method Verification</label>
                                        <p class="text-sm text-gray-500">Enable/disable payment method verification</p>
                                    </div>
                                    <label class="switch">
                                        <input type="checkbox" id="paymentVerification">
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                                <p class="text-sm text-gray-500 mt-2">
                                    <strong>Note:</strong> When verification is disabled, withdrawals are automatically approved if user has enough points.
                                    When enabled, admin must manually verify each withdrawal request.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Game Rewards -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">Game Rewards</h2>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="font-semibold text-gray-700">Color Game Reward</label>
                                <input type="number" id="colorGameReward" class="input-field" placeholder="e.g., 10">
                            </div>
                            <div>
                                <label class="font-semibold text-gray-700">Ludo Dice Reward</label>
                                <input type="number" id="ludoDiceReward" class="input-field" placeholder="e.g., 5">
                            </div>
                            <div>
                                <label class="font-semibold text-gray-700">Watch Video Reward</label>
                                <input type="number" id="watchVideoReward" class="input-field" placeholder="e.g., 15">
                            </div>
                            <div>
                                <label class="font-semibold text-gray-700">Try Your Luck Reward</label>
                                <input type="number" id="tryYourLuckReward" class="input-field" placeholder="e.g., 50">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Special Task System -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">Special Task System</h2>
                        
                        <!-- Watch Video Special Task -->
                        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                            <h3 class="font-bold text-lg mb-3 text-blue-800">Watch Video Special Task</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="font-semibold text-gray-700">Show after # Videos</label>
                                    <input type="number" id="watchAdSpecialTaskCount" class="input-field" placeholder="e.g., 10">
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-700">Task Reward (Points)</label>
                                    <input type="number" id="watchAdSpecialTaskReward" class="input-field" placeholder="e.g., 100">
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-700">Wait Timer (Seconds)</label>
                                    <input type="number" id="watchAdSpecialTaskTimer" class="input-field" placeholder="e.g., 60">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Color Game Special Task -->
                        <div class="mb-6 p-4 bg-purple-50 rounded-lg">
                            <h3 class="font-bold text-lg mb-3 text-purple-800">Color Game Special Task</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="font-semibold text-gray-700">Show after # Plays</label>
                                    <input type="number" id="colorGameSpecialTaskCount" class="input-field" placeholder="e.g., 20">
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-700">Task Reward (Points)</label>
                                    <input type="number" id="colorGameSpecialTaskReward" class="input-field" placeholder="e.g., 200">
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-700">Wait Timer (Seconds)</label>
                                    <input type="number" id="colorGameSpecialTaskTimer" class="input-field" placeholder="e.g., 45">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ludo Dice Special Task -->
                        <div class="mb-6 p-4 bg-green-50 rounded-lg">
                            <h3 class="font-bold text-lg mb-3 text-green-800">Ludo Dice Special Task</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="font-semibold text-gray-700">Show after # Plays</label>
                                    <input type="number" id="ludoDiceSpecialTaskCount" class="input-field" placeholder="e.g., 30">
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-700">Task Reward (Points)</label>
                                    <input type="number" id="ludoDiceSpecialTaskReward" class="input-field" placeholder="e.g., 150">
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-700">Wait Timer (Seconds)</label>
                                    <input type="number" id="ludoDiceSpecialTaskTimer" class="input-field" placeholder="e.g., 30">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">IP Geolocation & Country Restrictions</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="font-semibold text-gray-700">IPinfo API Token</label>
                                <input type="text" id="ipinfoApiToken" class="input-field" placeholder="Enter IPinfo API token">
                                <p class="text-sm text-gray-500 mt-1">
                                    Leave blank to disable country detection.
                                </p>
                            </div>
                            <div>
                                <label class="font-semibold text-gray-700">Allowed Countries (comma separated)</label>
                                <input type="text" id="allowedCountries" class="input-field" placeholder="bd, in, pk, us, uk">
                                <p class="text-sm text-gray-500 mt-1">Enter country codes separated by commas</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Website Visit Management -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Website Visit Management</h2>
                            <button onclick="resetWebsiteVisitHistory()" class="btn btn-danger">Reset All History</button>
                        </div>
                        
                        <div class="mb-4 p-4 bg-yellow-50 rounded-lg">
                            <p class="text-yellow-700 text-sm">
                                <strong>Important:</strong> Make sure website URLs are properly formatted with https:// prefix. 
                                The mini-app will use these URLs directly for web visit tasks.
                            </p>
                        </div>
                        
                        <div id="websites-to-visit-list" class="space-y-3 mb-4">
                            <!-- Websites will be loaded here -->
                        </div>
                        
                        <button onclick="addNewWebsite()" class="btn btn-primary mb-4">+ Add New Website</button>
                        <button onclick="saveWebsiteConfig()" class="btn btn-success ml-2">Save Websites</button>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">Referral System</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="font-semibold text-gray-700">Referral Bonus (Points)</label>
                                <input type="number" id="referralBonus" class="input-field" placeholder="e.g., 100">
                            </div>
                            <div>
                                <label class="font-semibold text-gray-700">Referrer Bonus (Points)</label>
                                <input type="number" id="referrerBonus" class="input-field" placeholder="e.g., 50">
                                <p class="text-sm text-gray-500 mt-1">Bonus for the user who refers someone</p>
                            </div>
                            <div class="col-span-2">
                                <label class="font-semibold text-gray-700">Referral Share Text</label>
                                <textarea id="referralShareText" class="input-field h-24" placeholder="Use my code {CODE} to get {BONUS} points bonus! App link: {APP_LINK}"></textarea>
                                <p class="text-sm text-gray-500 mt-1">Use {CODE} for referral code, {BONUS} for bonus points, {APP_LINK} for app link</p>
                            </div>
                        </div>
                    </div>
                </div>
                <button onclick="saveAllSettings()" class="btn btn-primary mt-8 px-8 py-3 text-lg">
                    <i data-lucide="save" class="w-5 h-5 mr-2"></i> Save All Settings
                </button>
            `;
            
            // Load existing settings
            await loadSettingsData();
            await loadWebsitesConfig();
        }

        async function loadSettingsData() {
            try {
                const configSnap = await getDoc(doc(db, "config", "main"));
                
                if (!configSnap.exists()) {
                    console.log("No settings found, using defaults");
                    return;
                }
                
                const config = configSnap.data();
                
                // Payment Settings
                if (config.minWithdrawal !== undefined) {
                    document.getElementById('minWithdrawal').value = config.minWithdrawal;
                }
                
                if (config.conversionRatePoints !== undefined) {
                    document.getElementById('conversionRatePoints').value = config.conversionRatePoints;
                }
                
                if (config.conversionRateTaka !== undefined) {
                    document.getElementById('conversionRateTaka').value = config.conversionRateTaka;
                }
                
                if (config.dailyAdLimit !== undefined) {
                    document.getElementById('dailyAdLimit').value = config.dailyAdLimit;
                }
                
                if (config.adWatchReward !== undefined) {
                    document.getElementById('adWatchReward').value = config.adWatchReward;
                }
                
                if (config.colorGameReward !== undefined) {
                    document.getElementById('colorGameReward').value = config.colorGameReward;
                }
                
                if (config.ludoDiceReward !== undefined) {
                    document.getElementById('ludoDiceReward').value = config.ludoDiceReward;
                }
                
                if (config.watchVideoReward !== undefined) {
                    document.getElementById('watchVideoReward').value = config.watchVideoReward;
                }
                
                if (config.tryYourLuckReward !== undefined) {
                    document.getElementById('tryYourLuckReward').value = config.tryYourLuckReward;
                }
                
                if (config.paymentMethods && Array.isArray(config.paymentMethods)) {
                    document.getElementById('paymentMethods').value = config.paymentMethods.join(', ');
                }
                
                if (config.paymentVerification !== undefined) {
                    document.getElementById('paymentVerification').checked = config.paymentVerification;
                }
                
                // Referral Settings
                if (config.referralBonus !== undefined) {
                    document.getElementById('referralBonus').value = config.referralBonus;
                }
                
                if (config.referrerBonus !== undefined) {
                    document.getElementById('referrerBonus').value = config.referrerBonus;
                }
                
                if (config.referralShareText) {
                    document.getElementById('referralShareText').value = config.referralShareText;
                }
                
                // Special Task Settings
                if (config.watchAdSpecialTaskCount !== undefined) {
                    document.getElementById('watchAdSpecialTaskCount').value = config.watchAdSpecialTaskCount;
                }
                
                if (config.watchAdSpecialTaskReward !== undefined) {
                    document.getElementById('watchAdSpecialTaskReward').value = config.watchAdSpecialTaskReward;
                }
                
                if (config.watchAdSpecialTaskTimer !== undefined) {
                    document.getElementById('watchAdSpecialTaskTimer').value = config.watchAdSpecialTaskTimer;
                }
                
                if (config.colorGameSpecialTaskCount !== undefined) {
                    document.getElementById('colorGameSpecialTaskCount').value = config.colorGameSpecialTaskCount;
                }
                
                if (config.colorGameSpecialTaskReward !== undefined) {
                    document.getElementById('colorGameSpecialTaskReward').value = config.colorGameSpecialTaskReward;
                }
                
                if (config.colorGameSpecialTaskTimer !== undefined) {
                    document.getElementById('colorGameSpecialTaskTimer').value = config.colorGameSpecialTaskTimer;
                }
                
                if (config.ludoDiceSpecialTaskCount !== undefined) {
                    document.getElementById('ludoDiceSpecialTaskCount').value = config.ludoDiceSpecialTaskCount;
                }
                
                if (config.ludoDiceSpecialTaskReward !== undefined) {
                    document.getElementById('ludoDiceSpecialTaskReward').value = config.ludoDiceSpecialTaskReward;
                }
                
                if (config.ludoDiceSpecialTaskTimer !== undefined) {
                    document.getElementById('ludoDiceSpecialTaskTimer').value = config.ludoDiceSpecialTaskTimer;
                }
                
                // IP Info Settings
                if (config.ipinfoApiToken) {
                    document.getElementById('ipinfoApiToken').value = config.ipinfoApiToken;
                }
                
                if (config.allowedCountries && Array.isArray(config.allowedCountries)) {
                    document.getElementById('allowedCountries').value = config.allowedCountries.join(', ');
                }
                
            } catch (error) {
                console.error("Error loading settings:", error);
                showAlert("❌ Error loading settings", true);
            }
        }

        async function saveAllSettings() {
            loader.style.display = 'flex';
            
            try {
                // Collect all settings from form
                const settings = {
                    // Payment Settings
                    minWithdrawal: parseInt(document.getElementById('minWithdrawal').value) || 1000,
                    conversionRatePoints: parseInt(document.getElementById('conversionRatePoints').value) || 1000,
                    conversionRateTaka: parseInt(document.getElementById('conversionRateTaka').value) || 10,
                    dailyAdLimit: parseInt(document.getElementById('dailyAdLimit').value) || 100,
                    adWatchReward: parseInt(document.getElementById('adWatchReward').value) || 10,
                    colorGameReward: parseInt(document.getElementById('colorGameReward').value) || 10,
                    ludoDiceReward: parseInt(document.getElementById('ludoDiceReward').value) || 5,
                    watchVideoReward: parseInt(document.getElementById('watchVideoReward').value) || 15,
                    tryYourLuckReward: parseInt(document.getElementById('tryYourLuckReward').value) || 50,
                    paymentMethods: document.getElementById('paymentMethods').value.split(',').map(s => s.trim()).filter(Boolean),
                    paymentVerification: document.getElementById('paymentVerification').checked,
                    
                    // Referral Settings
                    referralBonus: parseInt(document.getElementById('referralBonus').value) || 100,
                    referrerBonus: parseInt(document.getElementById('referrerBonus').value) || 50,
                    referralShareText: document.getElementById('referralShareText').value.trim() || "Use my code {CODE} to get {BONUS} points bonus! App link: {APP_LINK}",
                    
                    // Special Task Settings
                    watchAdSpecialTaskCount: parseInt(document.getElementById('watchAdSpecialTaskCount').value) || 10,
                    watchAdSpecialTaskReward: parseInt(document.getElementById('watchAdSpecialTaskReward').value) || 100,
                    watchAdSpecialTaskTimer: parseInt(document.getElementById('watchAdSpecialTaskTimer').value) || 60,
                    
                    colorGameSpecialTaskCount: parseInt(document.getElementById('colorGameSpecialTaskCount').value) || 20,
                    colorGameSpecialTaskReward: parseInt(document.getElementById('colorGameSpecialTaskReward').value) || 200,
                    colorGameSpecialTaskTimer: parseInt(document.getElementById('colorGameSpecialTaskTimer').value) || 45,
                    
                    ludoDiceSpecialTaskCount: parseInt(document.getElementById('ludoDiceSpecialTaskCount').value) || 30,
                    ludoDiceSpecialTaskReward: parseInt(document.getElementById('ludoDiceSpecialTaskReward').value) || 150,
                    ludoDiceSpecialTaskTimer: parseInt(document.getElementById('ludoDiceSpecialTaskTimer').value) || 30,
                    
                    // IP Info Settings
                    ipinfoApiToken: document.getElementById('ipinfoApiToken').value.trim(),
                    allowedCountries: document.getElementById('allowedCountries').value.split(',').map(s => s.trim().toLowerCase()).filter(Boolean),
                    
                    updatedAt: serverTimestamp()
                };
                
                // Save to Firebase
                await setDoc(doc(db, "config", "main"), settings);
                
                showToast("✅ All settings saved successfully!");
                loadUsers(); // Refresh users to show updated daily ad limit
                
            } catch (error) {
                console.error("Error saving settings:", error);
                showAlert("❌ Error saving settings: " + error.message, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        // Website Visit Management Functions
        async function loadWebsitesConfig() {
            try {
                const configSnap = await getDoc(doc(db, "config", "main"));
                const config = configSnap.data() || {};
                const websites = config.websitesToVisit || [];
                
                const container = document.getElementById('websites-to-visit-list');
                container.innerHTML = '';
                
                if (websites.length === 0) {
                    // Add default websites
                    const defaultWebsites = [
                        { name: "Google", link: "https://www.google.com", reward: 10, timer: 30 },
                        { name: "YouTube", link: "https://www.youtube.com", reward: 15, timer: 45 },
                        { name: "Facebook", link: "https://www.facebook.com", reward: 20, timer: 60 }
                    ];
                    
                    defaultWebsites.forEach((site, index) => {
                        container.innerHTML += `
                            <div class="website-item">
                                <div class="website-field">
                                    <input type="text" placeholder="Website Name" value="${site.name}" data-field="name" class="text-gray-800">
                                </div>
                                <div class="website-field">
                                    <input type="url" placeholder="https://example.com" value="${site.link}" data-field="link" class="text-gray-800" required>
                                </div>
                                <div class="website-field">
                                    <input type="number" placeholder="Reward" value="${site.reward}" data-field="reward" class="text-gray-800" min="1">
                                </div>
                                <div class="website-field">
                                    <input type="number" placeholder="Timer (sec)" value="${site.timer}" data-field="timer" class="text-gray-800" min="10">
                                </div>
                                <button onclick="removeWebsite(this)" class="btn btn-danger">×</button>
                            </div>
                        `;
                    });
                } else {
                    websites.forEach((site, index) => {
                        container.innerHTML += `
                            <div class="website-item">
                                <div class="website-field">
                                    <input type="text" placeholder="Website Name" value="${site.name}" data-field="name" class="text-gray-800">
                                </div>
                                <div class="website-field">
                                    <input type="url" placeholder="https://example.com" value="${site.link}" data-field="link" class="text-gray-800" required>
                                </div>
                                <div class="website-field">
                                    <input type="number" placeholder="Reward" value="${site.reward}" data-field="reward" class="text-gray-800" min="1">
                                </div>
                                <div class="website-field">
                                    <input type="number" placeholder="Timer (sec)" value="${site.timer}" data-field="timer" class="text-gray-800" min="10">
                                </div>
                                <button onclick="removeWebsite(this)" class="btn btn-danger">×</button>
                            </div>
                        `;
                    });
                }
            } catch (error) {
                console.error("Error loading website config:", error);
                showAlert("❌ Error loading website configurations: " + error.message, true);
            }
        }

        function addNewWebsite() {
            const container = document.getElementById('websites-to-visit-list');
            container.innerHTML += `
                <div class="website-item">
                    <div class="website-field">
                        <input type="text" placeholder="Website Name" value="" data-field="name" class="text-gray-800" required>
                    </div>
                    <div class="website-field">
                        <input type="url" placeholder="https://example.com" value="" data-field="link" class="text-gray-800" required>
                    </div>
                    <div class="website-field">
                        <input type="number" placeholder="Reward" value="10" data-field="reward" class="text-gray-800" min="1">
                    </div>
                    <div class="website-field">
                        <input type="number" placeholder="Timer (sec)" value="30" data-field="timer" class="text-gray-800" min="10">
                    </div>
                    <button onclick="removeWebsite(this)" class="btn btn-danger">×</button>
                </div>
            `;
        }

        function removeWebsite(button) {
            const item = button.closest('.website-item');
            if (item) {
                item.remove();
            }
        }

        async function saveWebsiteConfig() {
            loader.style.display = 'flex';
            try {
                // Get website configurations from the UI
                const websites = [];
                const websiteItems = document.querySelectorAll('#websites-to-visit-list .website-item');
                
                let hasErrors = false;
                
                websiteItems.forEach(item => {
                    const name = item.querySelector('[data-field="name"]').value.trim();
                    const link = item.querySelector('[data-field="link"]').value.trim();
                    const reward = parseInt(item.querySelector('[data-field="reward"]').value) || 10;
                    const timer = parseInt(item.querySelector('[data-field="timer"]').value) || 30;
                    
                    if (!name || !link) {
                        hasErrors = true;
                        item.style.border = '2px solid #ef4444';
                        return;
                    }
                    
                    item.style.border = '';
                    
                    websites.push({
                        name: name,
                        link: link,
                        reward: reward,
                        timer: timer
                    });
                });
                
                if (hasErrors) {
                    showAlert("❌ Please check all website entries. Make sure name and URL are provided.");
                    return;
                }
                
                if (websites.length === 0) {
                    showAlert("❌ Please add at least one website.");
                    return;
                }
                
                // Save to Firebase
                const configRef = doc(db, "config", "main");
                await updateDoc(configRef, {
                    websitesToVisit: websites,
                    updatedAt: serverTimestamp()
                });
                
                showToast('✅ Website configurations saved successfully!');
                
            } catch (error) {
                console.error("Error saving website config:", error);
                showAlert('❌ Error saving website configurations: ' + error.message, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        async function resetWebsiteVisitHistory() {
            showConfirm("Are you sure you want to reset website visit history for ALL users? This will allow all users to visit websites again for rewards.", async () => {
                loader.style.display = 'flex';
                try {
                    // Get all users
                    const usersSnap = await getDocs(collection(db, "users"));
                    const batch = writeBatch(db);
                    
                    // Reset visitedWebsitesToday for each user
                    usersSnap.forEach((userDoc) => {
                        const userRef = doc(db, "users", userDoc.id);
                        batch.update(userRef, { 
                            visitedWebsitesToday: [],
                            lastWebsiteVisitDate: '1970-01-01'
                        });
                    });
                    
                    await batch.commit();
                    showToast("✅ Website visit history reset successfully for all users!");
                } catch (error) {
                    console.error("Error resetting website history:", error);
                    showAlert("❌ Error resetting website history: " + error.message, true);
                } finally {
                    loader.style.display = 'none';
                }
            });
        }

        // User Point History Functions
        async function viewUserPointHistory(userId, userName) {
            currentViewingUserId = userId;
            document.getElementById('history-user-name').textContent = userName;
            document.getElementById('history-user-id').textContent = userId;
            
            loader.style.display = 'flex';
            try {
                // Get current user balance
                const userSnap = await getDoc(doc(db, "users", userId));
                const userData = userSnap.exists() ? userSnap.data() : {};
                document.getElementById('current-user-balance').textContent = userData.balance || 0;
                
                // Get point history
                const historySnap = await getDocs(query(
                    collection(db, "pointHistory"),
                    where("userId", "==", userId),
                    orderBy("timestamp", "desc")
                ));
                
                let totalPointsEarned = 0;
                let totalPointsSpent = 0;
                let html = '';
                
                if (historySnap.empty) {
                    html = `<tr><td colspan="5" class="text-center py-4 text-gray-500">No point history found for this user</td></tr>`;
                } else {
                    historySnap.forEach(doc => {
                        const history = doc.data();
                        const points = history.points || 0;
                        
                        // Calculate totals
                        if (points > 0) {
                            totalPointsEarned += points;
                        } else {
                            totalPointsSpent += Math.abs(points);
                        }
                        
                        const taskLabels = {
                            'ad_watch': 'Ad Watch',
                            'color_game': 'Color Game',
                            'website_visit': 'Website Visit',
                            'referral': 'Referral Bonus',
                            'withdrawal': 'Withdrawal',
                            'admin_adjustment': 'Admin Adjustment',
                            'game_play': 'Game Play',
                            'special_task': 'Special Task',
                            'try_your_luck': 'Try Your Luck',
                            'ludo_dice': 'Ludo Dice'
                        };
                        
                        const timestamp = history.timestamp?.toDate().toLocaleString() || 'N/A';
                        const pointsClass = points > 0 ? 'text-green-600' : 'text-red-600';
                        const pointsSign = points > 0 ? '+' : '';
                        const country = history.country || 'N/A';
                        const taskName = taskLabels[history.taskType] || history.taskType || 'Unknown';
                        
                        html += `<tr class="border-b">
                            <td class="px-4 py-2 text-sm text-gray-700">${timestamp}</td>
                            <td class="px-4 py-2 text-gray-700">${taskName}</td>
                            <td class="px-4 py-2 font-semibold ${pointsClass}">${pointsSign}${points}</td>
                            <td class="px-4 py-2 text-gray-700">${country}</td>
                            <td class="px-4 py-2 text-gray-600">${history.details || ''}</td>
                        </tr>`;
                    });
                }
                
                document.getElementById('total-points-earned').textContent = totalPointsEarned;
                document.getElementById('total-points-spent').textContent = totalPointsSpent;
                document.getElementById('user-point-history-body').innerHTML = html;
                document.getElementById('user-point-history-modal').style.display = 'flex';
            } catch (error) {
                console.error("Error loading point history:", error);
                showAlert("❌ Error loading point history: " + error.message, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        function closePointHistoryModal() {
            document.getElementById('user-point-history-modal').style.display = 'none';
            currentViewingUserId = null;
        }

        // Utility Functions
        function showAlert(message, isError = false) {
            const alertBox = document.getElementById('custom-alert');
            const msgEl = document.getElementById('alert-message');
            if (alertBox && msgEl) {
                msgEl.textContent = message;
                alertBox.classList.remove('hidden');
            }
        }

        function showConfirm(message, onConfirm) {
            document.getElementById('confirm-message').textContent = message;
            const confirmModal = document.getElementById('custom-confirm');
            confirmModal.classList.remove('hidden');
            
            // Create new buttons to avoid duplicate listeners
            const oldOkBtn = document.getElementById('confirm-ok-btn');
            const oldCancelBtn = document.getElementById('confirm-cancel-btn');
            
            const newOkBtn = oldOkBtn.cloneNode(true);
            const newCancelBtn = oldCancelBtn.cloneNode(true);
            
            oldOkBtn.parentNode.replaceChild(newOkBtn, oldOkBtn);
            oldCancelBtn.parentNode.replaceChild(newCancelBtn, oldCancelBtn);
            
            newOkBtn.addEventListener('click', () => {
                confirmModal.classList.add('hidden');
                onConfirm();
            });
            
            newCancelBtn.addEventListener('click', () => {
                confirmModal.classList.add('hidden');
            });
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            
            if (!toast || !toastMessage) return;

            toastMessage.textContent = message;
            toast.className = `fixed top-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 z-50 ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.remove('opacity-0'), 50);

            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 500);
            }, 3000);
        }

        // Make functions available globally
        window.toggleActive = toggleActive;
        window.editUserPoints = editUserPoints;
        window.saveUserPoints = saveUserPoints;
        window.closeEditPointsModal = closeEditPointsModal;
        window.viewUserDetails = viewUserDetails;
        window.closeUserDetailsModal = closeUserDetailsModal;
        window.searchUsers = searchUsers;
        window.migrateExistingUsers = migrateExistingUsers;
        window.loadUsersForAdmin = loadUsersForAdmin;
        window.displayUsersInAdminPanel = displayUsersInAdminPanel;
        window.deleteUser = deleteUser;
        window.toggleUserSelection = toggleUserSelection;
        window.toggleSelectAllUsers = toggleSelectAllUsers;
        window.toggleTableSelectAll = toggleTableSelectAll;
        window.deleteSelectedUsers = deleteSelectedUsers;
        window.toggleSidebar = toggleSidebar;
        window.resetUserPlayLimits = resetUserPlayLimits;
        
        // Custom message functions
        window.openCustomMessageModal = openCustomMessageModal;
        window.openCustomMessageModalFromUsers = openCustomMessageModalFromUsers;
        window.closeCustomMessageModal = closeCustomMessageModal;
        window.searchUserByTelegramId = searchUserByTelegramId;
        window.sendCustomMessage = sendCustomMessage;
        window.sendDirectMessage = sendDirectMessage;
        window.sendCustomMessageToSelected = sendCustomMessageToSelected;
        window.toggleMessageType = toggleMessageType;
        window.toggleRecipientType = toggleRecipientType;
        window.viewMessageDetails = viewMessageDetails;
        
        // Original functions
        window.processWithdrawal = processWithdrawal;
        window.filterWithdrawals = filterWithdrawals;
        window.testTelegramConnection = testTelegramConnection;
        window.saveTelegramConfig = saveTelegramConfig;
        window.viewUserPointHistory = viewUserPointHistory;
        window.closePointHistoryModal = closePointHistoryModal;
        window.testIpinfoApi = testIpinfoApi;
        window.resetWebsiteVisitHistory = resetWebsiteVisitHistory;
        window.addNewWebsite = addNewWebsite;
        window.removeWebsite = removeWebsite;
        window.saveWebsiteConfig = saveWebsiteConfig;
        window.saveAllSettings = saveAllSettings;
        window.saveAdNetworkConfig = saveAdNetworkConfig;
        
        // Game Management functions
        window.openQuickSettings = openQuickSettings;
        window.closeQuickSettingsModal = closeQuickSettingsModal;
        window.saveQuickGameSettings = saveQuickGameSettings;
        window.applyGlobalPlayLimit = applyGlobalPlayLimit;
        window.applyGlobalReward = applyGlobalReward;
        window.showAllGames = showAllGames;
        window.hideAllGames = hideAllGames;
        window.syncAllGameSettings = syncAllGameSettings;
        window.resetAllGameStats = resetAllGameStats;
    </script>
</body>
</html>
