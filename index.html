<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CashReward Admin Panel - Game Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .admin-page { display: none; }
        .admin-page.active { display: block; animation: fadeIn 0.5s; }
        .sidebar-link { transition: all 0.2s; border-left: 3px solid transparent; }
        .sidebar-link.active, .sidebar-link:hover { background-color: #4f46e5; color: white; border-left-color: #818cf8; }
        .stat-card { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); }
        .input-field { border: 1px solid #cbd5e1; padding: 0.5rem 0.75rem; border-radius: 0.375rem; width: 100%; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: all 0.2s; cursor: pointer; }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background-color: #4f46e5; color: white; border: none; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #64748b; color: white; border: none; }
        .btn-danger { background-color: #ef4444; color: white; border: none; }
        .btn-success { background-color: #10b981; color: white; border: none; }
        .btn-warning { background-color: #f59e0b; color: white; border: none; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        #toast-notification { transition: opacity 0.5s ease-in-out; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background-color: #f9fafb; font-weight: 600; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .status-active { background-color: #d1fae5; color: #065f46; }
        .status-blocked { background-color: #fee2e2; color: #991b1b; }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-approved { background-color: #d1fae5; color: #065f46; }
        .status-rejected { background-color: #fee2e2; color: #991b1b; }
        .status-visible { background-color: #3b82f6; color: white; }
        .status-hidden { background-color: #6b7280; color: white; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal { background: white; border-radius: 0.5rem; max-width: 500px; margin: 2rem auto; padding: 1.5rem; max-height: 80vh; overflow-y: auto; }
        .point-input { width: 100px; text-align: center; }
        .view-points-btn { background-color: #3b82f6; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; }
        .game-card { background: white; border-radius: 0.5rem; padding: 1.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1); }
        .time-input { width: 120px; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(26px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }
        .website-item { display: flex; gap: 10px; margin-bottom: 10px; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb; }
        .website-field { flex: 1; }
        .website-field input { width: 100%; }
        .feature-toggle { display: flex; align-items: center; justify-content: space-between; margin: 1rem 0; }
        .feature-label { font-weight: 600; color: #374151; }
        .game-limits-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1.5rem 0; }
        .limit-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; }
        .limit-title { font-size: 0.875rem; font-weight: 600; color: #475569; margin-bottom: 0.5rem; }
        .limit-value { font-size: 1.25rem; font-weight: 700; color: #1e40af; }
        .game-action-buttons { display: flex; gap: 0.5rem; margin-top: 1rem; }
        .settings-section { margin-bottom: 2rem; }
        .settings-card { background: white; border-radius: 0.5rem; padding: 1.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1); }
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0; }
        .connection-status { position: fixed; bottom: 20px; right: 20px; z-index: 1000; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .connected { background-color: #10b981; color: white; }
        .disconnected { background-color: #ef4444; color: white; }
        .connecting { background-color: #f59e0b; color: white; }
        
        /* User Table CSS */
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .user-table th, .user-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        .user-table th {
            background-color: #f8fafc;
            font-weight: 600;
            color: #374151;
        }
        
        .user-table tr:hover {
            background-color: #f9fafb;
        }
        
        .user-table td {
            color: #4b5563;
        }
        
        .btn-edit, .btn-toggle, .btn-view {
            padding: 6px 12px;
            margin: 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-edit {
            background-color: #fbbf24;
            color: #000;
        }
        
        .btn-edit:hover {
            background-color: #f59e0b;
        }
        
        .btn-toggle {
            background-color: #10b981;
            color: white;
        }
        
        .btn-toggle:hover {
            background-color: #059669;
        }
        
        .btn-view {
            background-color: #3b82f6;
            color: white;
        }
        
        .btn-view:hover {
            background-color: #2563eb;
        }
        
        .btn-migrate {
            background-color: #8b5cf6;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
        }
        
        .btn-migrate:hover {
            background-color: #7c3aed;
        }
        
        .active {
            background-color: #10b981;
            color: white;
        }
        
        .inactive {
            background-color: #ef4444;
            color: white;
        }
        
        .staff {
            background-color: #3b82f6;
            color: white;
        }
        
        .not-staff {
            background-color: #9ca3af;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Connection Status Indicator -->
    <div id="connection-status" class="connection-status disconnected">
        <i data-lucide="wifi-off" class="w-4 h-4"></i>
        <span>Admin Disconnected</span>
    </div>
    
    <!-- Loader -->
    <div id="loader" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500"></div>
    </div>
    
    <!-- Login Section -->
    <div id="auth-section" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Admin Panel Login</h2>
            <input id="login-email" type="email" placeholder="Email" class="input-field mb-4">
            <input id="login-password" type="password" placeholder="Password" class="input-field mb-4">
            <button id="login-btn" class="btn btn-primary w-full">Login</button>
            <p id="login-error" class="text-red-500 text-sm mt-2 text-center"></p>
        </div>
    </div>

    <!-- Main Admin Panel -->
    <div id="panel-section" class="hidden">
        <div class="flex h-screen bg-gray-100">
            <!-- Sidebar -->
            <aside class="w-64 bg-gray-800 text-gray-200 flex-shrink-0">
                <div class="p-4 text-2xl font-bold text-white">CashReward</div>
                <nav class="mt-6">
                    <a href="#" data-page="dashboard" class="sidebar-link active flex items-center py-3 px-4">
                        <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>Dashboard
                    </a>
                    <a href="#" data-page="users" class="sidebar-link flex items-center py-3 px-4">
                        <i data-lucide="users" class="w-5 h-5 mr-3"></i>Users
                    </a>
                    <a href="#" data-page="withdrawals" class="sidebar-link flex items-center py-3 px-4">
                        <i data-lucide="banknote" class="w-5 h-5 mr-3"></i>Withdrawals
                    </a>
                    <a href="#" data-page="games" class="sidebar-link flex items-center py-3 px-4">
                        <i data-lucide="gamepad-2" class="w-5 h-5 mr-3"></i>Game Management
                    </a>
                    <a href="#" data-page="adnetwork" class="sidebar-link flex items-center py-3 px-4">
                        <i data-lucide="monitor" class="w-5 h-5 mr-3"></i>Ad Network
                    </a>
                    <a href="#" data-page="notifications" class="sidebar-link flex items-center py-3 px-4">
                        <i data-lucide="send" class="w-5 h-5 mr-3"></i>Notifications
                    </a>
                    <a href="#" data-page="settings" class="sidebar-link flex items-center py-3 px-4">
                        <i data-lucide="settings" class="w-5 h-5 mr-3"></i>App Settings
                    </a>
                </nav>
                <div class="absolute bottom-0 w-64 p-4">
                    <button id="logout-btn" class="w-full bg-red-600 text-white py-2 rounded-lg">Logout</button>
                </div>
            </aside>
            
            <!-- Main Content -->
            <main class="flex-1 p-6 overflow-y-auto">
                <div id="dashboard" class="admin-page active"></div>
                <div id="users" class="admin-page">
                    <!-- Updated Users Page Structure -->
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold">User Management</h1>
                        <div class="flex space-x-2">
                            <button onclick="migrateExistingUsers()" class="btn-migrate">
                                <i data-lucide="database" class="w-4 h-4 mr-2"></i> Migrate Users
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-white shadow rounded-lg p-6">
                        <div class="mb-4 flex justify-between items-center">
                            <div class="flex items-center space-x-4">
                                <input type="text" id="user-search-input" placeholder="Search users..." class="input-field w-64">
                                <button onclick="searchUsers()" class="btn btn-primary">Search</button>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="user-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Telegram ID</th>
                                        <th>Username</th>
                                        <th>First Name</th>
                                        <th>Last Name</th>
                                        <th>Balance</th>
                                        <th>Is Active</th>
                                        <th>Is Staff</th>
                                        <th>Created At</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body">
                                    <!-- Will be populated by JavaScript -->
                                    <tr><td colspan="10" class="text-center py-4 text-gray-500">Loading users...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="withdrawals" class="admin-page"></div>
                <div id="games" class="admin-page"></div>
                <div id="adnetwork" class="admin-page"></div>
                <div id="notifications" class="admin-page"></div>
                <div id="settings" class="admin-page"></div>
            </main>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification" class="hidden fixed top-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 z-50">
        <p id="toast-message"></p>
    </div>

    <!-- Alert Modal -->
    <div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm text-center shadow-xl">
            <p id="alert-message" class="mb-4 text-gray-800"></p>
            <button id="alert-ok-btn" class="btn btn-primary px-6">OK</button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="custom-confirm" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm text-center shadow-xl">
            <p id="confirm-message" class="mb-6 text-gray-800"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="btn bg-gray-200 text-gray-800 px-6">Cancel</button>
                <button id="confirm-ok-btn" class="btn btn-danger px-6">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Quick Game Settings Modal -->
    <div id="quick-game-settings-modal" class="modal-overlay">
        <div class="modal" style="max-width: 450px;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" id="quick-game-title">Quick Settings</h3>
                <button onclick="closeQuickSettingsModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <!-- Play Limit -->
                <div>
                    <label class="block font-semibold mb-2">Daily Play Limit</label>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="quick-play-limit" class="input-field" min="0" max="1000" placeholder="0 = unlimited">
                        <span class="text-gray-600 text-sm">plays per day</span>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">After this limit, game will not be playable for the day</p>
                </div>
                
                <!-- Visibility Toggle -->
                <div class="feature-toggle">
                    <div>
                        <label class="feature-label">Game Visibility</label>
                        <p class="text-sm text-gray-500">Show/hide this game in mini-app</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="quick-game-visible">
                        <span class="slider round"></span>
                    </label>
                </div>
                
                <!-- Additional Quick Settings -->
                <div>
                    <label class="block font-semibold mb-2">Reward Per Play</label>
                    <input type="number" id="quick-game-reward" class="input-field" min="0" placeholder="Points">
                </div>
                
                <div>
                    <label class="block font-semibold mb-2">Game Order</label>
                    <input type="number" id="quick-game-order" class="input-field" min="1" max="10" placeholder="1-10">
                    <p class="text-sm text-gray-500 mt-1">Display order in mini-app (1 = first)</p>
                </div>
            </div>
            
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="closeQuickSettingsModal()" class="btn bg-gray-200 text-gray-800 px-6">Cancel</button>
                <button onclick="saveQuickGameSettings()" class="btn btn-primary px-6">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Edit User Points Modal -->
    <div id="edit-points-modal" class="modal-overlay">
        <div class="modal">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Edit User Points</h3>
                <button onclick="closeEditPointsModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="mb-4">
                <p class="text-gray-600">User: <span id="edit-user-name" class="font-semibold"></span></p>
                <p class="text-gray-600">Email: <span id="edit-user-email" class="font-semibold"></span></p>
                <p class="text-gray-600">Current Balance: <span id="edit-current-balance" class="font-semibold"></span></p>
            </div>
            <div class="mb-6">
                <label class="block font-semibold mb-2">New Balance</label>
                <input type="number" id="new-balance-input" class="input-field" placeholder="Enter new balance">
            </div>
            <div class="flex justify-end space-x-2">
                <button onclick="closeEditPointsModal()" class="btn bg-gray-200 text-gray-800">Cancel</button>
                <button onclick="saveUserPoints()" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- User Details Modal -->
    <div id="user-details-modal" class="modal-overlay">
        <div class="modal" style="max-width: 600px;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">User Details</h3>
                <button onclick="closeUserDetailsModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="user-details-content" class="space-y-3">
                <!-- User details will be loaded here -->
            </div>
            <div class="mt-6 flex justify-end">
                <button onclick="closeUserDetailsModal()" class="btn bg-gray-200 text-gray-800">Close</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBEvTvWy-hH1HHgjoOhUKkj-Dglm11Oc8U",
            authDomain: "cash-rewards-01-624ae.firebaseapp.com",
            projectId: "cash-rewards-01-624ae",
            storageBucket: "cash-rewards-01-624ae.firebasestorage.app",
            messagingSenderId: "29119912449",
            appId: "1:29119912449:web:e0c68c1994ff0a71603e00"
        };
        
        const ADMIN_UIDS = ["7IHZmOp2MGXG2u0wl98kgGgZwEE2"];

        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            updateDoc, 
            collection, 
            getDocs, 
            writeBatch, 
            enableIndexedDbPersistence, 
            query, 
            where, 
            onSnapshot, 
            addDoc, 
            serverTimestamp, 
            setDoc,
            orderBy,
            limit,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Enable persistence
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') {
                console.warn('Firestore persistence failed: multiple tabs open.');
            } else if (err.code == 'unimplemented') {
                console.warn('Firestore persistence not available in this browser.');
            }
        });

        // DOM Elements
        const loader = document.getElementById('loader');
        const connectionStatus = document.getElementById('connection-status');
        let currentEditingUserId = null;
        let currentViewingUserId = null;
        let currentEditingGameId = null;
        let isConnected = false;
        let connectionCheckInterval;

        // Initialize on load
        window.onload = () => {
            lucide.createIcons();
            setupEventListeners();
            checkFirebaseConnection();
            onAuthStateChanged(auth, handleAuthStateChange);
        };

        // Firebase Connection Status Monitor
        async function checkFirebaseConnection() {
            updateConnectionStatus('connecting');
            
            try {
                // Test Firestore connection
                const testDoc = doc(db, "config", "connectionTest");
                await getDoc(testDoc).catch(() => {});
                
                // Test Auth connection
                await auth._initializationPromise;
                
                updateConnectionStatus('connected');
                console.log("✅ Firebase connected successfully!");
                
                // Start periodic connection checks
                if (connectionCheckInterval) {
                    clearInterval(connectionCheckInterval);
                }
                connectionCheckInterval = setInterval(monitorConnection, 10000);
                
            } catch (error) {
                console.error("❌ Firebase connection failed:", error);
                updateConnectionStatus('disconnected');
                
                // Try to reconnect every 5 seconds
                setTimeout(checkFirebaseConnection, 5000);
            }
        }

        function monitorConnection() {
            const testDoc = doc(db, "config", "connectionTest");
            getDoc(testDoc)
                .then(() => {
                    if (!isConnected) {
                        updateConnectionStatus('connected');
                    }
                })
                .catch(() => {
                    updateConnectionStatus('disconnected');
                    console.warn("⚠️ Connection lost, attempting to reconnect...");
                    checkFirebaseConnection();
                });
        }

        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connection-status');
            const icon = statusEl.querySelector('i');
            const text = statusEl.querySelector('span');
            
            statusEl.className = 'connection-status ' + status;
            
            switch(status) {
                case 'connected':
                    isConnected = true;
                    icon.setAttribute('data-lucide', 'wifi');
                    text.textContent = 'Admin Connected';
                    break;
                case 'disconnected':
                    isConnected = false;
                    icon.setAttribute('data-lucide', 'wifi-off');
                    text.textContent = 'Admin Disconnected';
                    break;
                case 'connecting':
                    isConnected = false;
                    icon.setAttribute('data-lucide', 'loader');
                    text.textContent = 'Connecting...';
                    break;
            }
            
            lucide.createIcons();
        }

        // Auth State Handler
        function handleAuthStateChange(user) {
            if (user && ADMIN_UIDS.includes(user.uid)) {
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('panel-section').style.display = 'block';
                navigateTo('dashboard');
                loadDashboardData();
                loadUsers();
            } else {
                document.getElementById('auth-section').style.display = 'flex';
                document.getElementById('panel-section').style.display = 'none';
                if (user) {
                    signOut(auth);
                    showAlert("You are not authorized to access this panel.");
                }
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            
            // Navigation
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateTo(link.dataset.page);
                });
            });
            
            // Alert/Confirm buttons
            document.getElementById('alert-ok-btn').addEventListener('click', () => {
                document.getElementById('custom-alert').classList.add('hidden');
            });
            
            document.getElementById('confirm-cancel-btn').addEventListener('click', () => {
                document.getElementById('custom-confirm').classList.add('hidden');
            });
            
            // Search input listener
            const searchInput = document.getElementById('user-search-input');
            if (searchInput) {
                searchInput.addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') {
                        searchUsers();
                    }
                });
            }
        }

        // Login Handler
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = '';
            
            if (!isConnected) {
                errorEl.textContent = "Cannot connect to database. Please check your internet connection.";
                return;
            }
            
            loader.style.display = 'flex';
            
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                if (!ADMIN_UIDS.includes(userCredential.user.uid)) {
                    await signOut(auth);
                    showAlert("You are not authorized to access this panel.");
                }
            } catch (error) {
                errorEl.textContent = "Invalid email or password.";
                console.error("Login error:", error);
            } finally {
                loader.style.display = 'none';
            }
        }

        // Navigation
        function navigateTo(pageId) {
            document.querySelectorAll('.admin-page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            document.querySelector(`.sidebar-link[data-page="${pageId}"]`).classList.add('active');

            if (pageId === 'dashboard') loadDashboard();
            if (pageId === 'users') loadUsers();
            if (pageId === 'withdrawals') loadWithdrawals();
            if (pageId === 'games') loadGames();
            if (pageId === 'adnetwork') loadAdNetwork();
            if (pageId === 'notifications') loadNotifications();
            if (pageId === 'settings') loadSettings();
        }

        // Dashboard Functions
        async function loadDashboard() {
            const page = document.getElementById('dashboard');
            page.innerHTML = `
                <h1 class="text-3xl font-bold mb-6">Dashboard</h1>
                <div id="stats-grid" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="stat-card p-6"><h3 class="text-gray-500 text-lg">Total Users</h3><p id="total-users" class="text-4xl font-bold mt-2">0</p></div>
                    <div class="stat-card p-6"><h3 class="text-gray-500 text-lg">Active Users</h3><p id="active-users" class="text-4xl font-bold mt-2">0</p></div>
                    <div class="stat-card p-6"><h3 class="text-gray-500 text-lg">Today's Earnings</h3><p id="today-earnings" class="text-4xl font-bold text-green-600 mt-2">0</p></div>
                    <div class="stat-card p-6"><h3 class="text-gray-500 text-lg">Total Points</h3><p id="total-points" class="text-4xl font-bold text-blue-600 mt-2">0</p></div>
                </div>
                <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h2 class="text-2xl font-bold mb-4">Recent Users</h2>
                        <div id="recent-users" class="bg-white shadow rounded-lg p-4">
                            Loading...
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-4">System Status</h2>
                        <div class="bg-white shadow rounded-lg p-4">
                            <div class="space-y-4">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold">Database Connection</span>
                                    <span class="status-badge connected">Connected</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold">Admin Panel</span>
                                    <span class="status-badge active">Online</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold">Total Staff Users</span>
                                    <span id="staff-count" class="font-bold">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Load real-time data
            loadDashboardData();
        }

        function loadDashboardData() {
            // Total Users (real-time)
            onSnapshot(collection(db, "users"), snap => {
                const totalUsers = snap.size;
                document.getElementById('total-users').textContent = totalUsers;
                
                // Count active users
                let activeUsers = 0;
                let staffCount = 0;
                let totalPoints = 0;
                
                snap.forEach(doc => {
                    const userData = doc.data();
                    if (userData.isActive !== false) {
                        activeUsers++;
                    }
                    if (userData.isStaff === true) {
                        staffCount++;
                    }
                    totalPoints += parseFloat(userData.balance || 0);
                });
                
                document.getElementById('active-users').textContent = activeUsers;
                document.getElementById('staff-count').textContent = staffCount;
                document.getElementById('total-points').textContent = totalPoints.toFixed(0);
            });

            // Load recent users
            loadRecentUsers();
            loadTodayEarnings();
        }

        async function loadRecentUsers() {
            const usersSnap = await getDocs(query(
                collection(db, "users"), 
                orderBy("createdAt", "desc"), 
                limit(5)
            ));
            
            let html = `<table class="w-full">
                <thead><tr><th>Telegram ID</th><th>Username</th><th>Balance</th><th>Status</th></tr></thead>
                <tbody>`;
            
            if (usersSnap.empty) {
                html += `<tr><td colspan="4" class="text-center py-4 text-gray-500">No users found</td></tr>`;
            } else {
                usersSnap.forEach(doc => {
                    const user = doc.data();
                    const isActive = user.isActive !== false;
                    const statusClass = isActive ? 'active' : 'inactive';
                    html += `<tr class="border-b">
                        <td class="py-2">${user.telegramId || 'N/A'}</td>
                        <td class="py-2">${user.telegramUsername || 'N/A'}</td>
                        <td class="py-2 font-semibold">${parseFloat(user.balance || 0).toFixed(2)}</td>
                        <td class="py-2"><span class="status-badge ${statusClass}">${isActive ? 'Active' : 'Inactive'}</span></td>
                    </tr>`;
                });
            }
            
            html += `</tbody></table>`;
            document.getElementById('recent-users').innerHTML = html;
        }

        async function loadTodayEarnings() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const pointHistorySnap = await getDocs(query(
                collection(db, "pointHistory"),
                where("timestamp", ">=", today)
            ));
            
            let totalEarnings = 0;
            pointHistorySnap.forEach(doc => {
                const history = doc.data();
                if (history.points > 0) {
                    totalEarnings += history.points;
                }
            });
            
            document.getElementById('today-earnings').textContent = totalEarnings.toFixed(2);
        }

        // ===== UPDATED USER MANAGEMENT FUNCTIONS =====
        async function loadUsersForAdmin() {
            try {
                const usersRef = collection(db, "users");
                const querySnapshot = await getDocs(usersRef);
                
                const users = [];
                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    
                    // Use the new structure
                    users.push({
                        id: userData.telegramId || doc.id, // Show Telegram ID
                        telegramId: userData.telegramId,
                        username: userData.telegramUsername || '-',
                        firstName: userData.telegramFirstName || '',
                        lastName: userData.telegramLastName || '-',
                        balance: parseFloat(userData.balance || 0).toFixed(2),
                        isActive: userData.isActive !== false, // Default to true
                        isStaff: userData.isStaff === true,
                        createdAt: userData.createdAt?.toDate() || new Date(),
                        uid: doc.id,
                        userType: userData.userType || 'unknown'
                    });
                });
                
                // Sort by creation date (newest first)
                users.sort((a, b) => b.createdAt - a.createdAt);
                
                displayUsersInAdminPanel(users);
                
            } catch (error) {
                console.error("Error loading users:", error);
                document.getElementById('users-table-body').innerHTML = 
                    `<tr><td colspan="10" class="text-center py-4 text-red-500">Error loading users: ${error.message}</td></tr>`;
            }
        }

        function displayUsersInAdminPanel(users) {
            const tableBody = document.getElementById('users-table-body');
            tableBody.innerHTML = '';
            
            if (users.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-gray-500">No users found</td></tr>`;
                return;
            }
            
            users.forEach((user, index) => {
                const row = document.createElement('tr');
                
                // Format date
                const createdAt = new Date(user.createdAt);
                const formattedDate = createdAt.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${user.telegramId || '-'}</td>
                    <td>${user.username || '-'}</td>
                    <td>${user.firstName || '-'}</td>
                    <td>${user.lastName || '-'}</td>
                    <td>${parseFloat(user.balance).toFixed(2)}</td>
                    <td>
                        <span class="status-badge ${user.isActive ? 'active' : 'inactive'}">
                            ${user.isActive ? 'True' : 'False'}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${user.isStaff ? 'staff' : 'not-staff'}">
                            ${user.isStaff ? 'True' : 'False'}
                        </span>
                    </td>
                    <td>${formattedDate}</td>
                    <td>
                        <button onclick="editUser('${user.uid}')" class="btn-edit">Edit</button>
                        <button onclick="toggleActive('${user.uid}', ${!user.isActive})" class="btn-toggle">
                            ${user.isActive ? 'Deactivate' : 'Activate'}
                        </button>
                        <button onclick="viewUserDetails('${user.uid}')" class="btn-view">View</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Toggle user active status
        async function toggleActive(userId, newStatus) {
            try {
                const userRef = doc(db, "users", userId);
                await updateDoc(userRef, {
                    isActive: newStatus,
                    updatedAt: serverTimestamp()
                });
                
                showToast(`User ${newStatus ? 'activated' : 'deactivated'} successfully!`);
                loadUsersForAdmin(); // Refresh the list
            } catch (error) {
                console.error("Error updating user:", error);
                showAlert("Error updating user status", true);
            }
        }

        // Edit user (e.g., update balance)
        async function editUser(userId) {
            const userRef = doc(db, "users", userId);
            const userSnap = await getDoc(userRef);
            
            if (userSnap.exists()) {
                const userData = userSnap.data();
                
                // Show edit modal
                const newBalance = prompt("Enter new balance:", parseFloat(userData.balance || 0).toFixed(2));
                
                if (newBalance !== null) {
                    const balanceNum = parseFloat(newBalance);
                    if (!isNaN(balanceNum)) {
                        await updateDoc(userRef, {
                            balance: balanceNum,
                            updatedAt: serverTimestamp()
                        });
                        showToast("Balance updated successfully!");
                        loadUsersForAdmin();
                    } else {
                        showAlert("Invalid number");
                    }
                }
            }
        }

        // View user details
        async function viewUserDetails(userId) {
            const userRef = doc(db, "users", userId);
            const userSnap = await getDoc(userRef);
            
            if (userSnap.exists()) {
                const userData = userSnap.data();
                
                // Format date
                const createdAt = userData.createdAt?.toDate();
                const formattedCreatedAt = createdAt ? createdAt.toLocaleString() : 'N/A';
                
                const lastLogin = userData.lastLogin?.toDate();
                const formattedLastLogin = lastLogin ? lastLogin.toLocaleString() : 'Never';
                
                // Show detailed view modal
                const detailsContent = `
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="font-semibold">Telegram ID:</p>
                            <p class="text-gray-600">${userData.telegramId || 'N/A'}</p>
                        </div>
                        <div>
                            <p class="font-semibold">Username:</p>
                            <p class="text-gray-600">${userData.telegramUsername || 'N/A'}</p>
                        </div>
                        <div>
                            <p class="font-semibold">First Name:</p>
                            <p class="text-gray-600">${userData.telegramFirstName || ''}</p>
                        </div>
                        <div>
                            <p class="font-semibold">Last Name:</p>
                            <p class="text-gray-600">${userData.telegramLastName || ''}</p>
                        </div>
                        <div>
                            <p class="font-semibold">Balance:</p>
                            <p class="text-gray-600 font-bold">${parseFloat(userData.balance || 0).toFixed(2)}</p>
                        </div>
                        <div>
                            <p class="font-semibold">User Type:</p>
                            <p class="text-gray-600">${userData.userType || 'unknown'}</p>
                        </div>
                        <div>
                            <p class="font-semibold">Is Active:</p>
                            <p class="text-gray-600">${userData.isActive !== false ? 'Yes' : 'No'}</p>
                        </div>
                        <div>
                            <p class="font-semibold">Is Staff:</p>
                            <p class="text-gray-600">${userData.isStaff === true ? 'Yes' : 'No'}</p>
                        </div>
                        <div>
                            <p class="font-semibold">Created:</p>
                            <p class="text-gray-600">${formattedCreatedAt}</p>
                        </div>
                        <div>
                            <p class="font-semibold">Last Login:</p>
                            <p class="text-gray-600">${formattedLastLogin}</p>
                        </div>
                        <div class="col-span-2">
                            <p class="font-semibold">Total Earned:</p>
                            <p class="text-gray-600">${userData.totalEarned || 0}</p>
                        </div>
                        <div class="col-span-2">
                            <p class="font-semibold">Tasks Completed:</p>
                            <p class="text-gray-600">${userData.tasksCompleted || 0}</p>
                        </div>
                    </div>
                `;
                
                document.getElementById('user-details-content').innerHTML = detailsContent;
                document.getElementById('user-details-modal').style.display = 'flex';
            } else {
                showAlert("User not found", true);
            }
        }

        function closeUserDetailsModal() {
            document.getElementById('user-details-modal').style.display = 'none';
        }

        // Search users function
        async function searchUsers() {
            const searchTerm = document.getElementById('user-search-input').value.toLowerCase();
            
            try {
                const usersRef = collection(db, "users");
                const querySnapshot = await getDocs(usersRef);
                
                const users = [];
                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    
                    // Check if user matches search term
                    const matchesSearch = 
                        (userData.telegramId && userData.telegramId.toLowerCase().includes(searchTerm)) ||
                        (userData.telegramUsername && userData.telegramUsername.toLowerCase().includes(searchTerm)) ||
                        (userData.telegramFirstName && userData.telegramFirstName.toLowerCase().includes(searchTerm)) ||
                        (userData.telegramLastName && userData.telegramLastName.toLowerCase().includes(searchTerm));
                    
                    if (matchesSearch || !searchTerm) {
                        users.push({
                            id: userData.telegramId || doc.id,
                            telegramId: userData.telegramId,
                            username: userData.telegramUsername || '-',
                            firstName: userData.telegramFirstName || '',
                            lastName: userData.telegramLastName || '-',
                            balance: parseFloat(userData.balance || 0).toFixed(2),
                            isActive: userData.isActive !== false,
                            isStaff: userData.isStaff === true,
                            createdAt: userData.createdAt?.toDate() || new Date(),
                            uid: doc.id,
                            userType: userData.userType || 'unknown'
                        });
                    }
                });
                
                // Sort by creation date (newest first)
                users.sort((a, b) => b.createdAt - a.createdAt);
                
                displayUsersInAdminPanel(users);
                
            } catch (error) {
                console.error("Error searching users:", error);
                showAlert("Error searching users", true);
            }
        }

        // Migration Script for Existing Users
        async function migrateExistingUsers() {
            showConfirm("Are you sure you want to migrate existing users to the new structure? This will update all users with Telegram IDs.", async () => {
                loader.style.display = 'flex';
                try {
                    const usersRef = collection(db, "users");
                    const querySnapshot = await getDocs(usersRef);
                    
                    let migrated = 0;
                    const batch = writeBatch(db);
                    
                    querySnapshot.forEach((doc) => {
                        const userData = doc.data();
                        const updates = {};
                        
                        // Check if user needs migration
                        if (!userData.telegramId && doc.id.startsWith('tg_')) {
                            // Extract Telegram ID from uid
                            const telegramId = doc.id.replace('tg_', '');
                            updates.telegramId = telegramId;
                            
                            // Add other missing fields
                            if (userData.balance === undefined) updates.balance = 0.00;
                            if (userData.isActive === undefined) updates.isActive = true;
                            if (userData.isStaff === undefined) updates.isStaff = false;
                            if (userData.userType === undefined) updates.userType = 'telegram';
                            
                            // Update the document
                            batch.update(doc.ref, updates);
                            migrated++;
                        }
                    });
                    
                    await batch.commit();
                    console.log(`✅ Migrated ${migrated} users to new structure`);
                    showToast(`Migrated ${migrated} users successfully!`);
                    
                    // Refresh the user list
                    loadUsersForAdmin();
                    
                } catch (error) {
                    console.error("Migration error:", error);
                    showAlert("Migration failed: " + error.message, true);
                } finally {
                    loader.style.display = 'none';
                }
            });
        }

        // Simplified loadUsers function
        async function loadUsers() {
            // Page structure is already in HTML, just load the data
            loadUsersForAdmin();
        }

        // Other page functions (placeholder implementations)
        async function loadWithdrawals() {
            const page = document.getElementById('withdrawals');
            page.innerHTML = `
                <h1 class="text-3xl font-bold mb-6">Withdrawal Requests</h1>
                <div class="bg-white shadow rounded-lg p-6">
                    <p class="text-gray-600">Withdrawals management will be implemented here.</p>
                </div>
            `;
        }

        async function loadGames() {
            const page = document.getElementById('games');
            page.innerHTML = `
                <h1 class="text-3xl font-bold mb-6">Game Management</h1>
                <div class="bg-white shadow rounded-lg p-6">
                    <p class="text-gray-600">Game management will be implemented here.</p>
                </div>
            `;
        }

        async function loadAdNetwork() {
            const page = document.getElementById('adnetwork');
            page.innerHTML = `
                <h1 class="text-3xl font-bold mb-6">Ad Network</h1>
                <div class="bg-white shadow rounded-lg p-6">
                    <p class="text-gray-600">Ad network management will be implemented here.</p>
                </div>
            `;
        }

        async function loadNotifications() {
            const page = document.getElementById('notifications');
            page.innerHTML = `
                <h1 class="text-3xl font-bold mb-6">Notifications</h1>
                <div class="bg-white shadow rounded-lg p-6">
                    <p class="text-gray-600">Notifications management will be implemented here.</p>
                </div>
            `;
        }

        async function loadSettings() {
            const page = document.getElementById('settings');
            page.innerHTML = `
                <h1 class="text-3xl font-bold mb-6">App Settings</h1>
                <div class="bg-white shadow rounded-lg p-6">
                    <p class="text-gray-600">App settings will be implemented here.</p>
                </div>
            `;
        }

        // Utility Functions
        function showAlert(message, isError = false) {
            const alertBox = document.getElementById('custom-alert');
            const msgEl = document.getElementById('alert-message');
            if (alertBox && msgEl) {
                msgEl.textContent = message;
                if (isError) {
                    alertBox.querySelector('.btn-primary').classList.add('bg-red-600');
                } else {
                    alertBox.querySelector('.btn-primary').classList.remove('bg-red-600');
                }
                alertBox.classList.remove('hidden');
            }
        }

        function showConfirm(message, onConfirm) {
            document.getElementById('confirm-message').textContent = message;
            const confirmModal = document.getElementById('custom-confirm');
            confirmModal.classList.remove('hidden');
            
            // Create new buttons to avoid duplicate listeners
            const oldOkBtn = document.getElementById('confirm-ok-btn');
            const oldCancelBtn = document.getElementById('confirm-cancel-btn');
            
            const newOkBtn = oldOkBtn.cloneNode(true);
            const newCancelBtn = oldCancelBtn.cloneNode(true);
            
            oldOkBtn.parentNode.replaceChild(newOkBtn, oldOkBtn);
            oldCancelBtn.parentNode.replaceChild(newCancelBtn, oldCancelBtn);
            
            newOkBtn.addEventListener('click', () => {
                confirmModal.classList.add('hidden');
                onConfirm();
            });
            
            newCancelBtn.addEventListener('click', () => {
                confirmModal.classList.add('hidden');
            });
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            
            if (!toast || !toastMessage) return;

            toastMessage.textContent = message;
            toast.className = `fixed top-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 z-50 ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.remove('opacity-0'), 50);

            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 500);
            }, 3000);
        }

        // Make functions available globally
        window.toggleActive = toggleActive;
        window.editUser = editUser;
        window.viewUserDetails = viewUserDetails;
        window.closeUserDetailsModal = closeUserDetailsModal;
        window.searchUsers = searchUsers;
        window.migrateExistingUsers = migrateExistingUsers;
        window.loadUsersForAdmin = loadUsersForAdmin;
        window.displayUsersInAdminPanel = displayUsersInAdminPanel;
        window.closeQuickSettingsModal = closeQuickSettingsModal;
        window.saveQuickGameSettings = saveQuickGameSettings;
        window.closeEditPointsModal = closeEditPointsModal;
        window.saveUserPoints = saveUserPoints;
    </script>
</body>
</html>
