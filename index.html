<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>CashReward Admin Panel - Game Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6; 
            overflow-x: hidden;
        }
        .admin-page { display: none; }
        .admin-page.active { display: block; animation: fadeIn 0.5s; }
        .sidebar-link { 
            transition: all 0.2s; 
            border-left: 3px solid transparent; 
            cursor: pointer;
        }
        .sidebar-link.active, .sidebar-link:hover { 
            background-color: #4f46e5; 
            color: white; 
            border-left-color: #818cf8; 
        }
        .stat-card { 
            background: white; 
            border-radius: 0.5rem; 
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); 
        }
        .input-field { 
            border: 1px solid #cbd5e1; 
            padding: 0.5rem 0.75rem; 
            border-radius: 0.375rem; 
            width: 100%; 
            background-color: white;
            color: #1f2937 !important;
        }
        .input-field::placeholder { 
            color: #6b7280 !important; 
        }
        .input-field:focus { 
            outline: none; 
            border-color: #4f46e5;
            color: #1f2937 !important;
        }
        textarea.input-field {
            min-height: 100px;
            resize: vertical;
            color: #1f2937 !important;
        }
        input[type="number"].input-field,
        input[type="url"].input-field,
        input[type="text"].input-field,
        input[type="email"].input-field,
        input[type="password"].input-field {
            color: #1f2937 !important;
        }
        /* Ensure all input fields have proper colors */
        .modal input,
        .modal textarea,
        .settings-section input,
        .settings-section textarea,
        .website-field input,
        .website-field textarea {
            color: #1f2937 !important;
        }
        /* Specific settings fields */
        #notification-title,
        #notification-message,
        #telegram-bot-token,
        #telegram-chat-id,
        #richads-pubid,
        #richads-appid,
        #taddy-publicid,
        #adsgram-rewardid,
        #adsgram-interstitialid,
        #minWithdrawal,
        #conversionRatePoints,
        #conversionRateTaka,
        #dailyAdLimit,
        #adWatchReward,
        #colorGameReward,
        #ludoDiceReward,
        #watchVideoReward,
        #tryYourLuckReward,
        #paymentMethods,
        #referralBonus,
        #referrerBonus,
        #referralShareText,
        #watchAdSpecialTaskCount,
        #watchAdSpecialTaskReward,
        #watchAdSpecialTaskTimer,
        #colorGameSpecialTaskCount,
        #colorGameSpecialTaskReward,
        #colorGameSpecialTaskTimer,
        #ludoDiceSpecialTaskCount,
        #ludoDiceSpecialTaskReward,
        #ludoDiceSpecialTaskTimer,
        #ipinfoApiToken,
        #allowedCountries,
        #global-play-limit,
        #global-reward,
        #quick-play-limit,
        #quick-game-reward,
        #quick-game-order,
        #user-search-input,
        #new-balance-input,
        #login-email,
        #login-password {
            color: #1f2937 !important;
            background-color: white;
        }
        .btn { 
            padding: 0.5rem 1rem; 
            border-radius: 0.375rem; 
            font-weight: 600; 
            transition: all 0.2s; 
            cursor: pointer; 
        }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background-color: #4f46e5; color: white; border: none; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #64748b; color: white; border: none; }
        .btn-danger { background-color: #ef4444; color: white; border: none; }
        .btn-success { background-color: #10b981; color: white; border: none; }
        .btn-warning { background-color: #f59e0b; color: white; border: none; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        #toast-notification { transition: opacity 0.5s ease-in-out; }
        table { width: 100%; border-collapse: collapse; }
        th, td { 
            padding: 0.75rem; 
            text-align: left; 
            border-bottom: 1px solid #e5e7eb; 
            color: #374151 !important;
        }
        th { background-color: #f9fafb; font-weight: 600; color: #111827 !important; }
        .status-badge { 
            padding: 0.25rem 0.75rem; 
            border-radius: 9999px; 
            font-size: 0.75rem; 
            font-weight: 600; 
        }
        .status-active { background-color: #d1fae5; color: #065f46; }
        .status-blocked { background-color: #fee2e2; color: #991b1b; }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-approved { background-color: #d1fae5; color: #065f46; }
        .status-rejected { background-color: #fee2e2; color: #991b1b; }
        .status-visible { background-color: #3b82f6; color: white; }
        .status-hidden { background-color: #6b7280; color: white; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.5); 
            z-index: 1000; 
            padding: 1rem;
        }
        .modal { 
            background: white; 
            border-radius: 0.5rem; 
            max-width: 500px; 
            margin: 0 auto; 
            padding: 1.5rem; 
            max-height: 80vh; 
            overflow-y: auto; 
            width: 100%;
        }
        .point-input { width: 100px; text-align: center; }
        .view-points-btn { 
            background-color: #3b82f6; 
            color: white; 
            padding: 0.25rem 0.5rem; 
            border-radius: 0.25rem; 
            font-size: 0.75rem; 
        }
        .game-card { 
            background: white; 
            border-radius: 0.5rem; 
            padding: 1.5rem; 
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1); 
        }
        .time-input { width: 120px; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { 
            position: absolute; 
            cursor: pointer; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background-color: #ccc; 
            transition: .4s; 
        }
        .slider:before { 
            position: absolute; 
            content: ""; 
            height: 26px; 
            width: 26px; 
            left: 4px; 
            bottom: 4px; 
            background-color: white; 
            transition: .4s; 
        }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(26px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }
        .website-item { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 10px; 
            padding: 10px; 
            border: 1px solid #e5e7eb; 
            border-radius: 8px; 
            background: #f9fafb; 
            flex-wrap: wrap;
        }
        .website-field { flex: 1; min-width: 150px; }
        .website-field input { width: 100%; }
        .feature-toggle { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            margin: 1rem 0; 
            flex-wrap: wrap;
        }
        .feature-label { font-weight: 600; color: #374151; }
        .game-limits-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 1rem; 
            margin: 1.5rem 0; 
        }
        .limit-card { 
            background: #f8fafc; 
            border: 1px solid #e2e8f0; 
            border-radius: 8px; 
            padding: 1rem; 
        }
        .limit-title { 
            font-size: 0.875rem; 
            font-weight: 600; 
            color: #475569; 
            margin-bottom: 0.5rem; 
        }
        .limit-value { 
            font-size: 1.25rem; 
            font-weight: 700; 
            color: #1e40af; 
        }
        .game-action-buttons { 
            display: flex; 
            gap: 0.5rem; 
            margin-top: 1rem; 
            flex-wrap: wrap;
        }
        .settings-section { margin-bottom: 2rem; }
        .settings-card { 
            background: white; 
            border-radius: 0.5rem; 
            padding: 1.5rem; 
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1); 
        }
        .settings-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 1rem; 
            margin: 1rem 0; 
        }
        .connection-status { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            z-index: 1000; 
            padding: 8px 16px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: 600; 
            display: flex; 
            align-items: center; 
            gap: 6px; 
        }
        .connected { background-color: #10b981; color: white; }
        .disconnected { background-color: #ef4444; color: white; }
        .connecting { background-color: #f59e0b; color: white; }
        
        /* User Table CSS */
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .user-table th, .user-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            color: #374151 !important;
        }
        
        .user-table th {
            background-color: #f8fafc;
            font-weight: 600;
            color: #111827 !important;
        }
        
        .user-table tr:hover {
            background-color: #f9fafb;
        }
        
        .user-table td {
            color: #4b5563 !important;
        }
        
        .btn-edit, .btn-toggle, .btn-view, .btn-delete {
            padding: 6px 12px;
            margin: 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-edit {
            background-color: #fbbf24;
            color: #000;
        }
        
        .btn-edit:hover {
            background-color: #f59e0b;
        }
        
        .btn-toggle {
            background-color: #10b981;
            color: white;
        }
        
        .btn-toggle:hover {
            background-color: #059669;
        }
        
        .btn-view {
            background-color: #3b82f6;
            color: white;
        }
        
        .btn-view:hover {
            background-color: #2563eb;
        }
        
        .btn-delete {
            background-color: #ef4444;
            color: white;
        }
        
        .btn-delete:hover {
            background-color: #dc2626;
        }
        
        .btn-migrate {
            background-color: #8b5cf6;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
        }
        
        .btn-migrate:hover {
            background-color: #7c3aed;
        }
        
        .active {
            background-color: #10b981;
            color: white;
        }
        
        .inactive {
            background-color: #ef4444;
            color: white;
        }
        
        .staff {
            background-color: #3b82f6;
            color: white;
        }
        
        .not-staff {
            background-color: #9ca3af;
            color: white;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .flex.h-screen {
                flex-direction: column;
                height: auto;
            }
            
            aside.w-64 {
                width: 100%;
                position: fixed;
                top: 0;
                left: -100%;
                height: 100vh;
                z-index: 40;
                transition: left 0.3s ease;
                overflow-y: auto;
            }
            
            aside.w-64.active {
                left: 0;
            }
            
            main.flex-1 {
                margin-top: 60px;
                padding: 1rem;
                width: 100%;
            }
            
            .mobile-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 1rem;
                background-color: #4f46e5;
                color: white;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 30;
            }
            
            .mobile-menu-btn {
                background: none;
                border: none;
                color: white;
                cursor: pointer;
            }
            
            .game-limits-grid,
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .grid.grid-cols-1.md\:grid-cols-4,
            .grid.grid-cols-1.lg\:grid-cols-2,
            .grid.grid-cols-1.md\:grid-cols-3 {
                grid-template-columns: 1fr;
            }
            
            .game-card {
                padding: 1rem;
            }
            
            .user-table {
                font-size: 0.8rem;
            }
            
            .user-table th, 
            .user-table td {
                padding: 8px;
            }
            
            .website-item {
                flex-direction: column;
            }
            
            .website-field {
                min-width: 100%;
            }
            
            .modal {
                margin: 1rem auto;
                max-height: 90vh;
            }
            
            .connection-status {
                bottom: 10px;
                right: 10px;
                font-size: 10px;
                padding: 6px 12px;
            }
        }
        
        /* Desktop Styles */
        @media (min-width: 769px) {
            .mobile-header {
                display: none;
            }
            
            .mobile-menu-btn {
                display: none;
            }
        }
        
        /* Dark text for tables */
        table.w-full th,
        table.w-full td {
            color: #374151 !important;
        }
        
        /* Select all checkbox */
        .user-select-all {
            margin-right: 10px;
        }
        
        /* User selection controls */
        .user-selection-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        /* User row selection */
        .user-row.selected {
            background-color: #e0f2fe !important;
        }
        
        .user-row.selected td {
            border-color: #93c5fd;
        }
        
        /* Custom message modal */
        .custom-message-modal {
            max-width: 600px !important;
        }
        
        /* Payment notification badge */
        .notification-badge {
            position: relative;
        }
        
        .notification-badge::after {
            content: '';
            position: absolute;
            top: -5px;
            right: -5px;
            width: 12px;
            height: 12px;
            background-color: #ef4444;
            border-radius: 50%;
            border: 2px solid white;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Mobile Header -->
    <div class="mobile-header">
        <button class="mobile-menu-btn" onclick="toggleSidebar()">
            <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
        <div class="text-xl font-bold">CashReward Admin</div>
        <div class="w-6"></div> <!-- Spacer for alignment -->
    </div>
    
    <!-- Connection Status Indicator -->
    <div id="connection-status" class="connection-status disconnected">
        <i data-lucide="wifi-off" class="w-4 h-4"></i>
        <span>Admin Disconnected</span>
    </div>
    
    <!-- Loader -->
    <div id="loader" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500"></div>
    </div>
    
    <!-- Login Section -->
    <div id="auth-section" class="min-h-screen flex items-center justify-center bg-gray-100 p-4">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Admin Panel Login</h2>
            <input id="login-email" type="email" placeholder="Email" class="input-field mb-4">
            <input id="login-password" type="password" placeholder="Password" class="input-field mb-4">
            <button id="login-btn" class="btn btn-primary w-full">Login</button>
            <p id="login-error" class="text-red-500 text-sm mt-2 text-center"></p>
        </div>
    </div>

    <!-- Main Admin Panel -->
    <div id="panel-section" class="hidden">
        <div class="flex h-screen bg-gray-100">
            <!-- Sidebar -->
            <aside class="w-64 bg-gray-800 text-gray-200 flex-shrink-0">
                <div class="p-4 text-2xl font-bold text-white">CashReward</div>
                <nav class="mt-6">
                    <a href="#" data-page="dashboard" class="sidebar-link active flex items-center py-3 px-4">
                        <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>Dashboard
                    </a>
                    <a href="#" data-page="users" class="sidebar-link flex items-center py-3 px-4">
                        <i data-lucide="users" class="w-5 h-5 mr-3"></i>Users
                    </a>
                    <a href="#" data-page="withdrawals" class="sidebar-link flex items-center py-3 px-4">
                        <i data-lucide="banknote" class="w-5 h-5 mr-3"></i>Withdrawals
                    </a>
                    <a href="#" data-page="custom-messages" class="sidebar-link flex items-center py-3 px-4">
                        <i data-lucide="message-square" class="w-5 h-5 mr-3"></i>Custom Messages
                    </a>
                    <a href="#" data-page="games" class="sidebar-link flex items-center py-3 px-4">
                        <i data-lucide="gamepad-2" class="w-5 h-5 mr-3"></i>Game Management
                    </a>
                    <a href="#" data-page="adnetwork" class="sidebar-link flex items-center py-3 px-4">
                        <i data-lucide="monitor" class="w-5 h-5 mr-3"></i>Ad Network
                    </a>
                    <a href="#" data-page="notifications" class="sidebar-link flex items-center py-3 px-4">
                        <i data-lucide="send" class="w-5 h-5 mr-3"></i>Notifications
                    </a>
                    <a href="#" data-page="settings" class="sidebar-link flex items-center py-3 px-4">
                        <i data-lucide="settings" class="w-5 h-5 mr-3"></i>App Settings
                    </a>
                </nav>
                <div class="absolute bottom-0 w-64 p-4">
                    <button id="logout-btn" class="w-full bg-red-600 text-white py-2 rounded-lg">Logout</button>
                </div>
            </aside>
            
            <!-- Main Content -->
            <main class="flex-1 p-6 overflow-y-auto">
                <div id="dashboard" class="admin-page active"></div>
                <div id="users" class="admin-page">
                    <!-- Updated Users Page Structure -->
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-gray-800">User Management</h1>
                        <div class="flex space-x-2">
                            <button onclick="migrateExistingUsers()" class="btn-migrate">
                                <i data-lucide="database" class="w-4 h-4 mr-2"></i> Migrate Users
                            </button>
                            <button onclick="openCustomMessageModalFromUsers()" class="btn btn-primary">
                                <i data-lucide="send" class="w-4 h-4 mr-2"></i> Send Message
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-white shadow rounded-lg p-6">
                        <div class="mb-4 flex justify-between items-center">
                            <div class="flex items-center space-x-4">
                                <input type="text" id="user-search-input" placeholder="Search users..." class="input-field w-64">
                                <button onclick="searchUsers()" class="btn btn-primary">Search</button>
                            </div>
                        </div>
                        
                        <!-- User Selection Controls -->
                        <div class="user-selection-controls">
                            <div class="flex items-center">
                                <input type="checkbox" id="select-all-users" class="user-select-all" onchange="toggleSelectAllUsers(this.checked)">
                                <label for="select-all-users" class="ml-2 text-gray-700">Select All</label>
                            </div>
                            <button onclick="deleteSelectedUsers()" class="btn btn-danger">
                                <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i> Delete Selected
                            </button>
                            <button onclick="sendCustomMessageToSelected()" class="btn btn-primary">
                                <i data-lucide="send" class="w-4 h-4 mr-2"></i> Send Message to Selected
                            </button>
                            <span id="selected-count" class="text-gray-600">0 users selected</span>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="user-table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">
                                            <input type="checkbox" id="table-select-all" onchange="toggleTableSelectAll(this.checked)">
                                        </th>
                                        <th>ID</th>
                                        <th>Telegram ID</th>
                                        <th>Username</th>
                                        <th>First Name</th>
                                        <th>Balance</th>
                                        <th>Is Active</th>
                                        <th>Is Staff</th>
                                        <th>Created At</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body">
                                    <!-- Will be populated by JavaScript -->
                                    <tr><td colspan="10" class="text-center py-4 text-gray-500">Loading users...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="withdrawals" class="admin-page"></div>
                <div id="custom-messages" class="admin-page"></div>
                <div id="games" class="admin-page"></div>
                <div id="adnetwork" class="admin-page"></div>
                <div id="notifications" class="admin-page"></div>
                <div id="settings" class="admin-page"></div>
            </main>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification" class="hidden fixed top-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 z-50">
        <p id="toast-message"></p>
    </div>

    <!-- Alert Modal -->
    <div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm text-center shadow-xl">
            <p id="alert-message" class="mb-4 text-gray-800"></p>
            <button id="alert-ok-btn" class="btn btn-primary px-6">OK</button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="custom-confirm" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm text-center shadow-xl">
            <p id="confirm-message" class="mb-6 text-gray-800"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="btn bg-gray-200 text-gray-800 px-6">Cancel</button>
                <button id="confirm-ok-btn" class="btn btn-danger px-6">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Quick Game Settings Modal -->
    <div id="quick-game-settings-modal" class="modal-overlay">
        <div class="modal" style="max-width: 450px;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800" id="quick-game-title">Quick Settings</h3>
                <button onclick="closeQuickSettingsModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <!-- Play Limit -->
                <div>
                    <label class="block font-semibold mb-2 text-gray-700">Daily Play Limit</label>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="quick-play-limit" class="input-field" min="0" max="1000" placeholder="0 = unlimited">
                        <span class="text-gray-600 text-sm">plays per day</span>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">After this limit, game will not be playable for the day</p>
                </div>
                
                <!-- Visibility Toggle -->
                <div class="feature-toggle">
                    <div>
                        <label class="feature-label text-gray-700">Game Visibility</label>
                        <p class="text-sm text-gray-500">Show/hide this game in mini-app</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="quick-game-visible">
                        <span class="slider round"></span>
                    </label>
                </div>
                
                <!-- Additional Quick Settings -->
                <div>
                    <label class="block font-semibold mb-2 text-gray-700">Reward Per Play</label>
                    <input type="number" id="quick-game-reward" class="input-field" min="0" placeholder="Points">
                </div>
                
                <div>
                    <label class="block font-semibold mb-2 text-gray-700">Game Order</label>
                    <input type="number" id="quick-game-order" class="input-field" min="1" max="10" placeholder="1-10">
                    <p class="text-sm text-gray-500 mt-1">Display order in mini-app (1 = first)</p>
                </div>
            </div>
            
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="closeQuickSettingsModal()" class="btn bg-gray-200 text-gray-800 px-6">Cancel</button>
                <button onclick="saveQuickGameSettings()" class="btn btn-primary px-6">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Edit User Points Modal -->
    <div id="edit-points-modal" class="modal-overlay">
        <div class="modal">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Edit User Points</h3>
                <button onclick="closeEditPointsModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="mb-4">
                <p class="text-gray-600">User: <span id="edit-user-name" class="font-semibold text-gray-800"></span></p>
                <p class="text-gray-600">Telegram ID: <span id="edit-user-telegram" class="font-semibold text-gray-800"></span></p>
                <p class="text-gray-600">Current Balance: <span id="edit-current-balance" class="font-semibold text-gray-800"></span></p>
            </div>
            <div class="mb-6">
                <label class="block font-semibold mb-2 text-gray-700">New Balance</label>
                <input type="number" id="new-balance-input" class="input-field" placeholder="Enter new balance">
            </div>
            <div class="flex justify-end space-x-2">
                <button onclick="closeEditPointsModal()" class="btn bg-gray-200 text-gray-800">Cancel</button>
                <button onclick="saveUserPoints()" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- User Point History Modal -->
    <div id="user-point-history-modal" class="modal-overlay">
        <div class="modal" style="max-width: 800px;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Point History - <span id="history-user-name" class="text-gray-800"></span></h3>
                <button onclick="closePointHistoryModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="mb-4">
                <p class="text-gray-600">User ID: <span id="history-user-id" class="font-semibold text-gray-800"></span></p>
                <p class="text-gray-600">Current Balance: <span id="current-user-balance" class="font-semibold text-blue-600"></span></p>
                <p class="text-gray-600">Total Points Earned: <span id="total-points-earned" class="font-semibold text-green-600"></span></p>
                <p class="text-gray-600">Total Points Spent: <span id="total-points-spent" class="font-semibold text-red-600"></span></p>
            </div>
            <div class="overflow-y-auto max-h-96">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-2 text-gray-700">Date & Time</th>
                            <th class="px-4 py-2 text-gray-700">Task</th>
                            <th class="px-4 py-2 text-gray-700">Points</th>
                            <th class="px-4 py-2 text-gray-700">Country</th>
                            <th class="px-4 py-2 text-gray-700">Details</th>
                        </tr>
                    </thead>
                    <tbody id="user-point-history-body">
                        <!-- Point history will be loaded here -->
                    </tbody>
                </table>
            </div>
            <div class="mt-4 flex justify-end">
                <button onclick="closePointHistoryModal()" class="btn bg-gray-200 text-gray-800">Close</button>
            </div>
        </div>
    </div>

    <!-- User Details Modal -->
    <div id="user-details-modal" class="modal-overlay">
        <div class="modal" style="max-width: 600px;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">User Details</h3>
                <button onclick="closeUserDetailsModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="user-details-content" class="space-y-3">
                <!-- User details will be loaded here -->
            </div>
            <div class="mt-6 flex justify-end">
                <button onclick="closeUserDetailsModal()" class="btn bg-gray-200 text-gray-800">Close</button>
            </div>
        </div>
    </div>

    <!-- Custom Message Modal -->
    <div id="custom-message-modal" class="modal-overlay">
        <div class="modal custom-message-modal">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Send Custom Message</h3>
                <button onclick="closeCustomMessageModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <!-- Message Type Selection -->
                <div>
                    <label class="block font-semibold mb-2 text-gray-700">Message Type</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center">
                            <input type="radio" name="messageType" value="custom" checked onchange="toggleMessageType(this.value)" class="mr-2">
                            <span class="text-gray-700">Custom Message</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="messageType" value="payment" onchange="toggleMessageType(this.value)" class="mr-2">
                            <span class="text-gray-700">Payment Status</span>
                        </label>
                    </div>
                </div>
                
                <!-- Recipient Selection -->
                <div>
                    <label class="block font-semibold mb-2 text-gray-700">Send To</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center">
                            <input type="radio" name="recipientType" value="all" checked onchange="toggleRecipientType(this.value)" class="mr-2">
                            <span class="text-gray-700">All Users</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="recipientType" value="specific" onchange="toggleRecipientType(this.value)" class="mr-2">
                            <span class="text-gray-700">Specific User</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="recipientType" value="selected" onchange="toggleRecipientType(this.value)" class="mr-2">
                            <span class="text-gray-700">Selected Users</span>
                        </label>
                    </div>
                </div>
                
                <!-- Specific User Selection -->
                <div id="specific-user-section" class="hidden">
                    <label class="block font-semibold mb-2 text-gray-700">Select User</label>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="telegram-id-input" class="input-field" placeholder="Enter Telegram ID">
                        <button onclick="searchUserByTelegramId()" class="btn btn-secondary">Search</button>
                    </div>
                    <div id="user-search-result" class="mt-2 p-2 bg-gray-50 rounded hidden">
                        <!-- User search result will appear here -->
                    </div>
                </div>
                
                <!-- Selected Users Info -->
                <div id="selected-users-section" class="hidden">
                    <div class="p-3 bg-blue-50 rounded">
                        <p class="text-blue-700 font-semibold">
                            <i data-lucide="users" class="w-4 h-4 inline mr-1"></i>
                            <span id="selected-users-count">0</span> users selected
                        </p>
                    </div>
                </div>
                
                <!-- Payment Status Fields -->
                <div id="payment-fields" class="hidden">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block font-semibold mb-2 text-gray-700">Payment Status</label>
                            <select id="payment-status-select" class="input-field">
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                        <div>
                            <label class="block font-semibold mb-2 text-gray-700">Amount</label>
                            <input type="number" id="payment-amount" class="input-field" placeholder="Amount">
                        </div>
                    </div>
                    
                    <div id="rejection-reason-section" class="hidden">
                        <label class="block font-semibold mb-2 text-gray-700">Rejection Reason</label>
                        <textarea id="rejection-reason" class="input-field" rows="2" placeholder="Optional: Enter reason for rejection"></textarea>
                    </div>
                </div>
                
                <!-- Message Content -->
                <div>
                    <label class="block font-semibold mb-2 text-gray-700" id="message-title-label">Message Title</label>
                    <input type="text" id="custom-message-title" class="input-field" placeholder="Enter message title">
                </div>
                
                <div>
                    <label class="block font-semibold mb-2 text-gray-700" id="message-content-label">Message Content</label>
                    <textarea id="custom-message-content" class="input-field" rows="4" placeholder="Enter your message here..."></textarea>
                    <p class="text-sm text-gray-500 mt-1">
                        For payment status messages, the system will automatically include payment details.
                    </p>
                </div>
                
                <!-- Message Preview -->
                <div class="bg-gray-50 p-4 rounded border">
                    <label class="block font-semibold mb-2 text-gray-700">Preview</label>
                    <div id="message-preview" class="p-3 bg-white rounded border text-gray-700">
                        Your message preview will appear here...
                    </div>
                </div>
                
                <!-- Auto-dismiss Options -->
                <div class="feature-toggle">
                    <div>
                        <label class="feature-label text-gray-700">Auto-dismiss after 10 seconds</label>
                        <p class="text-sm text-gray-500">Message will auto-close if user doesn't click OK</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="auto-dismiss-toggle" checked>
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>
            
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="closeCustomMessageModal()" class="btn bg-gray-200 text-gray-800 px-6">Cancel</button>
                <button onclick="sendCustomMessage()" class="btn btn-primary px-6">Send Message</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBEvTvWy-hH1HHgjoOhUKkj-Dglm11Oc8U",
            authDomain: "cash-rewards-01-624ae.firebaseapp.com",
            projectId: "cash-rewards-01-624ae",
            storageBucket: "cash-rewards-01-624ae.firebasestorage.app",
            messagingSenderId: "29119912449",
            appId: "1:29119912449:web:e0c68c1994ff0a71603e00"
        };
        
        const ADMIN_UIDS = ["7IHZmOp2MGXG2u0wl98kgGgZwEE2"];

        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            updateDoc, 
            collection, 
            getDocs, 
            writeBatch, 
            enableIndexedDbPersistence, 
            query, 
            where, 
            onSnapshot, 
            addDoc, 
            serverTimestamp, 
            setDoc,
            orderBy,
            limit,
            arrayUnion,
            deleteDoc,
            arrayRemove
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Enable persistence
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') {
                console.warn('Firestore persistence failed: multiple tabs open.');
            } else if (err.code == 'unimplemented') {
                console.warn('Firestore persistence not available in this browser.');
            }
        });

        // DOM Elements
        const loader = document.getElementById('loader');
        const connectionStatus = document.getElementById('connection-status');
        let currentEditingUserId = null;
        let currentViewingUserId = null;
        let currentEditingGameId = null;
        let isConnected = false;
        let connectionCheckInterval;
        let selectedUsers = new Set(); // Track selected user IDs
        let allUsers = []; // Store all users for selection
        let sidebarCollapsed = false;
        let selectedTelegramId = null; // Store selected telegram ID for custom message

        // Initialize on load
        window.onload = () => {
            lucide.createIcons();
            setupEventListeners();
            checkFirebaseConnection();
            onAuthStateChanged(auth, handleAuthStateChange);
            
            // Setup mobile sidebar toggle
            setupMobileSidebar();
            
            // Setup message preview
            setupMessagePreview();
        };

        // Mobile sidebar setup
        function setupMobileSidebar() {
            const sidebar = document.querySelector('aside');
            const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
            
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768) {
                    if (!sidebar.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                        sidebar.classList.remove('active');
                    }
                }
            });
        }

        function toggleSidebar() {
            const sidebar = document.querySelector('aside');
            sidebar.classList.toggle('active');
        }

        // Firebase Connection Status Monitor
        async function checkFirebaseConnection() {
            updateConnectionStatus('connecting');
            
            try {
                // Test Firestore connection
                const testDoc = doc(db, "config", "connectionTest");
                await getDoc(testDoc).catch(() => {});
                
                // Test Auth connection
                await auth._initializationPromise;
                
                updateConnectionStatus('connected');
                console.log("✅ Firebase connected successfully!");
                
                // Start periodic connection checks
                if (connectionCheckInterval) {
                    clearInterval(connectionCheckInterval);
                }
                connectionCheckInterval = setInterval(monitorConnection, 10000);
                
            } catch (error) {
                console.error("❌ Firebase connection failed:", error);
                updateConnectionStatus('disconnected');
                
                // Try to reconnect every 5 seconds
                setTimeout(checkFirebaseConnection, 5000);
            }
        }

        function monitorConnection() {
            const testDoc = doc(db, "config", "connectionTest");
            getDoc(testDoc)
                .then(() => {
                    if (!isConnected) {
                        updateConnectionStatus('connected');
                    }
                })
                .catch(() => {
                    updateConnectionStatus('disconnected');
                    console.warn("⚠️ Connection lost, attempting to reconnect...");
                    checkFirebaseConnection();
                });
        }

        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connection-status');
            const icon = statusEl.querySelector('i');
            const text = statusEl.querySelector('span');
            
            statusEl.className = 'connection-status ' + status;
            
            switch(status) {
                case 'connected':
                    isConnected = true;
                    icon.setAttribute('data-lucide', 'wifi');
                    text.textContent = 'Admin Connected';
                    break;
                case 'disconnected':
                    isConnected = false;
                    icon.setAttribute('data-lucide', 'wifi-off');
                    text.textContent = 'Admin Disconnected';
                    break;
                case 'connecting':
                    isConnected = false;
                    icon.setAttribute('data-lucide', 'loader');
                    text.textContent = 'Connecting...';
                    break;
            }
            
            lucide.createIcons();
        }

        // Auth State Handler
        function handleAuthStateChange(user) {
            if (user && ADMIN_UIDS.includes(user.uid)) {
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('panel-section').style.display = 'block';
                navigateTo('dashboard');
                loadDashboardData();
                loadUsers();
                loadWithdrawals();
                loadSettings();
            } else {
                document.getElementById('auth-section').style.display = 'flex';
                document.getElementById('panel-section').style.display = 'none';
                if (user) {
                    signOut(auth);
                    showAlert("You are not authorized to access this panel.");
                }
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            
            // Navigation
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateTo(link.dataset.page);
                    
                    // Close sidebar on mobile after navigation
                    if (window.innerWidth <= 768) {
                        const sidebar = document.querySelector('aside');
                        sidebar.classList.remove('active');
                    }
                });
            });
            
            // Alert/Confirm buttons
            document.getElementById('alert-ok-btn').addEventListener('click', () => {
                document.getElementById('custom-alert').classList.add('hidden');
            });
            
            document.getElementById('confirm-cancel-btn').addEventListener('click', () => {
                document.getElementById('custom-confirm').classList.add('hidden');
            });
            
            // Search input listener
            const searchInput = document.getElementById('user-search-input');
            if (searchInput) {
                searchInput.addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') {
                        searchUsers();
                    }
                });
            }
            
            // Login form enter key support
            document.getElementById('login-email').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            
            document.getElementById('login-password').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            
            // Custom message input listeners for preview
            const titleInput = document.getElementById('custom-message-title');
            const contentInput = document.getElementById('custom-message-content');
            if (titleInput && contentInput) {
                titleInput.addEventListener('input', updateMessagePreview);
                contentInput.addEventListener('input', updateMessagePreview);
            }
            
            // Payment status select listener
            const paymentStatusSelect = document.getElementById('payment-status-select');
            if (paymentStatusSelect) {
                paymentStatusSelect.addEventListener('change', function() {
                    const rejectionReasonSection = document.getElementById('rejection-reason-section');
                    if (this.value === 'rejected') {
                        rejectionReasonSection.classList.remove('hidden');
                    } else {
                        rejectionReasonSection.classList.add('hidden');
                    }
                    updateMessagePreview();
                });
            }
            
            // Payment amount input listener
            const paymentAmountInput = document.getElementById('payment-amount');
            if (paymentAmountInput) {
                paymentAmountInput.addEventListener('input', updateMessagePreview);
            }
            
            // Rejection reason input listener
            const rejectionReasonInput = document.getElementById('rejection-reason');
            if (rejectionReasonInput) {
                rejectionReasonInput.addEventListener('input', updateMessagePreview);
            }
        }

        // Setup message preview
        function setupMessagePreview() {
            updateMessagePreview();
        }

        function updateMessagePreview() {
            const previewElement = document.getElementById('message-preview');
            if (!previewElement) return;
            
            const messageType = document.querySelector('input[name="messageType"]:checked').value;
            const title = document.getElementById('custom-message-title').value;
            const content = document.getElementById('custom-message-content').value;
            
            let preview = '';
            
            if (messageType === 'payment') {
                const status = document.getElementById('payment-status-select').value;
                const amount = document.getElementById('payment-amount').value;
                const reason = document.getElementById('rejection-reason').value;
                
                preview = `<div class="font-bold mb-2">${title || 'Payment Status Update'}</div>`;
                preview += `<div class="mb-2">${content || 'Your withdrawal request has been processed.'}</div>`;
                
                if (amount) {
                    preview += `<div class="mb-2"><strong>Amount:</strong> ${amount} points</div>`;
                }
                
                preview += `<div class="mb-2"><strong>Status:</strong> <span class="${status === 'approved' ? 'text-green-600' : 'text-red-600'} font-bold">${status.toUpperCase()}</span></div>`;
                
                if (status === 'rejected' && reason) {
                    preview += `<div class="mb-2"><strong>Reason:</strong> ${reason}</div>`;
                }
                
                preview += `<div class="mt-3 text-sm text-gray-500">Click OK to close this message</div>`;
            } else {
                preview = `<div class="font-bold mb-2">${title || 'New Message'}</div>`;
                preview += `<div class="mb-2">${content || 'Your message content will appear here...'}</div>`;
                preview += `<div class="mt-3 text-sm text-gray-500">Click OK to close this message</div>`;
            }
            
            previewElement.innerHTML = preview;
        }

        function toggleMessageType(type) {
            const paymentFields = document.getElementById('payment-fields');
            const messageTitleLabel = document.getElementById('message-title-label');
            const messageContentLabel = document.getElementById('message-content-label');
            
            if (type === 'payment') {
                paymentFields.classList.remove('hidden');
                messageTitleLabel.textContent = 'Payment Title';
                messageContentLabel.textContent = 'Payment Message';
                
                // Set default values for payment message
                document.getElementById('custom-message-title').value = 'Withdrawal Status Update';
                document.getElementById('custom-message-content').value = 'Your withdrawal request has been processed.';
            } else {
                paymentFields.classList.add('hidden');
                messageTitleLabel.textContent = 'Message Title';
                messageContentLabel.textContent = 'Message Content';
                
                // Clear payment-specific fields
                document.getElementById('custom-message-title').value = '';
                document.getElementById('custom-message-content').value = '';
            }
            
            updateMessagePreview();
        }

        function toggleRecipientType(type) {
            const specificUserSection = document.getElementById('specific-user-section');
            const selectedUsersSection = document.getElementById('selected-users-section');
            
            if (type === 'specific') {
                specificUserSection.classList.remove('hidden');
                selectedUsersSection.classList.add('hidden');
            } else if (type === 'selected') {
                specificUserSection.classList.add('hidden');
                selectedUsersSection.classList.remove('hidden');
                updateSelectedUsersCount();
            } else {
                specificUserSection.classList.add('hidden');
                selectedUsersSection.classList.add('hidden');
            }
        }

        function updateSelectedUsersCount() {
            const countElement = document.getElementById('selected-users-count');
            if (countElement) {
                countElement.textContent = selectedUsers.size;
            }
        }

        // Login Handler
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = '';
            
            if (!email || !password) {
                errorEl.textContent = "Please enter both email and password.";
                return;
            }
            
            if (!isConnected) {
                errorEl.textContent = "Cannot connect to database. Please check your internet connection.";
                return;
            }
            
            loader.style.display = 'flex';
            
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                if (!ADMIN_UIDS.includes(userCredential.user.uid)) {
                    await signOut(auth);
                    showAlert("You are not authorized to access this panel.");
                }
            } catch (error) {
                errorEl.textContent = "Invalid email or password.";
                console.error("Login error:", error);
            } finally {
                loader.style.display = 'none';
            }
        }

        // Navigation
        function navigateTo(pageId) {
            document.querySelectorAll('.admin-page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            document.querySelector(`.sidebar-link[data-page="${pageId}"]`).classList.add('active');

            if (pageId === 'dashboard') loadDashboard();
            if (pageId === 'users') loadUsers();
            if (pageId === 'withdrawals') loadWithdrawals();
            if (pageId === 'custom-messages') loadCustomMessages();
            if (pageId === 'games') loadGames();
            if (pageId === 'adnetwork') loadAdNetwork();
            if (pageId === 'notifications') loadNotifications();
            if (pageId === 'settings') loadSettings();
        }

        // Dashboard Functions
        async function loadDashboard() {
            const page = document.getElementById('dashboard');
            page.innerHTML = `
                <h1 class="text-3xl font-bold mb-6 text-gray-800">Dashboard</h1>
                <div id="stats-grid" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="stat-card p-6">
                        <h3 class="text-gray-600 text-lg">Total Users</h3>
                        <p id="total-users" class="text-4xl font-bold mt-2 text-gray-800">0</p>
                    </div>
                    <div class="stat-card p-6">
                        <h3 class="text-gray-600 text-lg">Total Withdrawals</h3>
                        <p id="total-withdrawals" class="text-4xl font-bold mt-2 text-gray-800">0</p>
                    </div>
                    <div class="stat-card p-6">
                        <h3 class="text-gray-600 text-lg">Pending Withdrawals</h3>
                        <p id="pending-withdrawals" class="text-4xl font-bold text-orange-500 mt-2">0</p>
                    </div>
                    <div class="stat-card p-6">
                        <h3 class="text-gray-600 text-lg">Today's Earnings</h3>
                        <p id="today-earnings" class="text-4xl font-bold text-green-600 mt-2">0</p>
                    </div>
                </div>
                <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">Recent Withdrawals</h2>
                        <div id="recent-withdrawals" class="bg-white shadow rounded-lg p-4">
                            Loading...
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">Recent Users</h2>
                        <div id="recent-users" class="bg-white shadow rounded-lg p-4">
                            Loading...
                        </div>
                    </div>
                </div>
                <div class="mt-8">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Game Statistics</h2>
                    <div id="game-stats" class="bg-white shadow rounded-lg p-4">
                        Loading...
                    </div>
                </div>
            `;
            
            // Load real-time data
            loadDashboardData();
        }

        function loadDashboardData() {
            // Total Users (real-time)
            onSnapshot(collection(db, "users"), snap => {
                document.getElementById('total-users').textContent = snap.size;
            });

            // Total Withdrawals (real-time)
            onSnapshot(collection(db, "withdrawals"), snap => {
                document.getElementById('total-withdrawals').textContent = snap.size;
            });

            // Pending Withdrawals (real-time)
            onSnapshot(query(collection(db, "withdrawals"), where("status", "==", "pending")), snap => {
                document.getElementById('pending-withdrawals').textContent = snap.size;
            });

            // Load recent data
            loadRecentWithdrawals();
            loadRecentUsers();
            loadTodayEarnings();
            loadGameStats();
        }

        async function loadRecentWithdrawals() {
            const withdrawalsSnap = await getDocs(query(
                collection(db, "withdrawals"), 
                orderBy("requestedAt", "desc"), 
                limit(5)
            ));
            
            let html = `<table class="w-full">
                <thead><tr>
                    <th class="text-gray-700">User</th>
                    <th class="text-gray-700">Amount</th>
                    <th class="text-gray-700">Status</th>
                    <th class="text-gray-700">Date</th>
                </tr></thead>
                <tbody>`;
            
            if (withdrawalsSnap.empty) {
                html += `<tr><td colspan="4" class="text-center py-4 text-gray-500">No recent withdrawals</td></tr>`;
            } else {
                withdrawalsSnap.forEach(doc => {
                    const req = doc.data();
                    const date = req.requestedAt?.toDate().toLocaleDateString() || 'N/A';
                    const statusClass = req.status === 'approved' ? 'status-approved' : 
                                      req.status === 'pending' ? 'status-pending' : 'status-rejected';
                    html += `<tr class="border-b">
                        <td class="py-2 text-gray-700">${req.userName || 'N/A'}</td>
                        <td class="py-2 font-semibold text-gray-700">${req.amount}</td>
                        <td class="py-2"><span class="status-badge ${statusClass}">${req.status}</span></td>
                        <td class="py-2 text-gray-500 text-sm">${date}</td>
                    </tr>`;
                });
            }
            
            html += `</tbody></table>`;
            document.getElementById('recent-withdrawals').innerHTML = html;
        }

        async function loadRecentUsers() {
            const usersSnap = await getDocs(query(
                collection(db, "users"), 
                orderBy("createdAt", "desc"), 
                limit(5)
            ));
            
            let html = `<table class="w-full">
                <thead><tr>
                    <th class="text-gray-700">Telegram ID</th>
                    <th class="text-gray-700">Username</th>
                    <th class="text-gray-700">Balance</th>
                    <th class="text-gray-700">Status</th>
                </tr></thead>
                <tbody>`;
            
            if (usersSnap.empty) {
                html += `<tr><td colspan="4" class="text-center py-4 text-gray-500">No users found</td></tr>`;
            } else {
                usersSnap.forEach(doc => {
                    const user = doc.data();
                    const isActive = user.isActive !== false;
                    const statusClass = isActive ? 'active' : 'inactive';
                    html += `<tr class="border-b">
                        <td class="py-2 text-gray-700">${user.telegramId || 'N/A'}</td>
                        <td class="py-2 text-gray-700">${user.telegramUsername || 'N/A'}</td>
                        <td class="py-2 font-semibold text-gray-700">${parseFloat(user.balance || 0).toFixed(2)}</td>
                        <td class="py-2"><span class="status-badge ${statusClass}">${isActive ? 'Active' : 'Inactive'}</span></td>
                    </tr>`;
                });
            }
            
            html += `</tbody></table>`;
            document.getElementById('recent-users').innerHTML = html;
        }

        async function loadTodayEarnings() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const pointHistorySnap = await getDocs(query(
                collection(db, "pointHistory"),
                where("timestamp", ">=", today)
            ));
            
            let totalEarnings = 0;
            pointHistorySnap.forEach(doc => {
                const history = doc.data();
                if (history.points > 0) {
                    totalEarnings += history.points;
                }
            });
            
            document.getElementById('today-earnings').textContent = totalEarnings;
        }

        async function loadGameStats() {
            try {
                // Get game configuration
                const gamesSnap = await getDoc(doc(db, "config", "games"));
                const gamesConfig = gamesSnap.exists() ? gamesSnap.data() : {};
                
                // Get today's game play data
                const today = new Date().toISOString().split('T')[0];
                const todayStats = gamesConfig.dailyStats?.[today] || {};
                
                let html = '<div class="grid grid-cols-1 md:grid-cols-4 gap-4">';
                
                // Games list including Try Your Luck
                const games = [
                    { id: 'colorGame', name: 'Color Game', icon: 'palette', color: 'bg-purple-500' },
                    { id: 'watchVideo', name: 'Watch Video', icon: 'video', color: 'bg-blue-500' },
                    { id: 'ludoDice', name: 'Ludo Dice', icon: 'dice-5', color: 'bg-green-500' },
                    { id: 'tryYourLuck', name: 'Try Your Luck', icon: 'star', color: 'bg-yellow-500' }
                ];
                
                games.forEach(game => {
                    const gameData = gamesConfig[game.id] || {};
                    const gameStats = todayStats[game.id] || { playCount: 0, totalPlays: 0, userCount: 0 };
                    const isVisible = gameData.visible !== false;
                    
                    html += `
                        <div class="game-card">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center">
                                    <div class="${game.color} text-white p-2 rounded-lg mr-3">
                                        <i data-lucide="${game.icon}" class="w-5 h-5"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-gray-800">${game.name}</h3>
                                        <p class="text-sm text-gray-500">${isVisible ? 'Visible' : 'Hidden'}</p>
                                    </div>
                                </div>
                                <span class="status-badge ${isVisible ? 'status-visible' : 'status-hidden'}">
                                    ${isVisible ? 'Visible' : 'Hidden'}
                                </span>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3 mt-4">
                                <div>
                                    <p class="text-sm text-gray-500">Today's Plays</p>
                                    <p class="font-bold text-lg text-gray-800">${gameStats.playCount || 0}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Total Users</p>
                                    <p class="font-bold text-lg text-gray-800">${gameStats.userCount || 0}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Daily Limit</p>
                                    <p class="font-bold text-lg text-gray-800">${gameData.dailyPlayLimit > 0 ? `${gameData.dailyPlayLimit} plays` : 'Unlimited'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Reward</p>
                                    <p class="font-bold text-lg text-gray-800">${gameData.rewardPerPlay || 0} pts</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                document.getElementById('game-stats').innerHTML = html;
                lucide.createIcons();
            } catch (error) {
                console.error("Error loading game stats:", error);
                document.getElementById('game-stats').innerHTML = 
                    `<p class="text-center text-gray-500">Error loading game statistics</p>`;
            }
        }

        // ===== UPDATED USER MANAGEMENT FUNCTIONS =====
        async function loadUsersForAdmin() {
            try {
                const usersRef = collection(db, "users");
                const querySnapshot = await getDocs(usersRef);
                
                const users = [];
                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    
                    // Only include users with telegramId (filter out browser users)
                    if (userData.telegramId && userData.userType === 'telegram') {
                        users.push({
                            id: userData.telegramId || doc.id,
                            telegramId: userData.telegramId,
                            username: userData.telegramUsername || '-',
                            firstName: userData.telegramFirstName || '',
                            lastName: userData.telegramLastName || '-',
                            balance: parseFloat(userData.balance || 0).toFixed(2),
                            isActive: userData.isActive !== false,
                            isStaff: userData.isStaff === true,
                            createdAt: userData.createdAt?.toDate() || new Date(),
                            uid: doc.id,
                            userType: userData.userType || 'unknown'
                        });
                    }
                });
                
                // Sort by creation date (newest first)
                users.sort((a, b) => b.createdAt - a.createdAt);
                
                // Store users for selection
                allUsers = users;
                
                displayUsersInAdminPanel(users);
                
            } catch (error) {
                console.error("Error loading users:", error);
                document.getElementById('users-table-body').innerHTML = 
                    `<tr><td colspan="10" class="text-center py-4 text-red-500">Error loading users: ${error.message}</td></tr>`;
            }
        }

        function displayUsersInAdminPanel(users) {
            const tableBody = document.getElementById('users-table-body');
            tableBody.innerHTML = '';
            
            if (users.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-gray-500">No Telegram users found</td></tr>`;
                return;
            }
            
            users.forEach((user, index) => {
                const row = document.createElement('tr');
                row.className = 'user-row';
                row.id = `user-row-${user.uid}`;
                
                // Format date
                const createdAt = new Date(user.createdAt);
                const formattedDate = createdAt.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                // Check if user is selected
                const isSelected = selectedUsers.has(user.uid);
                
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="user-select-checkbox" data-user-id="${user.uid}" 
                               ${isSelected ? 'checked' : ''} onchange="toggleUserSelection('${user.uid}', this.checked)">
                    </td>
                    <td>${index + 1}</td>
                    <td>${user.telegramId || '-'}</td>
                    <td>${user.username || '-'}</td>
                    <td>${user.firstName || '-'}</td>
                    <td>${parseFloat(user.balance).toFixed(2)}</td>
                    <td>
                        <span class="status-badge ${user.isActive ? 'active' : 'inactive'}">
                            ${user.isActive ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${user.isStaff ? 'staff' : 'not-staff'}">
                            ${user.isStaff ? 'Yes' : 'No'}
                        </span>
                    </td>
                    <td>${formattedDate}</td>
                    <td>
                        <button onclick="editUserPoints('${user.uid}')" class="btn-edit">Edit Points</button>
                        <button onclick="toggleActive('${user.uid}', ${!user.isActive})" class="btn-toggle">
                            ${user.isActive ? 'Deactivate' : 'Activate'}
                        </button>
                        <button onclick="viewUserDetails('${user.uid}')" class="btn-view">View</button>
                        <button onclick="deleteUser('${user.uid}')" class="btn-delete">Delete</button>
                        <button onclick="sendDirectMessage('${user.telegramId}', '${user.username}', '${user.uid}')" class="btn btn-primary btn-sm">Message</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Update selected count
            updateSelectedCount();
            updateSelectedUsersCount();
            
            lucide.createIcons();
        }

        // Toggle user selection
        function toggleUserSelection(userId, isSelected) {
            if (isSelected) {
                selectedUsers.add(userId);
            } else {
                selectedUsers.delete(userId);
            }
            
            // Update row appearance
            const row = document.getElementById(`user-row-${userId}`);
            if (row) {
                if (isSelected) {
                    row.classList.add('selected');
                } else {
                    row.classList.remove('selected');
                }
            }
            
            updateSelectedCount();
            updateSelectedUsersCount();
        }

        // Toggle select all users
        function toggleSelectAllUsers(selectAll) {
            selectedUsers.clear();
            
            if (selectAll) {
                allUsers.forEach(user => {
                    selectedUsers.add(user.uid);
                });
            }
            
            // Update all checkboxes
            document.querySelectorAll('.user-select-checkbox').forEach(checkbox => {
                checkbox.checked = selectAll;
                const userId = checkbox.dataset.userId;
                const row = document.getElementById(`user-row-${userId}`);
                if (row) {
                    if (selectAll) {
                        row.classList.add('selected');
                    } else {
                        row.classList.remove('selected');
                    }
                }
            });
            
            updateSelectedCount();
            updateSelectedUsersCount();
        }

        // Toggle table select all
        function toggleTableSelectAll(selectAll) {
            document.getElementById('select-all-users').checked = selectAll;
            toggleSelectAllUsers(selectAll);
        }

        // Update selected count display
        function updateSelectedCount() {
            const count = selectedUsers.size;
            const countElement = document.getElementById('selected-count');
            if (countElement) {
                countElement.textContent = `${count} user${count !== 1 ? 's' : ''} selected`;
            }
        }

        // Delete selected users
        async function deleteSelectedUsers() {
            if (selectedUsers.size === 0) {
                showAlert("Please select users to delete.");
                return;
            }
            
            showConfirm(`Are you sure you want to delete ${selectedUsers.size} selected user(s)? This action cannot be undone.`, async () => {
                loader.style.display = 'flex';
                try {
                    const batch = writeBatch(db);
                    
                    // Delete each selected user
                    for (const userId of selectedUsers) {
                        const userRef = doc(db, "users", userId);
                        batch.delete(userRef);
                        
                        // Also delete user's point history
                        const pointHistoryQuery = query(collection(db, "pointHistory"), where("userId", "==", userId));
                        const pointHistorySnap = await getDocs(pointHistoryQuery);
                        pointHistorySnap.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                    }
                    
                    await batch.commit();
                    
                    showToast(`✅ Successfully deleted ${selectedUsers.size} user(s)!`);
                    
                    // Clear selection and refresh
                    selectedUsers.clear();
                    loadUsersForAdmin();
                    
                } catch (error) {
                    console.error("Error deleting users:", error);
                    showAlert("❌ Error deleting users: " + error.message, true);
                } finally {
                    loader.style.display = 'none';
                }
            });
        }

        // Delete single user
        async function deleteUser(userId) {
            showConfirm("Are you sure you want to delete this user? This action cannot be undone.", async () => {
                loader.style.display = 'flex';
                try {
                    // Delete user document
                    await deleteDoc(doc(db, "users", userId));
                    
                    // Delete user's point history
                    const pointHistoryQuery = query(collection(db, "pointHistory"), where("userId", "==", userId));
                    const pointHistorySnap = await getDocs(pointHistoryQuery);
                    const batch = writeBatch(db);
                    pointHistorySnap.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    
                    showToast("✅ User deleted successfully!");
                    
                    // Remove from selection if selected
                    selectedUsers.delete(userId);
                    updateSelectedCount();
                    
                    // Refresh user list
                    loadUsersForAdmin();
                    
                } catch (error) {
                    console.error("Error deleting user:", error);
                    showAlert("❌ Error deleting user: " + error.message, true);
                } finally {
                    loader.style.display = 'none';
                }
            });
        }

        // Toggle user active status
        async function toggleActive(userId, newStatus) {
            try {
                const userRef = doc(db, "users", userId);
                await updateDoc(userRef, {
                    isActive: newStatus,
                    updatedAt: serverTimestamp()
                });
                
                showToast(`User ${newStatus ? 'activated' : 'deactivated'} successfully!`);
                loadUsersForAdmin(); // Refresh the list
            } catch (error) {
                console.error("Error updating user:", error);
                showAlert("Error updating user status", true);
            }
        }

        // Edit user points
        async function editUserPoints(userId) {
            const userRef = doc(db, "users", userId);
            const userSnap = await getDoc(userRef);
            
            if (userSnap.exists()) {
                const userData = userSnap.data();
                
                currentEditingUserId = userId;
                
                document.getElementById('edit-user-name').textContent = userData.telegramUsername || userData.telegramFirstName || 'N/A';
                document.getElementById('edit-user-telegram').textContent = userData.telegramId || 'N/A';
                document.getElementById('edit-current-balance').textContent = parseFloat(userData.balance || 0).toFixed(2);
                document.getElementById('new-balance-input').value = parseFloat(userData.balance || 0).toFixed(2);
                
                document.getElementById('edit-points-modal').style.display = 'flex';
            }
        }

        async function saveUserPoints() {
            if (!currentEditingUserId) return;
            
            const newBalance = parseFloat(document.getElementById('new-balance-input').value);
            
            if (isNaN(newBalance)) {
                showAlert("Please enter a valid number for balance.");
                return;
            }
            
            loader.style.display = 'flex';
            try {
                const userRef = doc(db, "users", currentEditingUserId);
                const userSnap = await getDoc(userRef);
                const userData = userSnap.data();
                
                const oldBalance = parseFloat(userData.balance || 0);
                const balanceChange = newBalance - oldBalance;
                
                // Update user balance
                await updateDoc(userRef, {
                    balance: newBalance,
                    updatedAt: serverTimestamp()
                });
                
                // Add point history entry for admin adjustment
                if (balanceChange !== 0) {
                    await addDoc(collection(db, "pointHistory"), {
                        userId: currentEditingUserId,
                        userName: userData.telegramUsername || userData.telegramFirstName || 'Unknown',
                        taskType: 'admin_adjustment',
                        points: balanceChange,
                        details: `Admin adjusted balance from ${oldBalance.toFixed(2)} to ${newBalance.toFixed(2)}`,
                        timestamp: serverTimestamp(),
                        country: 'N/A'
                    });
                }
                
                showToast("✅ User balance updated successfully!");
                closeEditPointsModal();
                loadUsersForAdmin();
                
            } catch (error) {
                console.error("Error updating user points:", error);
                showAlert("❌ Error updating balance: " + error.message, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        function closeEditPointsModal() {
            document.getElementById('edit-points-modal').style.display = 'none';
            currentEditingUserId = null;
        }

        // View user details
        async function viewUserDetails(userId) {
            const userRef = doc(db, "users", userId);
            const userSnap = await getDoc(userRef);
            
            if (userSnap.exists()) {
                const userData = userSnap.data();
                
                // Format date
                const createdAt = userData.createdAt?.toDate();
                const formattedCreatedAt = createdAt ? createdAt.toLocaleString() : 'N/A';
                
                const lastLogin = userData.lastLogin?.toDate();
                const formattedLastLogin = lastLogin ? lastLogin.toLocaleString() : 'Never';
                
                // Show detailed view modal
                const detailsContent = `
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="font-semibold text-gray-700">Telegram ID:</p>
                            <p class="text-gray-800">${userData.telegramId || 'N/A'}</p>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-700">Username:</p>
                            <p class="text-gray-800">${userData.telegramUsername || 'N/A'}</p>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-700">First Name:</p>
                            <p class="text-gray-800">${userData.telegramFirstName || ''}</p>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-700">Last Name:</p>
                            <p class="text-gray-800">${userData.telegramLastName || ''}</p>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-700">Balance:</p>
                            <p class="text-gray-800 font-bold">${parseFloat(userData.balance || 0).toFixed(2)}</p>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-700">User Type:</p>
                            <p class="text-gray-800">${userData.userType || 'unknown'}</p>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-700">Is Active:</p>
                            <p class="text-gray-800">${userData.isActive !== false ? 'Yes' : 'No'}</p>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-700">Is Staff:</p>
                            <p class="text-gray-800">${userData.isStaff === true ? 'Yes' : 'No'}</p>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-700">Created:</p>
                            <p class="text-gray-800">${formattedCreatedAt}</p>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-700">Last Login:</p>
                            <p class="text-gray-800">${formattedLastLogin}</p>
                        </div>
                        <div class="col-span-2">
                            <p class="font-semibold text-gray-700">Total Earned:</p>
                            <p class="text-gray-800">${userData.totalEarned || 0}</p>
                        </div>
                        <div class="col-span-2">
                            <p class="font-semibold text-gray-700">Tasks Completed:</p>
                            <p class="text-gray-800">${userData.tasksCompleted || 0}</p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button onclick="sendDirectMessage('${userData.telegramId}', '${userData.telegramUsername || userData.telegramFirstName}', '${userId}')" class="btn btn-primary w-full">
                            <i data-lucide="send" class="w-4 h-4 mr-2"></i> Send Message to this User
                        </button>
                    </div>
                `;
                
                document.getElementById('user-details-content').innerHTML = detailsContent;
                document.getElementById('user-details-modal').style.display = 'flex';
                lucide.createIcons();
            } else {
                showAlert("User not found", true);
            }
        }

        function closeUserDetailsModal() {
            document.getElementById('user-details-modal').style.display = 'none';
        }

        // Search users function
        async function searchUsers() {
            const searchTerm = document.getElementById('user-search-input').value.toLowerCase();
            
            try {
                const usersRef = collection(db, "users");
                const querySnapshot = await getDocs(usersRef);
                
                const users = [];
                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    
                    // Check if user matches search term and is a Telegram user
                    const matchesSearch = 
                        (userData.telegramId && userData.telegramId.toLowerCase().includes(searchTerm)) ||
                        (userData.telegramUsername && userData.telegramUsername.toLowerCase().includes(searchTerm)) ||
                        (userData.telegramFirstName && userData.telegramFirstName.toLowerCase().includes(searchTerm)) ||
                        (userData.telegramLastName && userData.telegramLastName.toLowerCase().includes(searchTerm));
                    
                    if ((matchesSearch || !searchTerm) && userData.telegramId && userData.userType === 'telegram') {
                        users.push({
                            id: userData.telegramId || doc.id,
                            telegramId: userData.telegramId,
                            username: userData.telegramUsername || '-',
                            firstName: userData.telegramFirstName || '',
                            lastName: userData.telegramLastName || '-',
                            balance: parseFloat(userData.balance || 0).toFixed(2),
                            isActive: userData.isActive !== false,
                            isStaff: userData.isStaff === true,
                            createdAt: userData.createdAt?.toDate() || new Date(),
                            uid: doc.id,
                            userType: userData.userType || 'unknown'
                        });
                    }
                });
                
                // Sort by creation date (newest first)
                users.sort((a, b) => b.createdAt - a.createdAt);
                
                // Store users for selection
                allUsers = users;
                
                displayUsersInAdminPanel(users);
                
            } catch (error) {
                console.error("Error searching users:", error);
                showAlert("Error searching users", true);
            }
        }

        // Migration Script for Existing Users
        async function migrateExistingUsers() {
            showConfirm("Are you sure you want to migrate existing users to the new structure? This will update all users with Telegram IDs.", async () => {
                loader.style.display = 'flex';
                try {
                    const usersRef = collection(db, "users");
                    const querySnapshot = await getDocs(usersRef);
                    
                    let migrated = 0;
                    const batch = writeBatch(db);
                    
                    querySnapshot.forEach((doc) => {
                        const userData = doc.data();
                        const updates = {};
                        
                        // Check if user needs migration
                        if (!userData.telegramId && doc.id.startsWith('tg_')) {
                            // Extract Telegram ID from uid
                            const telegramId = doc.id.replace('tg_', '');
                            updates.telegramId = telegramId;
                            
                            // Add other missing fields
                            if (userData.balance === undefined) updates.balance = 0.00;
                            if (userData.isActive === undefined) updates.isActive = true;
                            if (userData.isStaff === undefined) updates.isStaff = false;
                            if (userData.userType === undefined) updates.userType = 'telegram';
                            
                            // Update the document
                            batch.update(doc.ref, updates);
                            migrated++;
                        }
                    });
                    
                    await batch.commit();
                    console.log(`✅ Migrated ${migrated} users to new structure`);
                    showToast(`Migrated ${migrated} users successfully!`);
                    
                    // Refresh the user list
                    loadUsersForAdmin();
                    
                } catch (error) {
                    console.error("Migration error:", error);
                    showAlert("Migration failed: " + error.message, true);
                } finally {
                    loader.style.display = 'none';
                }
            });
        }

        // Simplified loadUsers function
        async function loadUsers() {
            // Page structure is already in HTML, just load the data
            loadUsersForAdmin();
        }

        // ===== FIXED CUSTOM MESSAGES FUNCTIONS =====
        async function loadCustomMessages() {
            const page = document.getElementById('custom-messages');
            page.innerHTML = `
                <h1 class="text-3xl font-bold mb-6 text-gray-800">Custom Messages Management</h1>
                
                <div class="bg-white shadow rounded-lg p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">Send Custom Message</h2>
                    <p class="text-gray-600 mb-4">Send messages to users that will appear as popups when they login to the mini-app.</p>
                    <button onclick="openCustomMessageModal()" class="btn btn-primary">
                        <i data-lucide="send" class="w-4 h-4 mr-2"></i> Send New Message
                    </button>
                </div>
                
                <div class="bg-white shadow rounded-lg p-6">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">Message History</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th class="text-gray-700">Title</th>
                                    <th class="text-gray-700">Type</th>
                                    <th class="text-gray-700">Recipient</th>
                                    <th class="text-gray-700">Sent At</th>
                                    <th class="text-gray-700">Status</th>
                                    <th class="text-gray-700">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="custom-messages-history">
                                <tr><td colspan="6" class="text-center py-4 text-gray-500">Loading messages...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            await loadCustomMessagesHistory();
        }

        function openCustomMessageModal() {
            // Reset form
            document.getElementById('custom-message-title').value = '';
            document.getElementById('custom-message-content').value = '';
            document.getElementById('payment-amount').value = '';
            document.getElementById('rejection-reason').value = '';
            document.getElementById('telegram-id-input').value = '';
            document.getElementById('user-search-result').innerHTML = '';
            document.getElementById('user-search-result').classList.add('hidden');
            
            // Reset radio buttons
            document.querySelector('input[name="messageType"][value="custom"]').checked = true;
            document.querySelector('input[name="recipientType"][value="all"]').checked = true;
            
            // Toggle sections
            toggleMessageType('custom');
            toggleRecipientType('all');
            
            // Show modal
            document.getElementById('custom-message-modal').style.display = 'flex';
        }

        function openCustomMessageModalFromUsers() {
            openCustomMessageModal();
            
            // Set to selected users if any are selected
            if (selectedUsers.size > 0) {
                document.querySelector('input[name="recipientType"][value="selected"]').checked = true;
                toggleRecipientType('selected');
            }
        }

        function closeCustomMessageModal() {
            document.getElementById('custom-message-modal').style.display = 'none';
            selectedTelegramId = null;
        }

        // FIXED: searchUserByTelegramId function
        async function searchUserByTelegramId() {
            const telegramId = document.getElementById('telegram-id-input').value.trim();
            if (!telegramId) {
                showAlert("Please enter a Telegram ID.");
                return;
            }
            
            loader.style.display = 'flex';
            try {
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("telegramId", "==", telegramId));
                const querySnapshot = await getDocs(q);
                
                const resultDiv = document.getElementById('user-search-result');
                resultDiv.innerHTML = '';
                
                if (querySnapshot.empty) {
                    // Try alternative search methods
                    const allUsersQuery = await getDocs(usersRef);
                    let foundUser = null;
                    
                    allUsersQuery.forEach(doc => {
                        const userData = doc.data();
                        // Check if user has this telegramId OR if uid contains the telegramId
                        if (userData.telegramId === telegramId || 
                            doc.id.includes(telegramId) || 
                            (userData.telegramUsername && userData.telegramUsername.includes(telegramId))) {
                            foundUser = { id: doc.id, data: userData };
                        }
                    });
                    
                    if (foundUser) {
                        selectedTelegramId = foundUser.data.telegramId || telegramId;
                        resultDiv.innerHTML = `
                            <div class="text-green-600 p-2 bg-green-50 rounded">
                                <div class="font-semibold">User Found:</div>
                                <div>Name: ${foundUser.data.telegramFirstName || ''} ${foundUser.data.telegramLastName || ''}</div>
                                <div>Username: @${foundUser.data.telegramUsername || 'N/A'}</div>
                                <div>Telegram ID: ${foundUser.data.telegramId || 'Not set'}</div>
                                <div>Balance: ${foundUser.data.balance || 0} points</div>
                                <div class="text-sm text-gray-500">User ID: ${foundUser.id}</div>
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `<div class="text-red-600 p-2">No user found with Telegram ID: ${telegramId}</div>`;
                        selectedTelegramId = null;
                    }
                } else {
                    querySnapshot.forEach(doc => {
                        const userData = doc.data();
                        selectedTelegramId = telegramId;
                        resultDiv.innerHTML = `
                            <div class="text-green-600 p-2 bg-green-50 rounded">
                                <div class="font-semibold">User Found:</div>
                                <div>Name: ${userData.telegramFirstName || ''} ${userData.telegramLastName || ''}</div>
                                <div>Username: @${userData.telegramUsername || 'N/A'}</div>
                                <div>Balance: ${userData.balance || 0} points</div>
                                <div class="text-sm text-gray-500">User ID: ${doc.id}</div>
                            </div>
                        `;
                    });
                }
                
                resultDiv.classList.remove('hidden');
                
            } catch (error) {
                console.error("Error searching user:", error);
                showAlert("❌ Error searching user: " + error.message, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        // FIXED: sendCustomMessage function
        async function sendCustomMessage() {
            const messageType = document.querySelector('input[name="messageType"]:checked').value;
            const recipientType = document.querySelector('input[name="recipientType"]:checked').value;
            const title = document.getElementById('custom-message-title').value.trim();
            const content = document.getElementById('custom-message-content').value.trim();
            const autoDismiss = document.getElementById('auto-dismiss-toggle').checked;
            
            if (!title || !content) {
                showAlert("Please enter both title and message content.");
                return;
            }
            
            loader.style.display = 'flex';
            try {
                let recipients = [];
                
                if (recipientType === 'all') {
                    // Get all users with telegramId
                    const usersSnap = await getDocs(collection(db, "users"));
                    usersSnap.forEach(doc => {
                        const userData = doc.data();
                        if (userData.telegramId) {
                            recipients.push({
                                userId: doc.id,
                                telegramId: userData.telegramId,
                                name: userData.telegramUsername || userData.telegramFirstName || 'Unknown'
                            });
                        }
                    });
                } else if (recipientType === 'specific') {
                    // Use selected telegram ID directly
                    if (!selectedTelegramId) {
                        // Try to get user from input
                        const telegramId = document.getElementById('telegram-id-input').value.trim();
                        if (!telegramId) {
                            showAlert("Please enter a Telegram ID.");
                            return;
                        }
                        
                        // Find user with this telegramId
                        const usersRef = collection(db, "users");
                        const q = query(usersRef, where("telegramId", "==", telegramId));
                        const querySnapshot = await getDocs(q);
                        
                        if (querySnapshot.empty) {
                            showAlert("User not found. Please search for user first.");
                            return;
                        }
                        
                        querySnapshot.forEach(doc => {
                            const userData = doc.data();
                            recipients.push({
                                userId: doc.id,
                                telegramId: userData.telegramId || telegramId,
                                name: userData.telegramUsername || userData.telegramFirstName || 'Unknown'
                            });
                        });
                    } else {
                        // Use the already selected user
                        recipients.push({
                            userId: 'unknown', // We'll find it
                            telegramId: selectedTelegramId,
                            name: 'Selected User'
                        });
                    }
                } else if (recipientType === 'selected') {
                    // Get selected users from the user table
                    if (selectedUsers.size === 0) {
                        showAlert("Please select users from the user management page first.");
                        return;
                    }
                    
                    for (const userId of selectedUsers) {
                        const userDoc = await getDoc(doc(db, "users", userId));
                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            if (userData.telegramId) {
                                recipients.push({
                                    userId: userId,
                                    telegramId: userData.telegramId,
                                    name: userData.telegramUsername || userData.telegramFirstName || 'Unknown'
                                });
                            }
                        }
                    }
                }
                
                if (recipients.length === 0) {
                    showAlert("No recipients found with Telegram IDs.");
                    return;
                }
                
                // Send to each recipient
                let sentCount = 0;
                
                for (const recipient of recipients) {
                    const messageId = `${Date.now()}_${recipient.telegramId}`;
                    const userMessageRef = doc(db, "userMessages", messageId);
                    
                    const userMessage = {
                        type: messageType,
                        title: title,
                        content: content,
                        autoDismiss: autoDismiss,
                        dismissAfterSeconds: autoDismiss ? 10 : null,
                        createdAt: serverTimestamp(),
                        sentBy: auth.currentUser.uid,
                        status: 'pending',
                        recipientId: recipient.telegramId,
                        recipientName: recipient.name,
                        userId: recipient.userId,
                        isRead: false,
                        readAt: null,
                        dismissedAt: null
                    };
                    
                    await setDoc(userMessageRef, userMessage);
                    sentCount++;
                }
                
                // Save to message history
                await addDoc(collection(db, "messageHistory"), {
                    type: messageType,
                    title: title,
                    content: content,
                    recipientType: recipientType,
                    recipientCount: recipients.length,
                    recipients: recipients.map(r => r.name),
                    sentAt: serverTimestamp(),
                    sentBy: auth.currentUser.uid
                });
                
                showToast(`✅ Message sent to ${sentCount} user${sentCount !== 1 ? 's' : ''} successfully!`);
                closeCustomMessageModal();
                loadCustomMessagesHistory();
                
            } catch (error) {
                console.error("Error sending message:", error);
                showAlert("❌ Error sending message: " + error.message, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        async function loadCustomMessagesHistory() {
            try {
                const historySnap = await getDocs(query(
                    collection(db, "messageHistory"),
                    orderBy("sentAt", "desc"),
                    limit(50)
                ));
                
                const historyBody = document.getElementById('custom-messages-history');
                historyBody.innerHTML = '';
                
                if (historySnap.empty) {
                    historyBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">No messages sent yet</td></tr>`;
                    return;
                }
                
                historySnap.forEach(doc => {
                    const message = doc.data();
                    const sentAt = message.sentAt?.toDate().toLocaleString() || 'N/A';
                    const typeClass = message.type === 'payment' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800';
                    
                    let recipientText = '';
                    if (message.recipientType === 'all') {
                        recipientText = `All Users (${message.recipientCount || 0})`;
                    } else if (message.recipientType === 'specific') {
                        recipientText = `Specific User`;
                    } else if (message.recipientType === 'selected') {
                        recipientText = `Selected Users (${message.recipientCount || 0})`;
                    }
                    
                    historyBody.innerHTML += `
                        <tr class="border-b">
                            <td class="py-3 text-gray-700">${message.title}</td>
                            <td class="py-3">
                                <span class="status-badge ${typeClass}">
                                    ${message.type === 'payment' ? 'Payment' : 'Custom'}
                                </span>
                            </td>
                            <td class="py-3 text-gray-700">${recipientText}</td>
                            <td class="py-3 text-gray-500 text-sm">${sentAt}</td>
                            <td class="py-3">
                                <span class="status-badge status-active">
                                    Sent
                                </span>
                            </td>
                            <td class="py-3">
                                <button onclick="viewMessageDetails('${doc.id}')" class="btn btn-sm btn-secondary">
                                    <i data-lucide="eye" class="w-3 h-3"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                lucide.createIcons();
            } catch (error) {
                console.error("Error loading message history:", error);
                document.getElementById('custom-messages-history').innerHTML = 
                    `<tr><td colspan="6" class="text-center py-4 text-red-500">Error loading messages</td></tr>`;
            }
        }

        async function viewMessageDetails(messageId) {
            try {
                const messageDoc = await getDoc(doc(db, "messageHistory", messageId));
                if (!messageDoc.exists()) {
                    showAlert("Message not found.", true);
                    return;
                }
                
                const message = messageDoc.data();
                let details = `
                    <div class="space-y-3">
                        <div>
                            <strong class="text-gray-700">Title:</strong>
                            <p class="text-gray-800">${message.title}</p>
                        </div>
                        <div>
                            <strong class="text-gray-700">Type:</strong>
                            <span class="status-badge ${message.type === 'payment' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'}">
                                ${message.type === 'payment' ? 'Payment Status' : 'Custom Message'}
                            </span>
                        </div>
                        <div>
                            <strong class="text-gray-700">Recipients:</strong>
                            <p class="text-gray-800">${message.recipientType === 'all' ? 'All Users' : message.recipientType === 'specific' ? 'Specific User' : 'Selected Users'}</p>
                            <p class="text-gray-600 text-sm">Sent to ${message.recipientCount || 0} users</p>
                        </div>
                        <div>
                            <strong class="text-gray-700">Content:</strong>
                            <p class="text-gray-800 p-2 bg-gray-50 rounded">${message.content}</p>
                        </div>
                `;
                
                if (message.type === 'payment') {
                    details += `
                        <div>
                            <strong class="text-gray-700">Payment Status:</strong>
                            <span class="status-badge ${message.paymentStatus === 'approved' ? 'status-approved' : 'status-rejected'}">
                                ${message.paymentStatus}
                            </span>
                        </div>
                        <div>
                            <strong class="text-gray-700">Amount:</strong>
                            <p class="text-gray-800">${message.amount || 0} points</p>
                        </div>
                    `;
                    
                    if (message.paymentStatus === 'rejected' && message.rejectionReason) {
                        details += `
                            <div>
                                <strong class="text-gray-700">Rejection Reason:</strong>
                                <p class="text-gray-800">${message.rejectionReason}</p>
                            </div>
                        `;
                    }
                }
                
                details += `
                        <div>
                            <strong class="text-gray-700">Auto Dismiss:</strong>
                            <p class="text-gray-800">${message.autoDismiss ? 'Yes (10 seconds)' : 'No'}</p>
                        </div>
                        <div>
                            <strong class="text-gray-700">Sent At:</strong>
                            <p class="text-gray-800">${message.sentAt?.toDate().toLocaleString() || 'N/A'}</p>
                        </div>
                    </div>
                `;
                
                showAlert(details);
            } catch (error) {
                console.error("Error viewing message details:", error);
                showAlert("❌ Error loading message details: " + error.message, true);
            }
        }

        // FIXED: sendDirectMessage function
        function sendDirectMessage(telegramId, username, userId = '') {
            openCustomMessageModal();
            
            // Set to specific user
            document.querySelector('input[name="recipientType"][value="specific"]').checked = true;
            toggleRecipientType('specific');
            
            // Fill telegram ID and search
            document.getElementById('telegram-id-input').value = telegramId;
            selectedTelegramId = telegramId;
            
            // Show user info without searching
            const resultDiv = document.getElementById('user-search-result');
            resultDiv.innerHTML = `
                <div class="text-green-600 p-2 bg-green-50 rounded">
                    <div class="font-semibold">User Selected:</div>
                    <div>Name: ${username}</div>
                    <div>Telegram ID: ${telegramId}</div>
                    ${userId ? `<div class="text-sm text-gray-500">User ID: ${userId}</div>` : ''}
                </div>
            `;
            resultDiv.classList.remove('hidden');
            
            // Set default title
            document.getElementById('custom-message-title').value = `Message for ${username}`;
        }

        function sendCustomMessageToSelected() {
            if (selectedUsers.size === 0) {
                showAlert("Please select users first.");
                return;
            }
            
            openCustomMessageModal();
            document.querySelector('input[name="recipientType"][value="selected"]').checked = true;
            toggleRecipientType('selected');
        }

        // ===== FIXED PAYMENT STATUS NOTIFICATION FUNCTIONS =====
        // FIXED: processWithdrawal to send automatic notifications
        async function processWithdrawal(requestId, action) {
            let rejectionReason = '';
            
            // If rejecting, ask for reason
            if (action === 'rejected') {
                const reason = prompt("Enter reason for rejection (optional):");
                if (reason === null) return; // User cancelled
                rejectionReason = reason || "No reason provided";
            }
            
            showConfirm(`Are you sure you want to ${action} this withdrawal request?`, async () => {
                loader.style.display = 'flex';
                const batch = writeBatch(db);
                const requestRef = doc(db, "withdrawals", requestId);
                
                try {
                    // Get request data
                    const requestSnap = await getDoc(requestRef);
                    if (!requestSnap.exists()) {
                        throw new Error("Request not found");
                    }
                    
                    const requestData = requestSnap.data();
                    
                    // Update withdrawal status
                    const updateData = { 
                        status: action,
                        processedAt: serverTimestamp()
                    };
                    
                    if (action === 'rejected' && rejectionReason) {
                        updateData.rejectionReason = rejectionReason;
                    }
                    
                    batch.update(requestRef, updateData);
                    
                    // If rejected, refund points to user
                    if (action === 'rejected') {
                        const userRef = doc(db, "users", requestData.userId);
                        const userSnap = await getDoc(userRef);
                        
                        if (userSnap.exists()) {
                            const userData = userSnap.data();
                            const currentBalance = userData.balance || 0;
                            batch.update(userRef, { balance: currentBalance + requestData.amount });
                            
                            // Add point history for refund
                            await addDoc(collection(db, "pointHistory"), {
                                userId: requestData.userId,
                                userName: requestData.userName,
                                userEmail: userData.email || '',
                                taskType: 'withdrawal_refund',
                                points: requestData.amount,
                                details: `Refund for rejected withdrawal #${requestId}`,
                                timestamp: serverTimestamp(),
                                country: requestData.country || 'N/A'
                            });
                        }
                    }
                    
                    await batch.commit();
                    
                    // ===== AUTOMATIC PAYMENT STATUS NOTIFICATION =====
                    await sendPaymentStatusNotification(requestData, action, rejectionReason);
                    
                    showToast(`✅ Withdrawal request ${action} successfully! Notification sent to user.`);
                    loadWithdrawals();
                    loadDashboardData();
                } catch (error) {
                    console.error("Error processing withdrawal:", error);
                    showAlert("❌ Error processing withdrawal request: " + error.message, true);
                } finally {
                    loader.style.display = 'none';
                }
            });
        }

        // FIXED: sendPaymentStatusNotification function
        async function sendPaymentStatusNotification(withdrawalData, status, rejectionReason = '') {
            try {
                // First, get user's telegramId from user document
                let telegramId = '';
                let userName = withdrawalData.userName || 'User';
                
                if (withdrawalData.userId) {
                    const userDoc = await getDoc(doc(db, "users", withdrawalData.userId));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        telegramId = userData.telegramId || '';
                        userName = userData.telegramUsername || userData.telegramFirstName || userName;
                    }
                }
                
                if (!telegramId) {
                    console.warn("Cannot send payment notification: No Telegram ID found for user");
                    return;
                }
                
                // Create message ID using timestamp and telegramId
                const messageId = `payment_${Date.now()}_${telegramId}`;
                const userMessageRef = doc(db, "userMessages", messageId);
                
                const messageData = {
                    type: 'payment',
                    title: status === 'approved' ? '💰 Payment Completed!' : '❌ Payment Rejected',
                    content: status === 'approved' 
                        ? `Your withdrawal of ${withdrawalData.amount} points has been approved and processed.` 
                        : `Your withdrawal request has been rejected.`,
                    paymentStatus: status,
                    amount: withdrawalData.amount,
                    method: withdrawalData.method || '',
                    autoDismiss: true,
                    dismissAfterSeconds: 10,
                    createdAt: serverTimestamp(),
                    sentBy: auth.currentUser.uid,
                    status: 'pending',
                    recipientId: telegramId,
                    recipientName: userName,
                    userId: withdrawalData.userId,
                    withdrawalId: withdrawalData.id || '',
                    isRead: false,
                    readAt: null,
                    dismissedAt: null
                };
                
                // Add rejection reason if rejected
                if (status === 'rejected' && rejectionReason) {
                    messageData.rejectionReason = rejectionReason;
                    messageData.content += ` Reason: ${rejectionReason}`;
                }
                
                await setDoc(userMessageRef, messageData);
                
                console.log(`✅ Payment status notification sent to ${telegramId}: ${withdrawalData.amount} points - ${status}`);
                
            } catch (error) {
                console.error("❌ Error sending payment status notification:", error);
                // Don't throw error here to not affect withdrawal processing
            }
        }

        // ===== ENHANCED GAME MANAGEMENT =====
        async function loadGames() {
            const page = document.getElementById('games');
            page.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Game Management</h1>
                    <div class="flex space-x-2">
                        <button onclick="syncAllGameSettings()" class="btn btn-secondary">
                            <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i> Sync All
                        </button>
                        <button onclick="resetAllGameStats()" class="btn btn-warning">
                            Reset All Game Stats
                        </button>
                        <button onclick="resetUserPlayLimits()" class="btn btn-danger">
                            Reset User Play Limits
                        </button>
                    </div>
                </div>
                
                <div class="mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i data-lucide="info" class="w-5 h-5 text-blue-600 mr-2"></i>
                        <p class="text-blue-700">
                            <strong>Features:</strong> 1) Set Daily Play Limit - Game becomes unplayable after limit reached. 
                            2) Toggle Game Visibility - Hide/show game in mini-app.
                        </p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Color Game Card -->
                    <div class="game-card" id="colorGame-card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <div class="bg-purple-500 text-white p-3 rounded-lg mr-3">
                                    <i data-lucide="palette" class="w-6 h-6"></i>
                                </div>
                                <div>
                                    <h2 class="text-xl font-bold text-gray-800">Color Game</h2>
                                    <p class="text-sm text-gray-500">Match colors to earn points</p>
                                </div>
                            </div>
                            <span id="colorGame-status" class="status-badge status-visible">Visible</span>
                        </div>
                        
                        <div class="game-limits-grid">
                            <div class="limit-card">
                                <div class="limit-title">Daily Play Limit</div>
                                <div class="limit-value" id="colorGame-play-limit">20 plays</div>
                            </div>
                            <div class="limit-card">
                                <div class="limit-title">Reward Per Play</div>
                                <div class="limit-value" id="colorGame-reward">10 points</div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <div class="flex items-center justify-between mb-3">
                                <span class="font-semibold text-gray-700">Today's Plays:</span>
                                <span class="font-bold text-blue-600" id="colorGame-today-plays">0</span>
                            </div>
                        </div>
                        
                        <div class="game-action-buttons">
                            <button onclick="openQuickSettings('colorGame')" class="btn btn-primary flex-1">
                                <i data-lucide="settings" class="w-4 h-4 mr-2"></i> Settings
                            </button>
                        </div>
                    </div>
                    
                    <!-- Watch Video Card -->
                    <div class="game-card" id="watchVideo-card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <div class="bg-blue-500 text-white p-3 rounded-lg mr-3">
                                    <i data-lucide="video" class="w-6 h-6"></i>
                                </div>
                                <div>
                                    <h2 class="text-xl font-bold text-gray-800">Watch Video</h2>
                                    <p class="text-sm text-gray-500">Earn by watching ads</p>
                                </div>
                            </div>
                            <span id="watchVideo-status" class="status-badge status-visible">Visible</span>
                        </div>
                        
                        <div class="game-limits-grid">
                            <div class="limit-card">
                                <div class="limit-title">Daily Play Limit</div>
                                <div class="limit-value" id="watchVideo-play-limit">10 videos</div>
                            </div>
                            <div class="limit-card">
                                <div class="limit-title">Reward Per Video</div>
                                <div class="limit-value" id="watchVideo-reward">15 points</div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <div class="flex items-center justify-between mb-3">
                                <span class="font-semibold text-gray-700">Today's Plays:</span>
                                <span class="font-bold text-blue-600" id="watchVideo-today-plays">0</span>
                            </div>
                        </div>
                        
                        <div class="game-action-buttons">
                            <button onclick="openQuickSettings('watchVideo')" class="btn btn-primary flex-1">
                                <i data-lucide="settings" class="w-4 h-4 mr-2"></i> Settings
                            </button>
                        </div>
                    </div>
                    
                    <!-- Ludo Dice Card -->
                    <div class="game-card" id="ludoDice-card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <div class="bg-green-500 text-white p-3 rounded-lg mr-3">
                                    <i data-lucide="dice-5" class="w-6 h-6"></i>
                                </div>
                                <div>
                                    <h2 class="text-xl font-bold text-gray-800">Ludo Dice</h2>
                                    <p class="text-sm text-gray-500">Roll dice to win points</p>
                                </div>
                            </div>
                            <span id="ludoDice-status" class="status-badge status-visible">Visible</span>
                        </div>
                        
                        <div class="game-limits-grid">
                            <div class="limit-card">
                                <div class="limit-title">Daily Play Limit</div>
                                <div class="limit-value" id="ludoDice-play-limit">50 plays</div>
                            </div>
                            <div class="limit-card">
                                <div class="limit-title">Reward Per Play</div>
                                <div class="limit-value" id="ludoDice-reward">5 points</div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <div class="flex items-center justify-between mb-3">
                                <span class="font-semibold text-gray-700">Today's Plays:</span>
                                <span class="font-bold text-blue-600" id="ludoDice-today-plays">0</span>
                            </div>
                        </div>
                        
                        <div class="game-action-buttons">
                            <button onclick="openQuickSettings('ludoDice')" class="btn btn-primary flex-1">
                                <i data-lucide="settings" class="w-4 h-4 mr-2"></i> Settings
                            </button>
                        </div>
                    </div>
                    
                    <!-- Try Your Luck Card -->
                    <div class="game-card" id="tryYourLuck-card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <div class="bg-yellow-500 text-white p-3 rounded-lg mr-3">
                                    <i data-lucide="star" class="w-6 h-6"></i>
                                </div>
                                <div>
                                    <h2 class="text-xl font-bold text-gray-800">Try Your Luck</h2>
                                    <p class="text-sm text-gray-500">Test your luck to win points</p>
                                </div>
                            </div>
                            <span id="tryYourLuck-status" class="status-badge status-visible">Visible</span>
                        </div>
                        
                        <div class="game-limits-grid">
                            <div class="limit-card">
                                <div class="limit-title">Daily Play Limit</div>
                                <div class="limit-value" id="tryYourLuck-play-limit">5 plays</div>
                            </div>
                            <div class="limit-card">
                                <div class="limit-title">Reward Per Play</div>
                                <div class="limit-value" id="tryYourLuck-reward">50 points</div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <div class="flex items-center justify-between mb-3">
                                <span class="font-semibold text-gray-700">Today's Plays:</span>
                                <span class="font-bold text-blue-600" id="tryYourLuck-today-plays">0</span>
                            </div>
                        </div>
                        
                        <div class="game-action-buttons">
                            <button onclick="openQuickSettings('tryYourLuck')" class="btn btn-primary flex-1">
                                <i data-lucide="settings" class="w-4 h-4 mr-2"></i> Settings
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Global Controls -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">Global Controls</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block font-semibold mb-2 text-gray-700">Set All Games Limit</label>
                            <div class="flex items-center space-x-2">
                                <input type="number" id="global-play-limit" class="input-field" placeholder="e.g., 20">
                                <button onclick="applyGlobalPlayLimit()" class="btn btn-primary">Apply to All</button>
                            </div>
                        </div>
                        <div>
                            <label class="block font-semibold mb-2 text-gray-700">Set All Games Reward</label>
                            <div class="flex items-center space-x-2">
                                <input type="number" id="global-reward" class="input-field" placeholder="e.g., 10">
                                <button onclick="applyGlobalReward()" class="btn btn-primary">Apply to All</button>
                            </div>
                        </div>
                        <div>
                            <label class="block font-semibold mb-2 text-gray-700">Visibility Control</label>
                            <div class="flex space-x-2">
                                <button onclick="showAllGames()" class="btn btn-success flex-1">Show All</button>
                                <button onclick="hideAllGames()" class="btn btn-danger flex-1">Hide All</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Game Statistics -->
                <div class="bg-white p-6 rounded-lg shadow mt-6">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">Game Statistics</h2>
                    <div id="games-stats-table" class="overflow-x-auto">
                        Loading...
                    </div>
                </div>
            `;
            
            await loadGamesData();
            await loadGamesStats();
        }

        // Game Management Functions
        async function loadGamesData() {
            try {
                const gamesSnap = await getDoc(doc(db, "config", "games"));
                const gamesConfig = gamesSnap.exists() ? gamesSnap.data() : {};
                
                // Load game configurations
                const games = [
                    { id: 'colorGame', name: 'Color Game', icon: 'palette', color: 'bg-purple-500' },
                    { id: 'watchVideo', name: 'Watch Video', icon: 'video', color: 'bg-blue-500' },
                    { id: 'ludoDice', name: 'Ludo Dice', icon: 'dice-5', color: 'bg-green-500' },
                    { id: 'tryYourLuck', name: 'Try Your Luck', icon: 'star', color: 'bg-yellow-500' }
                ];
                
                // Get today's stats
                const today = new Date().toISOString().split('T')[0];
                const todayStats = gamesConfig.dailyStats?.[today] || {};
                
                games.forEach(game => {
                    const gameConfig = gamesConfig[game.id] || {};
                    const isVisible = gameConfig.visible !== false;
                    const dailyPlayLimit = gameConfig.dailyPlayLimit || 0;
                    const rewardPerPlay = gameConfig.rewardPerPlay || 0;
                    const todayGameStats = todayStats[game.id] || { playCount: 0 };
                    
                    // Update status badge
                    const statusEl = document.getElementById(`${game.id}-status`);
                    if (statusEl) {
                        statusEl.textContent = isVisible ? 'Visible' : 'Hidden';
                        statusEl.className = `status-badge ${isVisible ? 'status-visible' : 'status-hidden'}`;
                    }
                    
                    // Update play limit display
                    const playLimitEl = document.getElementById(`${game.id}-play-limit`);
                    if (playLimitEl) {
                        playLimitEl.textContent = dailyPlayLimit > 0 ? `${dailyPlayLimit} plays` : 'Unlimited';
                    }
                    
                    // Update reward display
                    const rewardEl = document.getElementById(`${game.id}-reward`);
                    if (rewardEl) {
                        rewardEl.textContent = `${rewardPerPlay} points`;
                    }
                    
                    // Update today's plays
                    const todayPlaysEl = document.getElementById(`${game.id}-today-plays`);
                    if (todayPlaysEl) {
                        todayPlaysEl.textContent = todayGameStats.playCount || 0;
                    }
                });
                
                lucide.createIcons();
            } catch (error) {
                console.error("Error loading games data:", error);
                showAlert("❌ Error loading game configurations", true);
            }
        }

        // Reset user play limits
        async function resetUserPlayLimits() {
            showConfirm("Are you sure you want to reset ALL user play limits? This will allow all users to play games again from zero.", async () => {
                loader.style.display = 'flex';
                try {
                    const usersSnap = await getDocs(collection(db, "users"));
                    const batch = writeBatch(db);
                    
                    // Reset play limits for each user
                    usersSnap.forEach((userDoc) => {
                        const userRef = doc(db, "users", userDoc.id);
                        const userData = userDoc.data();
                        
                        // Reset game play counts
                        const updates = {
                            colorGamePlaysToday: 0,
                            watchVideoPlaysToday: 0,
                            ludoDicePlaysToday: 0,
                            tryYourLuckPlaysToday: 0,
                            lastGamePlayDate: '1970-01-01',
                            updatedAt: serverTimestamp()
                        };
                        
                        batch.update(userRef, updates);
                    });
                    
                    await batch.commit();
                    showToast("✅ All user play limits reset successfully!");
                    
                } catch (error) {
                    console.error("Error resetting user play limits:", error);
                    showAlert("❌ Error resetting play limits: " + error.message, true);
                } finally {
                    loader.style.display = 'none';
                }
            });
        }

        // Quick Game Settings Functions
        function openQuickSettings(gameId) {
            currentEditingGameId = gameId;
            
            const gameNames = {
                'colorGame': 'Color Game',
                'watchVideo': 'Watch Video',
                'ludoDice': 'Ludo Dice',
                'tryYourLuck': 'Try Your Luck'
            };
            
            document.getElementById('quick-game-title').textContent = `${gameNames[gameId]} Settings`;
            
            // Load current settings
            loadGameSettingsForQuickEdit(gameId);
            
            // Show modal
            document.getElementById('quick-game-settings-modal').style.display = 'flex';
        }

        async function loadGameSettingsForQuickEdit(gameId) {
            try {
                const gamesSnap = await getDoc(doc(db, "config", "games"));
                const gamesConfig = gamesSnap.exists() ? gamesSnap.data() : {};
                
                const gameConfig = gamesConfig[gameId] || {};
                
                // Set form values
                document.getElementById('quick-play-limit').value = gameConfig.dailyPlayLimit || 0;
                document.getElementById('quick-game-visible').checked = gameConfig.visible !== false;
                document.getElementById('quick-game-reward').value = gameConfig.rewardPerPlay || 0;
                document.getElementById('quick-game-order').value = gameConfig.order || 1;
                
            } catch (error) {
                console.error("Error loading game settings:", error);
            }
        }

        function closeQuickSettingsModal() {
            document.getElementById('quick-game-settings-modal').style.display = 'none';
            currentEditingGameId = null;
        }

        async function saveQuickGameSettings() {
            if (!currentEditingGameId) return;
            
            const dailyPlayLimit = parseInt(document.getElementById('quick-play-limit').value) || 0;
            const isVisible = document.getElementById('quick-game-visible').checked;
            const rewardPerPlay = parseInt(document.getElementById('quick-game-reward').value) || 0;
            const order = parseInt(document.getElementById('quick-game-order').value) || 1;
            
            if (dailyPlayLimit < 0 || rewardPerPlay < 0) {
                showAlert("❌ Please enter valid positive numbers");
                return;
            }
            
            if (order < 1 || order > 10) {
                showAlert("❌ Order must be between 1 and 10");
                return;
            }
            
            loader.style.display = 'flex';
            try {
                const gameRef = doc(db, "config", "games");
                const gameSnap = await getDoc(gameRef);
                const currentData = gameSnap.exists() ? gameSnap.data() : {};
                
                const updateData = {
                    [currentEditingGameId]: {
                        name: currentEditingGameId === 'colorGame' ? 'Color Game' : 
                              currentEditingGameId === 'watchVideo' ? 'Watch Video' : 
                              currentEditingGameId === 'ludoDice' ? 'Ludo Dice' : 'Try Your Luck',
                        dailyPlayLimit: dailyPlayLimit,
                        visible: isVisible,
                        rewardPerPlay: rewardPerPlay,
                        order: order,
                        updatedAt: serverTimestamp()
                    }
                };
                
                await setDoc(gameRef, updateData, { merge: true });
                
                showToast("✅ Game settings saved successfully!");
                closeQuickSettingsModal();
                
                // Refresh displays
                await loadGamesData();
                await loadGamesStats();
                if (document.getElementById('dashboard').classList.contains('active')) {
                    loadGameStats();
                }
                
            } catch (error) {
                console.error("Error saving game settings:", error);
                showAlert("❌ Error saving game settings: " + error.message, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        // Global Controls Functions
        async function applyGlobalPlayLimit() {
            const limit = parseInt(document.getElementById('global-play-limit').value) || 0;
            
            if (isNaN(limit) || limit < 0) {
                showAlert("Please enter a valid positive number for the play limit.");
                return;
            }
            
            showConfirm(`Apply daily play limit of ${limit} to ALL games?`, async () => {
                loader.style.display = 'flex';
                try {
                    const gameRef = doc(db, "config", "games");
                    const gameSnap = await getDoc(gameRef);
                    const currentData = gameSnap.exists() ? gameSnap.data() : {};
                    
                    const updateData = { ...currentData };
                    
                    // Update all games
                    ['colorGame', 'watchVideo', 'ludoDice', 'tryYourLuck'].forEach(gameId => {
                        if (!updateData[gameId]) updateData[gameId] = {};
                        updateData[gameId].dailyPlayLimit = limit;
                        updateData[gameId].updatedAt = serverTimestamp();
                    });
                    
                    await setDoc(gameRef, updateData);
                    
                    showToast(`✅ Daily play limit of ${limit} applied to all games!`);
                    await loadGamesData();
                    await loadGamesStats();
                    if (document.getElementById('dashboard').classList.contains('active')) {
                        loadGameStats();
                    }
                    
                } catch (error) {
                    console.error("Error applying global limit:", error);
                    showAlert("❌ Error applying global limit", true);
                } finally {
                    loader.style.display = 'none';
                }
            });
        }

        async function applyGlobalReward() {
            const reward = parseInt(document.getElementById('global-reward').value) || 0;
            
            if (isNaN(reward) || reward < 0) {
                showAlert("Please enter a valid positive number for the reward.");
                return;
            }
            
            showConfirm(`Apply reward of ${reward} points to ALL games?`, async () => {
                loader.style.display = 'flex';
                try {
                    const gameRef = doc(db, "config", "games");
                    const gameSnap = await getDoc(gameRef);
                    const currentData = gameSnap.exists() ? gameSnap.data() : {};
                    
                    const updateData = { ...currentData };
                    
                    // Update all games
                    ['colorGame', 'watchVideo', 'ludoDice', 'tryYourLuck'].forEach(gameId => {
                        if (!updateData[gameId]) updateData[gameId] = {};
                        updateData[gameId].rewardPerPlay = reward;
                        updateData[gameId].updatedAt = serverTimestamp();
                    });
                    
                    await setDoc(gameRef, updateData);
                    
                    showToast(`✅ Reward of ${reward} points applied to all games!`);
                    await loadGamesData();
                    await loadGamesStats();
                    if (document.getElementById('dashboard').classList.contains('active')) {
                        loadGameStats();
                    }
                    
                } catch (error) {
                    console.error("Error applying global reward:", error);
                    showAlert("❌ Error applying global reward", true);
                } finally {
                    loader.style.display = 'none';
                }
            });
        }

        async function showAllGames() {
            showConfirm("Make ALL games visible in the mini-app?", async () => {
                loader.style.display = 'flex';
                try {
                    const gameRef = doc(db, "config", "games");
                    const gameSnap = await getDoc(gameRef);
                    const currentData = gameSnap.exists() ? gameSnap.data() : {};
                    
                    const updateData = { ...currentData };
                    
                    // Show all games
                    ['colorGame', 'watchVideo', 'ludoDice', 'tryYourLuck'].forEach(gameId => {
                        if (!updateData[gameId]) updateData[gameId] = {};
                        updateData[gameId].visible = true;
                        updateData[gameId].updatedAt = serverTimestamp();
                    });
                    
                    await setDoc(gameRef, updateData);
                    
                    showToast("✅ All games are now visible!");
                    await loadGamesData();
                    await loadGamesStats();
                    if (document.getElementById('dashboard').classList.contains('active')) {
                        loadGameStats();
                    }
                    
                } catch (error) {
                    console.error("Error showing all games:", error);
                    showAlert("❌ Error showing all games", true);
                } finally {
                    loader.style.display = 'none';
                }
            });
        }

        async function hideAllGames() {
            showConfirm("Hide ALL games from the mini-app?", async () => {
                loader.style.display = 'flex';
                try {
                    const gameRef = doc(db, "config", "games");
                    const gameSnap = await getDoc(gameRef);
                    const currentData = gameSnap.exists() ? gameSnap.data() : {};
                    
                    const updateData = { ...currentData };
                    
                    // Hide all games
                    ['colorGame', 'watchVideo', 'ludoDice', 'tryYourLuck'].forEach(gameId => {
                        if (!updateData[gameId]) updateData[gameId] = {};
                        updateData[gameId].visible = false;
                        updateData[gameId].updatedAt = serverTimestamp();
                    });
                    
                    await setDoc(gameRef, updateData);
                    
                    showToast("✅ All games are now hidden!");
                    await loadGamesData();
                    await loadGamesStats();
                    if (document.getElementById('dashboard').classList.contains('active')) {
                        loadGameStats();
                    }
                    
                } catch (error) {
                    console.error("Error hiding all games:", error);
                    showAlert("❌ Error hiding all games", true);
                } finally {
                    loader.style.display = 'none';
                }
            });
        }

        async function syncAllGameSettings() {
            loader.style.display = 'flex';
            try {
                await loadGamesData();
                await loadGamesStats();
                showToast("✅ All game settings synchronized!");
            } catch (error) {
                console.error("Error syncing game settings:", error);
                showAlert("❌ Error syncing game settings", true);
            } finally {
                loader.style.display = 'none';
            }
        }

        async function resetAllGameStats() {
            showConfirm("Are you sure you want to reset ALL game statistics? This action cannot be undone.", async () => {
                loader.style.display = 'flex';
                try {
                    const gameRef = doc(db, "config", "games");
                    const gameSnap = await getDoc(gameRef);
                    const currentData = gameSnap.exists() ? gameSnap.data() : {};
                    
                    // Keep game configurations but reset stats
                    const updateData = {
                        ...currentData,
                        dailyStats: {},
                        allTimeStats: {},
                        updatedAt: serverTimestamp()
                    };
                    
                    await setDoc(gameRef, updateData);
                    
                    showToast("✅ All game statistics reset successfully!");
                    await loadGamesStats();
                    if (document.getElementById('dashboard').classList.contains('active')) {
                        loadGameStats();
                    }
                } catch (error) {
                    console.error("Error resetting game stats:", error);
                    showAlert("❌ Error resetting game statistics", true);
                } finally {
                    loader.style.display = 'none';
                }
            });
        }

        async function loadGamesStats() {
            try {
                const gamesSnap = await getDoc(doc(db, "config", "games"));
                const gamesConfig = gamesSnap.exists() ? gamesSnap.data() : {};
                
                // Get today's stats
                const today = new Date().toISOString().split('T')[0];
                const todayStats = gamesConfig.dailyStats?.[today] || {};
                
                // Get all time stats
                const allTimeStats = gamesConfig.allTimeStats || {};
                
                let html = `<table class="w-full text-sm text-left">
                    <thead class="text-xs uppercase bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-gray-700">Game</th>
                            <th class="px-6 py-3 text-gray-700">Today's Plays</th>
                            <th class="px-6 py-3 text-gray-700">Today's Users</th>
                            <th class="px-6 py-3 text-gray-700">Today's Points</th>
                            <th class="px-6 py-3 text-gray-700">Total Plays</th>
                            <th class="px-6 py-3 text-gray-700">Total Users</th>
                            <th class="px-6 py-3 text-gray-700">Total Points</th>
                        </tr>
                    </thead>
                    <tbody>`;
                
                const games = [
                    { id: 'colorGame', name: 'Color Game' },
                    { id: 'watchVideo', name: 'Watch Video' },
                    { id: 'ludoDice', name: 'Ludo Dice' },
                    { id: 'tryYourLuck', name: 'Try Your Luck' }
                ];
                
                let todayTotalPlays = 0;
                let todayTotalUsers = 0;
                let todayTotalPoints = 0;
                let allTimeTotalPlays = 0;
                let allTimeTotalUsers = 0;
                let allTimeTotalPoints = 0;
                
                games.forEach(game => {
                    const todayGameStats = todayStats[game.id] || { playCount: 0, userCount: 0 };
                    const allTimeGameStats = allTimeStats[game.id] || { playCount: 0, userCount: 0 };
                    const gameConfig = gamesConfig[game.id] || {};
                    const rewardPerPlay = gameConfig.rewardPerPlay || 0;
                    
                    const todayPoints = todayGameStats.playCount * rewardPerPlay;
                    const allTimePoints = allTimeGameStats.playCount * rewardPerPlay;
                    
                    todayTotalPlays += todayGameStats.playCount;
                    todayTotalUsers += todayGameStats.userCount;
                    todayTotalPoints += todayPoints;
                    allTimeTotalPlays += allTimeGameStats.playCount;
                    allTimeTotalUsers += allTimeGameStats.userCount;
                    allTimeTotalPoints += allTimePoints;
                    
                    html += `<tr class="bg-white border-b">
                        <td class="px-6 py-4 font-semibold text-gray-800">${game.name}</td>
                        <td class="px-6 py-4 text-gray-700">${todayGameStats.playCount}</td>
                        <td class="px-6 py-4 text-gray-700">${todayGameStats.userCount}</td>
                        <td class="px-6 py-4 text-gray-700">${todayPoints}</td>
                        <td class="px-6 py-4 text-gray-700">${allTimeGameStats.playCount}</td>
                        <td class="px-6 py-4 text-gray-700">${allTimeGameStats.userCount}</td>
                        <td class="px-6 py-4 text-gray-700">${allTimePoints}</td>
                    </tr>`;
                });
                
                // Add totals row
                html += `<tr class="bg-gray-50 font-bold">
                    <td class="px-6 py-4 text-gray-800">TOTAL</td>
                    <td class="px-6 py-4 text-gray-800">${todayTotalPlays}</td>
                    <td class="px-6 py-4 text-gray-800">${todayTotalUsers}</td>
                    <td class="px-6 py-4 text-gray-800">${todayTotalPoints}</td>
                    <td class="px-6 py-4 text-gray-800">${allTimeTotalPlays}</td>
                    <td class="px-6 py-4 text-gray-800">${allTimeTotalUsers}</td>
                    <td class="px-6 py-4 text-gray-800">${allTimeTotalPoints}</td>
                </tr>`;
                
                html += `</tbody></table>`;
                document.getElementById('games-stats-table').innerHTML = html;
            } catch (error) {
                console.error("Error loading game stats:", error);
                document.getElementById('games-stats-table').innerHTML = 
                    `<p class="text-center text-gray-500">Error loading game statistics</p>`;
            }
        }

        // Ad Network Functions - UPDATED WITH MONETAG
        async function loadAdNetwork() {
            const page = document.getElementById('adnetwork');
            page.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Ad Network Configuration</h1>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">Ad Network Settings</h2>
                    <p class="text-gray-600 mb-6">Configure ad networks for your app. These IDs will be used to display ads in the app.</p>
                    
                    <!-- Ad Network Rotation Settings -->
                    <div class="mb-8 border border-gray-200 rounded-lg p-4 bg-gray-50">
                        <h3 class="text-lg font-semibold mb-3 text-gray-800">Ad Network Rotation System</h3>
                        <p class="text-sm text-gray-600 mb-4">
                            <strong>Rotation Logic:</strong> When both enabled, ads will rotate between both networks with the fastest response. 
                            When only one enabled, show that network's ads. When both disabled, show "ads not available".
                        </p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="feature-toggle">
                                <div>
                                    <label class="feature-label text-gray-700">Taddy.pro</label>
                                    <p class="text-sm text-gray-500">Enable/disable Taddy.pro ads</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="taddy-enabled">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                            <div class="feature-toggle">
                                <div>
                                    <label class="feature-label text-gray-700">Monetag</label>
                                    <p class="text-sm text-gray-500">Enable/disable Monetag ads</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="monetag-enabled">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Taddy.pro Configuration -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold mb-3 text-green-700">Taddy.pro</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="block font-medium mb-1 text-gray-700">Public ID</label>
                                    <input type="text" id="taddy-publicid" class="input-field" placeholder="Enter Taddy.pro Public ID">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Monetag Configuration -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold mb-3 text-purple-700">Monetag</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="block font-medium mb-1 text-gray-700">In-App Interstitial ID</label>
                                    <input type="text" id="monetag-interstitialid" class="input-field" placeholder="Enter Monetag In-App Interstitial ID">
                                </div>
                            </div>
                        </div>
                        
                        <!-- RichAds Configuration -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold mb-3 text-blue-700">RichAds Network</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="block font-medium mb-1 text-gray-700">Pub ID</label>
                                    <input type="text" id="richads-pubid" class="input-field" placeholder="Enter RichAds Publisher ID">
                                </div>
                                <div>
                                    <label class="block font-medium mb-1 text-gray-700">App ID</label>
                                    <input type="text" id="richads-appid" class="input-field" placeholder="Enter RichAds Application ID">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Adsgram Configuration -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold mb-3 text-orange-700">Adsgram</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="block font-medium mb-1 text-gray-700">Reward ID</label>
                                    <input type="text" id="adsgram-rewardid" class="input-field" placeholder="Enter Adsgram Reward ID">
                                </div>
                                <div>
                                    <label class="block font-medium mb-1 text-gray-700">Interstitial ID</label>
                                    <input type="text" id="adsgram-interstitialid" class="input-field" placeholder="Enter Adsgram Interstitial ID">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8">
                        <button onclick="saveAdNetworkConfig()" class="btn btn-primary px-8 py-3">
                            <i data-lucide="save" class="w-5 h-5 mr-2"></i> Save Ad Network Settings
                        </button>
                    </div>
                </div>
            `;
            
            // Load existing ad network settings
            try {
                await loadAdNetworkData();
                lucide.createIcons();
            } catch (error) {
                console.error("Error loading ad network:", error);
                showAlert("❌ Error loading ad network settings: " + error.message, true);
            }
        }

        async function loadAdNetworkData() {
            try {
                const configSnap = await getDoc(doc(db, "config", "adnetwork"));
                
                if (configSnap.exists()) {
                    const config = configSnap.data();
                    
                    if (config.richadsPubId) {
                        document.getElementById('richads-pubid').value = config.richadsPubId;
                    }
                    
                    if (config.richadsAppId) {
                        document.getElementById('richads-appid').value = config.richadsAppId;
                    }
                    
                    if (config.taddyPublicId) {
                        document.getElementById('taddy-publicid').value = config.taddyPublicId;
                    }
                    
                    if (config.taddyEnabled !== undefined) {
                        document.getElementById('taddy-enabled').checked = config.taddyEnabled;
                    }
                    
                    if (config.monetagInterstitialId) {
                        document.getElementById('monetag-interstitialid').value = config.monetagInterstitialId;
                    }
                    
                    if (config.monetagEnabled !== undefined) {
                        document.getElementById('monetag-enabled').checked = config.monetagEnabled;
                    }
                    
                    if (config.adsgramRewardId) {
                        document.getElementById('adsgram-rewardid').value = config.adsgramRewardId;
                    }
                    
                    if (config.adsgramInterstitialId) {
                        document.getElementById('adsgram-interstitialid').value = config.adsgramInterstitialId;
                    }
                }
            } catch (error) {
                console.error("Error loading ad network config:", error);
            }
        }

        async function saveAdNetworkConfig() {
            loader.style.display = 'flex';
            try {
                const adNetworkConfig = {
                    richadsPubId: document.getElementById('richads-pubid').value.trim(),
                    richadsAppId: document.getElementById('richads-appid').value.trim(),
                    taddyPublicId: document.getElementById('taddy-publicid').value.trim(),
                    taddyEnabled: document.getElementById('taddy-enabled').checked,
                    monetagInterstitialId: document.getElementById('monetag-interstitialid').value.trim(),
                    monetagEnabled: document.getElementById('monetag-enabled').checked,
                    adsgramRewardId: document.getElementById('adsgram-rewardid').value.trim(),
                    adsgramInterstitialId: document.getElementById('adsgram-interstitialid').value.trim(),
                    updatedAt: serverTimestamp()
                };
                
                // Save to Firebase
                await setDoc(doc(db, "config", "adnetwork"), adNetworkConfig);
                
                showToast("✅ Ad network settings saved successfully!");
                
            } catch (error) {
                console.error("Error saving ad network config:", error);
                showAlert("❌ Error saving ad network settings: " + error.message, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        // Withdrawals Functions
        async function loadWithdrawals() {
            const page = document.getElementById('withdrawals');
            page.innerHTML = `
                <h1 class="text-3xl font-bold mb-6 text-gray-800">Withdrawal Requests</h1>
                <div class="mb-4 flex space-x-4">
                    <button onclick="filterWithdrawals('all')" class="btn btn-primary">All</button>
                    <button onclick="filterWithdrawals('pending')" class="btn btn-warning">Pending</button>
                    <button onclick="filterWithdrawals('approved')" class="btn btn-success">Approved</button>
                    <button onclick="filterWithdrawals('rejected')" class="btn btn-danger">Rejected</button>
                </div>
                <div class="bg-white shadow rounded-lg p-4">
                    <div class="overflow-x-auto">
                        <div id="withdrawals-table-container">Loading...</div>
                    </div>
                </div>
            `;
            
            await loadWithdrawalsData('all');
        }

        async function loadWithdrawalsData(filter = 'all') {
            let q;
            if (filter === 'all') {
                q = query(collection(db, "withdrawals"), orderBy("requestedAt", "desc"));
            } else {
                q = query(collection(db, "withdrawals"), where("status", "==", filter), orderBy("requestedAt", "desc"));
            }
            
            const withdrawalsSnap = await getDocs(q);
            
            if (withdrawalsSnap.empty) {
                document.getElementById('withdrawals-table-container').innerHTML = 
                    `<p class="text-center p-4 text-gray-500">No withdrawal requests found.</p>`;
                return;
            }

            let tableHTML = `<table class="w-full text-sm text-left">
                <thead class="text-xs uppercase bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-gray-700">User</th>
                        <th class="px-6 py-3 text-gray-700">Amount</th>
                        <th class="px-6 py-3 text-gray-700">Method</th>
                        <th class="px-6 py-3 text-gray-700">Details</th>
                        <th class="px-6 py-3 text-gray-700">Country</th>
                        <th class="px-6 py-3 text-gray-700">Requested At</th>
                        <th class="px-6 py-3 text-gray-700">Status</th>
                        <th class="px-6 py-3 text-gray-700">Actions</th>
                    </tr>
                </thead>
                <tbody>`;
            
            withdrawalsSnap.forEach(doc => {
                const req = doc.data();
                const requestedDate = req.requestedAt?.toDate().toLocaleString() || 'N/A';
                const statusClass = req.status === 'approved' ? 'status-approved' : 
                                  req.status === 'pending' ? 'status-pending' : 'status-rejected';
                const country = req.country || 'N/A';
                
                tableHTML += `<tr class="bg-white border-b">
                    <td class="px-6 py-4">
                        <div class="flex items-center space-x-2">
                            <span class="text-gray-700">${req.userName || 'N/A'}</span>
                            <button onclick="viewUserPointHistory('${req.userId}', '${req.userName}')" 
                                    class="view-points-btn btn-sm">View Points</button>
                        </div>
                    </td>
                    <td class="px-6 py-4 font-semibold text-gray-700">${req.amount}</td>
                    <td class="px-6 py-4 text-gray-700">${req.method}</td>
                    <td class="px-6 py-4 truncate max-w-xs text-gray-700" title="${req.paymentDetail}">${req.paymentDetail || 'N/A'}</td>
                    <td class="px-6 py-4 text-gray-700">${country}</td>
                    <td class="px-6 py-4 text-gray-500 text-sm">${requestedDate}</td>
                    <td class="px-6 py-4"><span class="status-badge ${statusClass}">${req.status}</span></td>
                    <td class="px-6 py-4">
                        ${req.status === 'pending' ? `
                        <div class="flex space-x-2">
                            <button onclick="processWithdrawal('${doc.id}', 'approved')" class="btn-success text-xs px-2 py-1 rounded">Approve</button>
                            <button onclick="processWithdrawal('${doc.id}', 'rejected')" class="btn-danger text-xs px-2 py-1 rounded">Reject</button>
                        </div>
                        ` : '—'}
                    </td>
                </tr>`;
            });
            
            tableHTML += `</tbody></table>`;
            document.getElementById('withdrawals-table-container').innerHTML = tableHTML;
        }

        function filterWithdrawals(status) {
            loadWithdrawalsData(status);
        }

        // Notifications Functions
        function loadNotifications() {
            const page = document.getElementById('notifications');
            page.innerHTML = `
                <h1 class="text-3xl font-bold mb-6 text-gray-800">Send Notification</h1>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="stat-card p-6">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">Send to All Users</h2>
                        <div class="mb-4">
                            <label for="notification-title" class="block font-semibold mb-2 text-gray-700">Title</label>
                            <input type="text" id="notification-title" class="input-field" placeholder="Notification title">
                        </div>
                        <div class="mb-6">
                            <label for="notification-message" class="block font-semibold mb-2 text-gray-700">Message</label>
                            <textarea id="notification-message" rows="4" class="input-field" placeholder="Notification message"></textarea>
                        </div>
                        <button id="send-notification-btn" class="btn btn-primary w-full">Send to All Users</button>
                    </div>
                    
                    <div class="stat-card p-6">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">Telegram Bot Configuration</h2>
                        <div class="mb-4">
                            <label for="telegram-bot-token" class="block font-semibold mb-2 text-gray-700">Bot Token</label>
                            <input type="text" id="telegram-bot-token" class="input-field" placeholder="Enter bot token">
                        </div>
                        <div class="mb-6">
                            <label for="telegram-chat-id" class="block font-semibold mb-2 text-gray-700">Chat ID</label>
                            <input type="text" id="telegram-chat-id" class="input-field" placeholder="Enter chat ID">
                        </div>
                        <button onclick="testTelegramConnection()" class="btn btn-warning w-full mb-2">Test Connection</button>
                        <button onclick="saveTelegramConfig()" class="btn btn-success w-full">Save Configuration</button>
                    </div>
                </div>
                
                <div class="mt-8">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Notification History</h2>
                    <div id="notification-history" class="bg-white shadow rounded-lg p-4">
                        Loading...
                    </div>
                </div>
            `;
            
            document.getElementById('send-notification-btn').addEventListener('click', sendNotification);
            loadNotificationHistory();
            loadTelegramConfig();
        }

        async function sendNotification() {
            const title = document.getElementById('notification-title').value;
            const message = document.getElementById('notification-message').value;
            
            if (!title || !message) {
                showAlert("Please enter both title and message.");
                return;
            }
            
            loader.style.display = 'flex';
            try {
                // Save to Firebase
                await addDoc(collection(db, "notifications"), {
                    title,
                    message,
                    createdAt: serverTimestamp(),
                    sentToAll: true
                });
                
                // Send to Telegram if configured
                await sendTelegramNotification(title, message);
                
                showToast("✅ Notification sent successfully!");
                document.getElementById('notification-title').value = '';
                document.getElementById('notification-message').value = '';
                loadNotificationHistory();
            } catch (error) {
                console.error("Error sending notification:", error);
                showAlert("❌ Error sending notification: " + error.message, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        async function sendTelegramNotification(title, message) {
            const configSnap = await getDoc(doc(db, "config", "telegram"));
            if (!configSnap.exists()) return;
            
            const config = configSnap.data();
            if (!config.botToken || !config.chatId) return;
            
            const telegramMessage = `*${title}*\n\n${message}`;
            
            try {
                const response = await fetch(`https://api.telegram.org/bot${config.botToken}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: config.chatId,
                        text: telegramMessage,
                        parse_mode: 'Markdown'
                    })
                });
                
                const result = await response.json();
                if (!result.ok) {
                    console.error("Telegram API error:", result);
                    throw new Error(result.description || 'Telegram API error');
                }
            } catch (error) {
                console.error("Error sending to Telegram:", error);
                throw error;
            }
        }

        async function loadNotificationHistory() {
            const notificationsSnap = await getDocs(query(
                collection(db, "notifications"), 
                orderBy("createdAt", "desc"), 
                limit(10)
            ));
            
            let html = `<table class="w-full">
                <thead><tr>
                    <th class="text-gray-700">Title</th>
                    <th class="text-gray-700">Message</th>
                    <th class="text-gray-700">Sent At</th>
                </tr></thead>
                <tbody>`;
            
            if (notificationsSnap.empty) {
                html += `<tr><td colspan="3" class="text-center py-4 text-gray-500">No notifications sent yet</td></tr>`;
            } else {
                notificationsSnap.forEach(doc => {
                    const notification = doc.data();
                    const sentAt = notification.createdAt?.toDate().toLocaleString() || 'N/A';
                    html += `<tr class="border-b">
                        <td class="py-2 font-semibold text-gray-700">${notification.title}</td>
                        <td class="py-2 text-gray-700">${notification.message}</td>
                        <td class="py-2 text-gray-500 text-sm">${sentAt}</td>
                    </tr>`;
                });
            }
            
            html += `</tbody></table>`;
            document.getElementById('notification-history').innerHTML = html;
        }

        async function loadTelegramConfig() {
            const configSnap = await getDoc(doc(db, "config", "telegram"));
            if (configSnap.exists()) {
                const config = configSnap.data();
                document.getElementById('telegram-bot-token').value = config.botToken || '';
                document.getElementById('telegram-chat-id').value = config.chatId || '';
            }
        }

        async function saveTelegramConfig() {
            const botToken = document.getElementById('telegram-bot-token').value;
            const chatId = document.getElementById('telegram-chat-id').value;
            
            if (!botToken || !chatId) {
                showAlert("Please enter both Bot Token and Chat ID.");
                return;
            }
            
            loader.style.display = 'flex';
            try {
                await setDoc(doc(db, "config", "telegram"), {
                    botToken,
                    chatId,
                    updatedAt: serverTimestamp()
                });
                showToast("✅ Telegram configuration saved successfully!");
            } catch (error) {
                console.error("Error saving Telegram config:", error);
                showAlert("❌ Error saving configuration: " + error.message, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        async function testTelegramConnection() {
            const botToken = document.getElementById('telegram-bot-token').value;
            const chatId = document.getElementById('telegram-chat-id').value;
            
            if (!botToken || !chatId) {
                showAlert("Please enter both Bot Token and Chat ID to test.");
                return;
            }
            
            loader.style.display = 'flex';
            try {
                // Test bot token
                const botResponse = await fetch(`https://api.telegram.org/bot${botToken}/getMe`);
                const botResult = await botResponse.json();
                
                if (!botResult.ok) {
                    showAlert("❌ Bot connection failed: " + botResult.description, true);
                    return;
                }
                
                // Test sending message
                const messageResponse = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: "✅ Test message from CashReward Admin Panel",
                        parse_mode: 'Markdown'
                    })
                });
                
                const messageResult = await messageResponse.json();
                if (messageResult.ok) {
                    showAlert("✅ Telegram connection successful! Test message sent.");
                } else {
                    showAlert("❌ Failed to send test message: " + messageResult.description, true);
                }
            } catch (error) {
                showAlert("❌ Error testing connection: " + error.message, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        // Settings Functions - FIXED FOR WEB VISIT TASK URL ISSUE
        async function loadSettings() {
            const page = document.getElementById('settings');
            page.innerHTML = `
                <h1 class="text-3xl font-bold mb-6 text-gray-800">App Settings</h1>
                <div class="space-y-8">
                    <!-- Payment Settings -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">Payment & Withdrawal Settings</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="font-semibold text-gray-700">Min Withdrawal (Points)</label>
                                <input type="number" id="minWithdrawal" class="input-field" placeholder="e.g., 1000">
                                <p class="text-sm text-gray-500 mt-1">Minimum points required for withdrawal</p>
                            </div>
                            <div>
                                <label class="font-semibold text-gray-700">Conversion Rate</label>
                                <div class="flex items-center space-x-2">
                                    <input type="number" id="conversionRatePoints" class="input-field" placeholder="1000">
                                    <span class="text-gray-500">points =</span>
                                    <input type="number" id="conversionRateTaka" class="input-field" placeholder="10">
                                    <span class="text-gray-500">Taka</span>
                                </div>
                                <p class="text-sm text-gray-500 mt-1">Example: 1000 points = 10 Taka</p>
                            </div>
                            <div>
                                <label class="font-semibold text-gray-700">Daily Ad Watch Limit</label>
                                <input type="number" id="dailyAdLimit" class="input-field" value="100">
                                <p class="text-sm text-gray-500 mt-1">Maximum ads a user can watch per day</p>
                            </div>
                            <div>
                                <label class="font-semibold text-gray-700">Ad Watch Reward (Points)</label>
                                <input type="number" id="adWatchReward" class="input-field" placeholder="e.g., 10">
                            </div>
                            <div>
                                <label class="font-semibold text-gray-700">Payment Methods (comma separated)</label>
                                <input type="text" id="paymentMethods" class="input-field" placeholder="Bkash, Nagad, Rocket">
                                <p class="text-sm text-gray-500 mt-1">Enter payment methods separated by commas</p>
                            </div>
                            <div class="col-span-2">
                                <div class="feature-toggle">
                                    <div>
                                        <label class="feature-label text-gray-700">Payment Method Verification</label>
                                        <p class="text-sm text-gray-500">Enable/disable payment method verification</p>
                                    </div>
                                    <label class="switch">
                                        <input type="checkbox" id="paymentVerification">
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                                <p class="text-sm text-gray-500 mt-2">
                                    <strong>Note:</strong> When verification is disabled, withdrawals are automatically approved if user has enough points.
                                    When enabled, admin must manually verify each withdrawal request.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Game Rewards -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">Game Rewards</h2>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="font-semibold text-gray-700">Color Game Reward</label>
                                <input type="number" id="colorGameReward" class="input-field" placeholder="e.g., 10">
                            </div>
                            <div>
                                <label class="font-semibold text-gray-700">Ludo Dice Reward</label>
                                <input type="number" id="ludoDiceReward" class="input-field" placeholder="e.g., 5">
                            </div>
                            <div>
                                <label class="font-semibold text-gray-700">Watch Video Reward</label>
                                <input type="number" id="watchVideoReward" class="input-field" placeholder="e.g., 15">
                            </div>
                            <div>
                                <label class="font-semibold text-gray-700">Try Your Luck Reward</label>
                                <input type="number" id="tryYourLuckReward" class="input-field" placeholder="e.g., 50">
                            </div>
                        </div>
                    </div>
                    
                    <!-- FIXED SPECIAL TASK SYSTEM -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">Special Task System</h2>
                        
                        <!-- Watch Video Special Task -->
                        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                            <h3 class="font-bold text-lg mb-3 text-blue-800">Watch Video Special Task</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="font-semibold text-gray-700">Show after # Videos</label>
                                    <input type="number" id="watchAdSpecialTaskCount" class="input-field" placeholder="e.g., 10">
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-700">Task Reward (Points)</label>
                                    <input type="number" id="watchAdSpecialTaskReward" class="input-field" placeholder="e.g., 100">
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-700">Wait Timer (Seconds)</label>
                                    <input type="number" id="watchAdSpecialTaskTimer" class="input-field" placeholder="e.g., 60">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Color Game Special Task -->
                        <div class="mb-6 p-4 bg-purple-50 rounded-lg">
                            <h3 class="font-bold text-lg mb-3 text-purple-800">Color Game Special Task</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="font-semibold text-gray-700">Show after # Plays</label>
                                    <input type="number" id="colorGameSpecialTaskCount" class="input-field" placeholder="e.g., 20">
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-700">Task Reward (Points)</label>
                                    <input type="number" id="colorGameSpecialTaskReward" class="input-field" placeholder="e.g., 200">
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-700">Wait Timer (Seconds)</label>
                                    <input type="number" id="colorGameSpecialTaskTimer" class="input-field" placeholder="e.g., 45">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ludo Dice Special Task -->
                        <div class="mb-6 p-4 bg-green-50 rounded-lg">
                            <h3 class="font-bold text-lg mb-3 text-green-800">Ludo Dice Special Task</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="font-semibold text-gray-700">Show after # Plays</label>
                                    <input type="number" id="ludoDiceSpecialTaskCount" class="input-field" placeholder="e.g., 30">
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-700">Task Reward (Points)</label>
                                    <input type="number" id="ludoDiceSpecialTaskReward" class="input-field" placeholder="e.g., 150">
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-700">Wait Timer (Seconds)</label>
                                    <input type="number" id="ludoDiceSpecialTaskTimer" class="input-field" placeholder="e.g., 30">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">IP Geolocation & Country Restrictions</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="font-semibold text-gray-700">IPinfo API Token</label>
                                <input type="text" id="ipinfoApiToken" class="input-field" placeholder="Enter IPinfo API token">
                                <p class="text-sm text-gray-500 mt-1">
                                    Leave blank to disable country detection.
                                </p>
                            </div>
                            <div>
                                <label class="font-semibold text-gray-700">Allowed Countries (comma separated)</label>
                                <input type="text" id="allowedCountries" class="input-field" placeholder="bd, in, pk, us, uk">
                                <p class="text-sm text-gray-500 mt-1">Enter country codes separated by commas</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- FIXED: Website Visit Management with proper URL handling -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Website Visit Management</h2>
                            <button onclick="resetWebsiteVisitHistory()" class="btn btn-danger">Reset All History</button>
                        </div>
                        
                        <div class="mb-4 p-4 bg-yellow-50 rounded-lg">
                            <p class="text-yellow-700 text-sm">
                                <strong>Important:</strong> Make sure website URLs are properly formatted with https:// prefix. 
                                The mini-app will use these URLs directly for web visit tasks.
                            </p>
                        </div>
                        
                        <div id="websites-to-visit-list" class="space-y-3 mb-4">
                            <!-- Websites will be loaded here -->
                        </div>
                        
                        <button onclick="addNewWebsite()" class="btn btn-primary mb-4">+ Add New Website</button>
                        <button onclick="saveWebsiteConfig()" class="btn btn-success ml-2">Save Websites</button>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">Referral System</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="font-semibold text-gray-700">Referral Bonus (Points)</label>
                                <input type="number" id="referralBonus" class="input-field" placeholder="e.g., 100">
                            </div>
                            <div>
                                <label class="font-semibold text-gray-700">Referrer Bonus (Points)</label>
                                <input type="number" id="referrerBonus" class="input-field" placeholder="e.g., 50">
                                <p class="text-sm text-gray-500 mt-1">Bonus for the user who refers someone</p>
                            </div>
                            <div class="col-span-2">
                                <label class="font-semibold text-gray-700">Referral Share Text</label>
                                <textarea id="referralShareText" class="input-field h-24" placeholder="Use my code {CODE} to get {BONUS} points bonus! App link: {APP_LINK}"></textarea>
                                <p class="text-sm text-gray-500 mt-1">Use {CODE} for referral code, {BONUS} for bonus points, {APP_LINK} for app link</p>
                            </div>
                        </div>
                    </div>
                </div>
                <button onclick="saveAllSettings()" class="btn btn-primary mt-8 px-8 py-3 text-lg">
                    <i data-lucide="save" class="w-5 h-5 mr-2"></i> Save All Settings
                </button>
            `;
            
            // Load existing settings
            await loadSettingsData();
            await loadWebsitesConfig();
        }

        async function loadSettingsData() {
            try {
                const configSnap = await getDoc(doc(db, "config", "main"));
                
                if (!configSnap.exists()) {
                    console.log("No settings found, using defaults");
                    return;
                }
                
                const config = configSnap.data();
                
                // Payment Settings
                if (config.minWithdrawal !== undefined) {
                    document.getElementById('minWithdrawal').value = config.minWithdrawal;
                }
                
                if (config.conversionRatePoints !== undefined) {
                    document.getElementById('conversionRatePoints').value = config.conversionRatePoints;
                }
                
                if (config.conversionRateTaka !== undefined) {
                    document.getElementById('conversionRateTaka').value = config.conversionRateTaka;
                }
                
                if (config.dailyAdLimit !== undefined) {
                    document.getElementById('dailyAdLimit').value = config.dailyAdLimit;
                }
                
                if (config.adWatchReward !== undefined) {
                    document.getElementById('adWatchReward').value = config.adWatchReward;
                }
                
                if (config.colorGameReward !== undefined) {
                    document.getElementById('colorGameReward').value = config.colorGameReward;
                }
                
                if (config.ludoDiceReward !== undefined) {
                    document.getElementById('ludoDiceReward').value = config.ludoDiceReward;
                }
                
                if (config.watchVideoReward !== undefined) {
                    document.getElementById('watchVideoReward').value = config.watchVideoReward;
                }
                
                if (config.tryYourLuckReward !== undefined) {
                    document.getElementById('tryYourLuckReward').value = config.tryYourLuckReward;
                }
                
                if (config.paymentMethods && Array.isArray(config.paymentMethods)) {
                    document.getElementById('paymentMethods').value = config.paymentMethods.join(', ');
                }
                
                if (config.paymentVerification !== undefined) {
                    document.getElementById('paymentVerification').checked = config.paymentVerification;
                }
                
                // Referral Settings
                if (config.referralBonus !== undefined) {
                    document.getElementById('referralBonus').value = config.referralBonus;
                }
                
                if (config.referrerBonus !== undefined) {
                    document.getElementById('referrerBonus').value = config.referrerBonus;
                }
                
                if (config.referralShareText) {
                    document.getElementById('referralShareText').value = config.referralShareText;
                }
                
                // Special Task Settings
                if (config.watchAdSpecialTaskCount !== undefined) {
                    document.getElementById('watchAdSpecialTaskCount').value = config.watchAdSpecialTaskCount;
                }
                
                if (config.watchAdSpecialTaskReward !== undefined) {
                    document.getElementById('watchAdSpecialTaskReward').value = config.watchAdSpecialTaskReward;
                }
                
                if (config.watchAdSpecialTaskTimer !== undefined) {
                    document.getElementById('watchAdSpecialTaskTimer').value = config.watchAdSpecialTaskTimer;
                }
                
                if (config.colorGameSpecialTaskCount !== undefined) {
                    document.getElementById('colorGameSpecialTaskCount').value = config.colorGameSpecialTaskCount;
                }
                
                if (config.colorGameSpecialTaskReward !== undefined) {
                    document.getElementById('colorGameSpecialTaskReward').value = config.colorGameSpecialTaskReward;
                }
                
                if (config.colorGameSpecialTaskTimer !== undefined) {
                    document.getElementById('colorGameSpecialTaskTimer').value = config.colorGameSpecialTaskTimer;
                }
                
                if (config.ludoDiceSpecialTaskCount !== undefined) {
                    document.getElementById('ludoDiceSpecialTaskCount').value = config.ludoDiceSpecialTaskCount;
                }
                
                if (config.ludoDiceSpecialTaskReward !== undefined) {
                    document.getElementById('ludoDiceSpecialTaskReward').value = config.ludoDiceSpecialTaskReward;
                }
                
                if (config.ludoDiceSpecialTaskTimer !== undefined) {
                    document.getElementById('ludoDiceSpecialTaskTimer').value = config.ludoDiceSpecialTaskTimer;
                }
                
                // IP Info Settings
                if (config.ipinfoApiToken) {
                    document.getElementById('ipinfoApiToken').value = config.ipinfoApiToken;
                }
                
                if (config.allowedCountries && Array.isArray(config.allowedCountries)) {
                    document.getElementById('allowedCountries').value = config.allowedCountries.join(', ');
                }
                
            } catch (error) {
                console.error("Error loading settings:", error);
                showAlert("❌ Error loading settings", true);
            }
        }

        async function saveAllSettings() {
            loader.style.display = 'flex';
            
            try {
                // Collect all settings from form
                const settings = {
                    // Payment Settings
                    minWithdrawal: parseInt(document.getElementById('minWithdrawal').value) || 1000,
                    conversionRatePoints: parseInt(document.getElementById('conversionRatePoints').value) || 1000,
                    conversionRateTaka: parseInt(document.getElementById('conversionRateTaka').value) || 10,
                    dailyAdLimit: parseInt(document.getElementById('dailyAdLimit').value) || 100,
                    adWatchReward: parseInt(document.getElementById('adWatchReward').value) || 10,
                    colorGameReward: parseInt(document.getElementById('colorGameReward').value) || 10,
                    ludoDiceReward: parseInt(document.getElementById('ludoDiceReward').value) || 5,
                    watchVideoReward: parseInt(document.getElementById('watchVideoReward').value) || 15,
                    tryYourLuckReward: parseInt(document.getElementById('tryYourLuckReward').value) || 50,
                    paymentMethods: document.getElementById('paymentMethods').value.split(',').map(s => s.trim()).filter(Boolean),
                    paymentVerification: document.getElementById('paymentVerification').checked,
                    
                    // Referral Settings
                    referralBonus: parseInt(document.getElementById('referralBonus').value) || 100,
                    referrerBonus: parseInt(document.getElementById('referrerBonus').value) || 50,
                    referralShareText: document.getElementById('referralShareText').value.trim() || "Use my code {CODE} to get {BONUS} points bonus! App link: {APP_LINK}",
                    
                    // Special Task Settings
                    watchAdSpecialTaskCount: parseInt(document.getElementById('watchAdSpecialTaskCount').value) || 10,
                    watchAdSpecialTaskReward: parseInt(document.getElementById('watchAdSpecialTaskReward').value) || 100,
                    watchAdSpecialTaskTimer: parseInt(document.getElementById('watchAdSpecialTaskTimer').value) || 60,
                    
                    colorGameSpecialTaskCount: parseInt(document.getElementById('colorGameSpecialTaskCount').value) || 20,
                    colorGameSpecialTaskReward: parseInt(document.getElementById('colorGameSpecialTaskReward').value) || 200,
                    colorGameSpecialTaskTimer: parseInt(document.getElementById('colorGameSpecialTaskTimer').value) || 45,
                    
                    ludoDiceSpecialTaskCount: parseInt(document.getElementById('ludoDiceSpecialTaskCount').value) || 30,
                    ludoDiceSpecialTaskReward: parseInt(document.getElementById('ludoDiceSpecialTaskReward').value) || 150,
                    ludoDiceSpecialTaskTimer: parseInt(document.getElementById('ludoDiceSpecialTaskTimer').value) || 30,
                    
                    // IP Info Settings
                    ipinfoApiToken: document.getElementById('ipinfoApiToken').value.trim(),
                    allowedCountries: document.getElementById('allowedCountries').value.split(',').map(s => s.trim().toLowerCase()).filter(Boolean),
                    
                    updatedAt: serverTimestamp()
                };
                
                // Save to Firebase
                await setDoc(doc(db, "config", "main"), settings);
                
                showToast("✅ All settings saved successfully!");
                loadUsers(); // Refresh users to show updated daily ad limit
                
            } catch (error) {
                console.error("Error saving settings:", error);
                showAlert("❌ Error saving settings: " + error.message, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        // FIXED: loadWebsitesConfig with proper URL validation
        async function loadWebsitesConfig() {
            try {
                const configSnap = await getDoc(doc(db, "config", "main"));
                const config = configSnap.data() || {};
                const websites = config.websitesToVisit || [];
                
                const container = document.getElementById('websites-to-visit-list');
                container.innerHTML = '';
                
                if (websites.length === 0) {
                    // Add default websites with proper https URLs
                    const defaultWebsites = [
                        { name: "Google", link: "https://www.google.com", reward: 10, timer: 30 },
                        { name: "YouTube", link: "https://www.youtube.com", reward: 15, timer: 45 },
                        { name: "Facebook", link: "https://www.facebook.com", reward: 20, timer: 60 }
                    ];
                    
                    defaultWebsites.forEach((site, index) => {
                        container.innerHTML += `
                            <div class="website-item">
                                <div class="website-field">
                                    <input type="text" placeholder="Website Name" value="${site.name}" data-field="name" class="text-gray-800">
                                </div>
                                <div class="website-field">
                                    <input type="url" placeholder="https://example.com" value="${site.link}" data-field="link" class="text-gray-800" required pattern="https?://.+">
                                </div>
                                <div class="website-field">
                                    <input type="number" placeholder="Reward" value="${site.reward}" data-field="reward" class="text-gray-800" min="1">
                                </div>
                                <div class="website-field">
                                    <input type="number" placeholder="Timer (sec)" value="${site.timer}" data-field="timer" class="text-gray-800" min="10">
                                </div>
                                <button onclick="removeWebsite(this)" class="btn btn-danger">×</button>
                            </div>
                        `;
                    });
                } else {
                    websites.forEach((site, index) => {
                        // Ensure URL has proper format
                        let link = site.link;
                        if (link && !link.startsWith('http://') && !link.startsWith('https://')) {
                            link = 'https://' + link;
                        }
                        
                        container.innerHTML += `
                            <div class="website-item">
                                <div class="website-field">
                                    <input type="text" placeholder="Website Name" value="${site.name}" data-field="name" class="text-gray-800">
                                </div>
                                <div class="website-field">
                                    <input type="url" placeholder="https://example.com" value="${link}" data-field="link" class="text-gray-800" required pattern="https?://.+">
                                </div>
                                <div class="website-field">
                                    <input type="number" placeholder="Reward" value="${site.reward}" data-field="reward" class="text-gray-800" min="1">
                                </div>
                                <div class="website-field">
                                    <input type="number" placeholder="Timer (sec)" value="${site.timer}" data-field="timer" class="text-gray-800" min="10">
                                </div>
                                <button onclick="removeWebsite(this)" class="btn btn-danger">×</button>
                            </div>
                        `;
                    });
                }
            } catch (error) {
                console.error("Error loading website config:", error);
                showAlert("❌ Error loading website configurations: " + error.message, true);
            }
        }

        function addNewWebsite() {
            const container = document.getElementById('websites-to-visit-list');
            container.innerHTML += `
                <div class="website-item">
                    <div class="website-field">
                        <input type="text" placeholder="Website Name" value="" data-field="name" class="text-gray-800" required>
                    </div>
                    <div class="website-field">
                        <input type="url" placeholder="https://example.com" value="" data-field="link" class="text-gray-800" required pattern="https?://.+">
                    </div>
                    <div class="website-field">
                        <input type="number" placeholder="Reward" value="10" data-field="reward" class="text-gray-800" min="1">
                    </div>
                    <div class="website-field">
                        <input type="number" placeholder="Timer (sec)" value="30" data-field="timer" class="text-gray-800" min="10">
                    </div>
                    <button onclick="removeWebsite(this)" class="btn btn-danger">×</button>
                </div>
            `;
        }

        function removeWebsite(button) {
            const item = button.closest('.website-item');
            if (item) {
                item.remove();
            }
        }

        // FIXED: saveWebsiteConfig with URL validation
        async function saveWebsiteConfig() {
            loader.style.display = 'flex';
            try {
                // Get website configurations from the UI
                const websites = [];
                const websiteItems = document.querySelectorAll('#websites-to-visit-list .website-item');
                
                let hasErrors = false;
                
                websiteItems.forEach(item => {
                    const name = item.querySelector('[data-field="name"]').value.trim();
                    let link = item.querySelector('[data-field="link"]').value.trim();
                    const reward = parseInt(item.querySelector('[data-field="reward"]').value) || 10;
                    const timer = parseInt(item.querySelector('[data-field="timer"]').value) || 30;
                    
                    // Validate URL
                    if (link && !link.startsWith('http://') && !link.startsWith('https://')) {
                        link = 'https://' + link;
                    }
                    
                    // Validate required fields
                    if (!name || !link) {
                        hasErrors = true;
                        item.style.border = '2px solid #ef4444';
                        return;
                    }
                    
                    // Validate URL format
                    try {
                        new URL(link);
                    } catch (e) {
                        hasErrors = true;
                        item.style.border = '2px solid #ef4444';
                        return;
                    }
                    
                    item.style.border = '';
                    
                    websites.push({
                        name: name,
                        link: link,
                        reward: reward,
                        timer: timer
                    });
                });
                
                if (hasErrors) {
                    showAlert("❌ Please check all website entries. Make sure name and valid URL (starting with http:// or https://) are provided.");
                    return;
                }
                
                if (websites.length === 0) {
                    showAlert("❌ Please add at least one website.");
                    return;
                }
                
                // Save to Firebase
                const configRef = doc(db, "config", "main");
                await updateDoc(configRef, {
                    websitesToVisit: websites,
                    updatedAt: serverTimestamp()
                });
                
                showToast('✅ Website configurations saved successfully!');
                console.log('Saved websites:', websites);
                
            } catch (error) {
                console.error("Error saving website config:", error);
                showAlert('❌ Error saving website configurations: ' + error.message, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        async function resetWebsiteVisitHistory() {
            showConfirm("Are you sure you want to reset website visit history for ALL users? This will allow all users to visit websites again for rewards.", async () => {
                loader.style.display = 'flex';
                try {
                    // Get all users
                    const usersSnap = await getDocs(collection(db, "users"));
                    const batch = writeBatch(db);
                    
                    // Reset visitedWebsitesToday for each user
                    usersSnap.forEach((userDoc) => {
                        const userRef = doc(db, "users", userDoc.id);
                        batch.update(userRef, { 
                            visitedWebsitesToday: [],
                            lastWebsiteVisitDate: '1970-01-01'
                        });
                    });
                    
                    await batch.commit();
                    showToast("✅ Website visit history reset successfully for all users!");
                } catch (error) {
                    console.error("Error resetting website history:", error);
                    showAlert("❌ Error resetting website history: " + error.message, true);
                } finally {
                    loader.style.display = 'none';
                }
            });
        }

        async function testIpinfoApi() {
            const apiToken = document.getElementById('ipinfoApiToken').value.trim();
            
            if (!apiToken) {
                showAlert("Please enter an API token to test.");
                return;
            }
            
            loader.style.display = 'flex';
            try {
                // Test the API with a sample IP
                const response = await fetch(`https://api.ipinfo.io/lite/8.8.8.8?token=${apiToken}`);
                
                if (!response.ok) {
                    throw new Error(`API returned status: ${response.status}`);
                }
                
                const data = await response.text();
                const country = data.trim(); // IPinfo lite API returns just the country code
                
                if (country && country.length === 2) {
                    showAlert(`✅ API Test Successful! Detected country: ${country}`);
                } else {
                    showAlert(`⚠️ API responded but didn't return a valid country code. Response: "${data}"`);
                }
            } catch (error) {
                console.error("IPinfo API test error:", error);
                showAlert(`❌ API Test Failed: ${error.message}. Check your token.`, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        // User Point History Functions
        async function viewUserPointHistory(userId, userName) {
            currentViewingUserId = userId;
            document.getElementById('history-user-name').textContent = userName;
            document.getElementById('history-user-id').textContent = userId;
            
            loader.style.display = 'flex';
            try {
                // Get current user balance
                const userSnap = await getDoc(doc(db, "users", userId));
                const userData = userSnap.exists() ? userSnap.data() : {};
                document.getElementById('current-user-balance').textContent = userData.balance || 0;
                
                // Get point history
                const historySnap = await getDocs(query(
                    collection(db, "pointHistory"),
                    where("userId", "==", userId),
                    orderBy("timestamp", "desc")
                ));
                
                let totalPointsEarned = 0;
                let totalPointsSpent = 0;
                let html = '';
                
                if (historySnap.empty) {
                    html = `<tr><td colspan="5" class="text-center py-4 text-gray-500">No point history found for this user</td></tr>`;
                } else {
                    historySnap.forEach(doc => {
                        const history = doc.data();
                        const points = history.points || 0;
                        
                        // Calculate totals
                        if (points > 0) {
                            totalPointsEarned += points;
                        } else {
                            totalPointsSpent += Math.abs(points);
                        }
                        
                        const taskLabels = {
                            'ad_watch': 'Ad Watch',
                            'color_game': 'Color Game',
                            'website_visit': 'Website Visit',
                            'referral': 'Referral Bonus',
                            'withdrawal': 'Withdrawal',
                            'admin_adjustment': 'Admin Adjustment',
                            'game_play': 'Game Play',
                            'special_task': 'Special Task',
                            'try_your_luck': 'Try Your Luck',
                            'ludo_dice': 'Ludo Dice',
                            'ludo_cost': 'Ludo Game Cost',
                            'withdrawal_deduct': 'Withdrawal Deduction',
                            'game_cost': 'Game Cost',
                            'withdrawal_refund': 'Withdrawal Refund'
                        };
                        
                        const timestamp = history.timestamp?.toDate().toLocaleString() || 'N/A';
                        const pointsClass = points > 0 ? 'text-green-600' : 'text-red-600';
                        const pointsSign = points > 0 ? '+' : '';
                        const country = history.country || 'N/A';
                        const taskName = taskLabels[history.taskType] || history.taskType || 'Unknown';
                        
                        html += `<tr class="border-b">
                            <td class="px-4 py-2 text-sm text-gray-700">${timestamp}</td>
                            <td class="px-4 py-2 text-gray-700">${taskName}</td>
                            <td class="px-4 py-2 font-semibold ${pointsClass}">${pointsSign}${points}</td>
                            <td class="px-4 py-2 text-gray-700">${country}</td>
                            <td class="px-4 py-2 text-gray-600">${history.details || ''}</td>
                        </tr>`;
                    });
                }
                
                document.getElementById('total-points-earned').textContent = totalPointsEarned;
                document.getElementById('total-points-spent').textContent = totalPointsSpent;
                document.getElementById('user-point-history-body').innerHTML = html;
                document.getElementById('user-point-history-modal').style.display = 'flex';
            } catch (error) {
                console.error("Error loading point history:", error);
                showAlert("❌ Error loading point history: " + error.message, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        function closePointHistoryModal() {
            document.getElementById('user-point-history-modal').style.display = 'none';
            currentViewingUserId = null;
        }

        // Utility Functions
        function showAlert(message, isError = false) {
            const alertBox = document.getElementById('custom-alert');
            const msgEl = document.getElementById('alert-message');
            if (alertBox && msgEl) {
                msgEl.textContent = message;
                alertBox.classList.remove('hidden');
            }
        }

        function showConfirm(message, onConfirm) {
            document.getElementById('confirm-message').textContent = message;
            const confirmModal = document.getElementById('custom-confirm');
            confirmModal.classList.remove('hidden');
            
            // Create new buttons to avoid duplicate listeners
            const oldOkBtn = document.getElementById('confirm-ok-btn');
            const oldCancelBtn = document.getElementById('confirm-cancel-btn');
            
            const newOkBtn = oldOkBtn.cloneNode(true);
            const newCancelBtn = oldCancelBtn.cloneNode(true);
            
            oldOkBtn.parentNode.replaceChild(newOkBtn, oldOkBtn);
            oldCancelBtn.parentNode.replaceChild(newCancelBtn, oldCancelBtn);
            
            newOkBtn.addEventListener('click', () => {
                confirmModal.classList.add('hidden');
                onConfirm();
            });
            
            newCancelBtn.addEventListener('click', () => {
                confirmModal.classList.add('hidden');
            });
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            
            if (!toast || !toastMessage) return;

            toastMessage.textContent = message;
            toast.className = `fixed top-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 z-50 ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.remove('opacity-0'), 50);

            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 500);
            }, 3000);
        }

        // Make functions available globally
        window.toggleActive = toggleActive;
        window.editUserPoints = editUserPoints;
        window.saveUserPoints = saveUserPoints;
        window.closeEditPointsModal = closeEditPointsModal;
        window.viewUserDetails = viewUserDetails;
        window.closeUserDetailsModal = closeUserDetailsModal;
        window.searchUsers = searchUsers;
        window.migrateExistingUsers = migrateExistingUsers;
        window.loadUsersForAdmin = loadUsersForAdmin;
        window.displayUsersInAdminPanel = displayUsersInAdminPanel;
        window.deleteUser = deleteUser;
        window.toggleUserSelection = toggleUserSelection;
        window.toggleSelectAllUsers = toggleSelectAllUsers;
        window.toggleTableSelectAll = toggleTableSelectAll;
        window.deleteSelectedUsers = deleteSelectedUsers;
        window.toggleSidebar = toggleSidebar;
        window.resetUserPlayLimits = resetUserPlayLimits;
        
        // Custom message functions
        window.openCustomMessageModal = openCustomMessageModal;
        window.openCustomMessageModalFromUsers = openCustomMessageModalFromUsers;
        window.closeCustomMessageModal = closeCustomMessageModal;
        window.searchUserByTelegramId = searchUserByTelegramId;
        window.sendCustomMessage = sendCustomMessage;
        window.sendDirectMessage = sendDirectMessage;
        window.sendCustomMessageToSelected = sendCustomMessageToSelected;
        window.toggleMessageType = toggleMessageType;
        window.toggleRecipientType = toggleRecipientType;
        window.viewMessageDetails = viewMessageDetails;
        
        // Original functions
        window.processWithdrawal = processWithdrawal;
        window.filterWithdrawals = filterWithdrawals;
        window.testTelegramConnection = testTelegramConnection;
        window.saveTelegramConfig = saveTelegramConfig;
        window.viewUserPointHistory = viewUserPointHistory;
        window.closePointHistoryModal = closePointHistoryModal;
        window.testIpinfoApi = testIpinfoApi;
        window.resetWebsiteVisitHistory = resetWebsiteVisitHistory;
        window.addNewWebsite = addNewWebsite;
        window.removeWebsite = removeWebsite;
        window.saveWebsiteConfig = saveWebsiteConfig;
        window.saveAllSettings = saveAllSettings;
        window.saveAdNetworkConfig = saveAdNetworkConfig;
        
        // Game Management functions
        window.openQuickSettings = openQuickSettings;
        window.closeQuickSettingsModal = closeQuickSettingsModal;
        window.saveQuickGameSettings = saveQuickGameSettings;
        window.applyGlobalPlayLimit = applyGlobalPlayLimit;
        window.applyGlobalReward = applyGlobalReward;
        window.showAllGames = showAllGames;
        window.hideAllGames = hideAllGames;
        window.syncAllGameSettings = syncAllGameSettings;
        window.resetAllGameStats = resetAllGameStats;
    </script>
</body>
</html>
