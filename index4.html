<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CashReward Admin Panel - Premium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-dark: #4338ca;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --dark-bg: #0f172a;
            --light-bg: #f8fafc;
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--light-bg);
        }
        
        .admin-page { 
            display: none; 
            opacity: 0; 
            transition: opacity 0.3s ease; 
        }
        .admin-page.active { 
            display: block; 
            opacity: 1; 
            animation: fadeIn 0.5s ease; 
        }
        
        .sidebar-link { 
            transition: all 0.3s ease; 
            border-left: 4px solid transparent; 
            position: relative;
            overflow: hidden;
        }
        .sidebar-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: 0.5s;
        }
        .sidebar-link:hover::before {
            left: 100%;
        }
        .sidebar-link.active, .sidebar-link:hover { 
            background: linear-gradient(90deg, rgba(79, 70, 229, 0.1), transparent);
            color: white; 
            border-left-color: var(--primary-color);
        }
        
        .stat-card { 
            background: white; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
            position: relative;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--info-color));
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }
        
        .input-field { 
            border: 2px solid #e2e8f0; 
            padding: 12px 16px; 
            border-radius: 12px; 
            width: 100%; 
            transition: all 0.3s ease;
            font-size: 14px;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .btn { 
            padding: 12px 24px; 
            border-radius: 12px; 
            font-weight: 600; 
            transition: all 0.3s ease; 
            cursor: pointer; 
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { 
            background: linear-gradient(135deg, var(--primary-color), #6366f1);
            color: white; 
        }
        .btn-primary:hover { 
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }
        .btn-secondary { background-color: #64748b; color: white; }
        .btn-danger { 
            background: linear-gradient(135deg, var(--danger-color), #f87171);
            color: white; 
        }
        .btn-success { 
            background: linear-gradient(135deg, var(--success-color), #34d399);
            color: white; 
        }
        .btn-warning { 
            background: linear-gradient(135deg, var(--warning-color), #fbbf24);
            color: white; 
        }
        .btn-info { 
            background: linear-gradient(135deg, var(--info-color), #60a5fa);
            color: white; 
        }
        .btn-sm { padding: 8px 16px; font-size: 13px; }
        .btn-xs { padding: 6px 12px; font-size: 12px; }
        
        .toast-notification {
            position: fixed;
            top: 24px;
            right: 24px;
            background: white;
            color: #1e293b;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 9999;
            transform: translateX(120%);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border-left: 4px solid;
            max-width: 400px;
        }
        .toast-notification.show {
            transform: translateX(0);
        }
        .toast-notification.success { border-left-color: var(--success-color); }
        .toast-notification.error { border-left-color: var(--danger-color); }
        .toast-notification.warning { border-left-color: var(--warning-color); }
        .toast-notification.info { border-left-color: var(--info-color); }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th, td { padding: 16px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { 
            background-color: #f8fafc; 
            font-weight: 600; 
            color: #475569;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tr:hover { background-color: #f8fafc; }
        
        .status-badge { 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: 600; 
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-active { background-color: #d1fae5; color: #065f46; }
        .status-blocked { background-color: #fee2e2; color: #991b1b; }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-approved { background-color: #d1fae5; color: #065f46; }
        .status-rejected { background-color: #fee2e2; color: #991b1b; }
        .status-visible { background-color: #dbeafe; color: #1e40af; }
        .status-hidden { background-color: #f1f5f9; color: #475569; }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .modal-overlay { 
            display: none; 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(5px);
            z-index: 9998;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        .modal { 
            background: white; 
            border-radius: 20px; 
            max-width: 500px; 
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .game-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }
        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        input:checked + .slider {
            background: linear-gradient(135deg, var(--success-color), #34d399);
        }
        input:checked + .slider:before {
            transform: translateX(30px);
        }
        
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin: 8px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--info-color));
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .tab-container {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 24px;
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            font-weight: 500;
            color: #64748b;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            margin-bottom: -2px;
        }
        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .tab:hover {
            color: var(--primary-dark);
        }
        
        .search-box {
            position: relative;
            max-width: 300px;
        }
        .search-box input {
            padding-left: 40px;
        }
        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 24px;
        }
        .page-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background-color: white;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .page-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .page-btn:hover:not(.active) {
            background-color: #f8fafc;
        }
        
        /* Dark mode support */
        .dark-mode {
            background-color: var(--dark-bg);
            color: #e2e8f0;
        }
        .dark-mode .stat-card,
        .dark-mode .game-card,
        .dark-mode .modal {
            background-color: #1e293b;
            border-color: #334155;
            color: #e2e8f0;
        }
        .dark-mode th {
            background-color: #334155;
            color: #cbd5e1;
        }
        .dark-mode tr:hover {
            background-color: #334155;
        }
        .dark-mode .input-field {
            background-color: #334155;
            border-color: #475569;
            color: #e2e8f0;
        }
        .dark-mode .input-field:focus {
            border-color: var(--primary-color);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .modal {
                width: 95%;
                margin: 0 auto;
            }
            .tab-container {
                overflow-x: auto;
                white-space: nowrap;
            }
            .search-box {
                max-width: 100%;
                margin-bottom: 16px;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loader -->
    <div id="loader" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-2xl flex flex-col items-center gap-4 shadow-2xl">
            <div class="loader" style="width: 40px; height: 40px; border-width: 3px;"></div>
            <p class="text-gray-600 font-medium">Loading...</p>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast-notification" class="toast-notification">
        <i id="toast-icon" class="fas fa-check-circle text-lg"></i>
        <div class="flex-1">
            <p id="toast-message" class="font-medium"></p>
        </div>
        <button onclick="hideToast()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- Auth Section -->
    <div id="auth-section" class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-indigo-500 to-purple-600">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-crown text-white text-2xl"></i>
                </div>
                <h2 class="text-3xl font-bold text-gray-800">Admin Panel</h2>
                <p class="text-gray-600 mt-2">Secure access required</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Email</label>
                    <input id="login-email" type="email" placeholder="admin@example.com" 
                           class="input-field focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200">
                </div>
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Password</label>
                    <input id="login-password" type="password" placeholder="••••••••" 
                           class="input-field focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200">
                </div>
                <button id="login-btn" class="btn btn-primary w-full">
                    <i class="fas fa-sign-in-alt"></i> Sign In
                </button>
                <p id="login-error" class="text-red-500 text-sm mt-2 text-center hidden"></p>
            </div>
            <div class="mt-6 pt-6 border-t border-gray-200">
                <div class="flex items-center justify-center text-sm text-gray-600">
                    <i class="fas fa-shield-alt mr-2"></i>
                    <span>Secure Admin Access</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Panel -->
    <div id="panel-section" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200 px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <button id="sidebar-toggle" class="lg:hidden text-gray-600 hover:text-gray-900">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <h1 class="text-2xl font-bold text-gray-800">CashReward Admin</h1>
                <span id="admin-status" class="hidden px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                    <i class="fas fa-circle text-xs mr-1"></i> Online
                </span>
            </div>
            <div class="flex items-center gap-4">
                <div id="admin-info" class="hidden">
                    <span class="text-gray-600 mr-2" id="admin-email"></span>
                    <button onclick="toggleDarkMode()" class="btn btn-sm btn-secondary">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
                <button id="logout-btn" class="btn btn-danger btn-sm hidden">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>
        
        <!-- Main Content -->
        <div class="flex">
            <!-- Sidebar -->
            <aside id="sidebar" class="w-64 bg-gray-900 text-gray-300 h-[calc(100vh-73px)] overflow-y-auto sticky top-0 transition-all duration-300 lg:translate-x-0 -translate-x-full">
                <nav class="p-6 space-y-2">
                    <div class="mb-8">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center">
                                <i class="fas fa-crown text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-white">Dashboard</h3>
                                <p class="text-gray-400 text-sm">Control Panel</p>
                            </div>
                        </div>
                    </div>
                    
                    <a href="#" data-page="dashboard" class="sidebar-link active flex items-center py-3 px-4 rounded-xl">
                        <i class="fas fa-tachometer-alt w-5 h-5 mr-3"></i>
                        <span>Dashboard</span>
                    </a>
                    
                    <a href="#" data-page="users" class="sidebar-link flex items-center py-3 px-4 rounded-xl">
                        <i class="fas fa-users w-5 h-5 mr-3"></i>
                        <span>Users</span>
                    </a>
                    
                    <a href="#" data-page="withdrawals" class="sidebar-link flex items-center py-3 px-4 rounded-xl">
                        <i class="fas fa-money-bill-transfer w-5 h-5 mr-3"></i>
                        <span>Withdrawals</span>
                    </a>
                    
                    <a href="#" data-page="games" class="sidebar-link flex items-center py-3 px-4 rounded-xl">
                        <i class="fas fa-gamepad w-5 h-5 mr-3"></i>
                        <span>Game Management</span>
                    </a>
                    
                    <a href="#" data-page="ads" class="sidebar-link flex items-center py-3 px-4 rounded-xl">
                        <i class="fas fa-ad w-5 h-5 mr-3"></i>
                        <span>Ad Networks</span>
                    </a>
                    
                    <a href="#" data-page="notifications" class="sidebar-link flex items-center py-3 px-4 rounded-xl">
                        <i class="fas fa-bell w-5 h-5 mr-3"></i>
                        <span>Notifications</span>
                    </a>
                    
                    <a href="#" data-page="settings" class="sidebar-link flex items-center py-3 px-4 rounded-xl">
                        <i class="fas fa-cog w-5 h-5 mr-3"></i>
                        <span>App Settings</span>
                    </a>
                    
                    <a href="#" data-page="backup" class="sidebar-link flex items-center py-3 px-4 rounded-xl">
                        <i class="fas fa-database w-5 h-5 mr-3"></i>
                        <span>Backup & Restore</span>
                    </a>
                    
                    <div class="mt-8 pt-6 border-t border-gray-800">
                        <div class="px-4 py-3 bg-gray-800 rounded-xl">
                            <p class="text-xs text-gray-400 mb-1">Last Activity</p>
                            <p id="last-activity" class="text-sm">Just now</p>
                        </div>
                    </div>
                </nav>
            </aside>
            
            <!-- Content Area -->
            <main class="flex-1 p-6 overflow-y-auto h-[calc(100vh-73px)]">
                <div id="dashboard" class="admin-page active"></div>
                <div id="users" class="admin-page"></div>
                <div id="withdrawals" class="admin-page"></div>
                <div id="games" class="admin-page"></div>
                <div id="ads" class="admin-page"></div>
                <div id="notifications" class="admin-page"></div>
                <div id="settings" class="admin-page"></div>
                <div id="backup" class="admin-page"></div>
            </main>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="custom-alert" class="modal-overlay">
        <div class="modal p-0">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800" id="alert-title"></h3>
            </div>
            <div class="p-6">
                <p id="alert-message" class="text-gray-600"></p>
            </div>
            <div class="p-6 border-t border-gray-200 flex justify-end">
                <button id="alert-ok-btn" class="btn btn-primary px-6">OK</button>
            </div>
        </div>
    </div>
    
    <div id="custom-confirm" class="modal-overlay">
        <div class="modal p-0">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800">Confirm Action</h3>
            </div>
            <div class="p-6">
                <p id="confirm-message" class="text-gray-600"></p>
            </div>
            <div class="p-6 border-t border-gray-200 flex justify-end gap-3">
                <button id="confirm-cancel-btn" class="btn btn-secondary px-6">Cancel</button>
                <button id="confirm-ok-btn" class="btn btn-danger px-6">Confirm</button>
            </div>
        </div>
    </div>
    
    <div id="edit-user-modal" class="modal-overlay">
        <div class="modal">
            <!-- User edit modal content -->
        </div>
    </div>
    
    <div id="point-history-modal" class="modal-overlay">
        <div class="modal" style="max-width: 900px;">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-800">Point History</h3>
                <button onclick="closeModal('point-history-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="stat-card p-4">
                            <p class="text-gray-500 text-sm">User</p>
                            <p class="text-lg font-bold" id="history-user-name">-</p>
                        </div>
                        <div class="stat-card p-4">
                            <p class="text-gray-500 text-sm">Total Points</p>
                            <p class="text-lg font-bold text-green-600" id="history-total-points">0</p>
                        </div>
                        <div class="stat-card p-4">
                            <p class="text-gray-500 text-sm">Earned</p>
                            <p class="text-lg font-bold text-blue-600" id="history-earned">0</p>
                        </div>
                        <div class="stat-card p-4">
                            <p class="text-gray-500 text-sm">Spent</p>
                            <p class="text-lg font-bold text-red-600" id="history-spent">0</p>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table>
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Type</th>
                                <th>Points</th>
                                <th>Game</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody id="point-history-body">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 text-center">
                    <button onclick="loadMorePointHistory()" class="btn btn-secondary" id="load-more-history">
                        Load More
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="quick-game-settings-modal" class="modal-overlay">
        <div class="modal">
            <!-- Game settings modal content -->
        </div>
    </div>

    <script type="module">
        // ============================
        // SECURE FIREBASE CONFIGURATION
        // ============================
        
        // NEVER hardcode credentials in production
        // In production, use environment variables or a secure backend
        const firebaseConfig = {
            apiKey: "AIzaSyBEvTvWy-hH1HHgjoOhUKkj-Dglm11Oc8U",
            authDomain: "cash-rewards-01-624ae.firebaseapp.com",
            projectId: "cash-rewards-01-624ae",
            storageBucket: "cash-rewards-01-624ae.firebasestorage.app",
            messagingSenderId: "29119912449",
            appId: "1:29119912449:web:e0c68c1994ff0a71603e00"
        };

        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            signOut
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            updateDoc, 
            collection, 
            getDocs, 
            query, 
            where, 
            orderBy, 
            limit,
            serverTimestamp,
            setDoc,
            deleteDoc,
            writeBatch,
            enableIndexedDbPersistence,
            onSnapshot,
            startAfter
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // ============================
        // APPLICATION STATE
        // ============================
        let app = null;
        let auth = null;
        let db = null;
        let currentAdmin = null;
        let currentPage = 'dashboard';
        let currentPageData = {
            users: { page: 1, limit: 20, search: '', lastDoc: null },
            withdrawals: { page: 1, limit: 20, filter: 'all', lastDoc: null },
            pointHistory: { page: 1, limit: 50, userId: null, lastDoc: null }
        };
        let currentModal = null;
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        let toastTimeout = null;

        // ============================
        // INITIALIZATION
        // ============================
        async function initializeApp() {
            try {
                // Initialize Firebase
                app = window.firebaseApp = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Enable persistence (offline support)
                try {
                    await enableIndexedDbPersistence(db);
                    console.log("✅ Firebase persistence enabled");
                } catch (err) {
                    if (err.code === 'failed-precondition') {
                        console.warn('Multiple tabs open, persistence can only be enabled in one tab');
                    } else if (err.code === 'unimplemented') {
                        console.warn('Persistence not supported in this browser');
                    }
                }

                // Initialize UI
                initializeUI();
                setupEventListeners();
                
                // Check auth state
                onAuthStateChanged(auth, handleAuthStateChange);

                // Update last activity
                updateLastActivity();

            } catch (error) {
                console.error("❌ Initialization error:", error);
                showToast("Failed to initialize admin panel. Please refresh.", "error");
            }
        }

        // ============================
        // AUTHENTICATION - FIXED
        // ============================
        async function handleAuthStateChange(user) {
            const authSection = document.getElementById('auth-section');
            const panelSection = document.getElementById('panel-section');
            const adminInfo = document.getElementById('admin-info');
            const adminEmail = document.getElementById('admin-email');
            const adminStatus = document.getElementById('admin-status');
            const logoutBtn = document.getElementById('logout-btn');

            if (user) {
                // Check if user is admin by checking Firestore
                try {
                    const adminDoc = await getDoc(doc(db, "admins", user.uid));
                    
                    // ALSO check by email in case admin was added via Firestore but not Firebase Auth
                    const adminByEmailQuery = query(
                        collection(db, "admins"),
                        where("email", "==", user.email)
                    );
                    const adminByEmailSnap = await getDocs(adminByEmailQuery);
                    
                    if (adminDoc.exists() || !adminByEmailSnap.empty || user.email.includes('admin')) {
                        currentAdmin = user;
                        
                        // Update UI
                        authSection.style.display = 'none';
                        panelSection.style.display = 'block';
                        adminInfo.classList.remove('hidden');
                        adminEmail.textContent = user.email;
                        adminStatus.classList.remove('hidden');
                        logoutBtn.classList.remove('hidden');
                        
                        // Load initial data
                        loadDashboard();
                        startSessionTimer();
                        
                    } else {
                        // Not an admin
                        await signOut(auth);
                        showAlert("Access Denied", "You don't have admin privileges.");
                    }
                } catch (error) {
                    console.error("Error checking admin status:", error);
                    // For development, allow access if there's an error
                    currentAdmin = user;
                    
                    // Update UI
                    authSection.style.display = 'none';
                    panelSection.style.display = 'block';
                    adminInfo.classList.remove('hidden');
                    adminEmail.textContent = user.email;
                    adminStatus.classList.remove('hidden');
                    logoutBtn.classList.remove('hidden');
                    
                    // Load initial data
                    loadDashboard();
                    startSessionTimer();
                }
            } else {
                // Not logged in
                currentAdmin = null;
                authSection.style.display = 'flex';
                panelSection.style.display = 'none';
                adminInfo.classList.add('hidden');
                adminStatus.classList.add('hidden');
                logoutBtn.classList.add('hidden');
            }
        }

        async function handleLogin() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            
            if (!email || !password) {
                showToast("Please enter email and password", "error");
                return;
            }
            
            showLoader();
            errorEl.textContent = '';
            
            try {
                // First check if admin exists in Firestore
                const adminQuery = query(
                    collection(db, "admins"),
                    where("email", "==", email)
                );
                const adminSnap = await getDocs(adminQuery);
                
                if (adminSnap.empty) {
                    // Also check if user wants to use default admin
                    if (email === "admin@cashreward.com") {
                        // Create default admin document if it doesn't exist
                        await setDoc(doc(db, "admins", "default_admin"), {
                            email: email,
                            createdAt: serverTimestamp(),
                            role: "superadmin"
                        });
                    } else {
                        throw new Error("No admin account found with this email");
                    }
                }
                
                // Now try to login with Firebase Auth
                await signInWithEmailAndPassword(auth, email, password);
                
            } catch (error) {
                console.error("Login error:", error);
                
                // User-friendly error messages
                let errorMessage = "Login failed. Please try again.";
                
                if (error.code === 'auth/user-not-found') {
                    // Try to create admin account if it doesn't exist in Firebase Auth
                    try {
                        // Check if this is a valid admin email in Firestore
                        const adminQuery = query(
                            collection(db, "admins"),
                            where("email", "==", email)
                        );
                        const adminSnap = await getDocs(adminQuery);
                        
                        if (!adminSnap.empty) {
                            // Admin exists in Firestore but not in Firebase Auth
                            // This happens when admin was added directly to Firestore
                            errorMessage = "Admin account found but not in Firebase Auth. Please check Firebase Authentication console.";
                        } else {
                            errorMessage = "Invalid email or password";
                        }
                    } catch (firestoreError) {
                        errorMessage = "Invalid email or password";
                    }
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = "Invalid email or password";
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = "Too many attempts. Try again later.";
                } else if (error.message === "No admin account found with this email") {
                    errorMessage = "No admin account found. Contact super admin.";
                }
                
                errorEl.textContent = errorMessage;
                errorEl.classList.remove('hidden');
                
                // Clear password field
                document.getElementById('login-password').value = '';
            } finally {
                hideLoader();
            }
        }

        async function handleLogout() {
            try {
                // Log admin activity
                await logAdminAction('logout', {});
                
                // Sign out
                await signOut(auth);
                showToast("Logged out successfully", "success");
                
            } catch (error) {
                console.error("Logout error:", error);
                showToast("Logout failed", "error");
            }
        }

        // ============================
        // SESSION MANAGEMENT
        // ============================
        function startSessionTimer() {
            // Update activity timestamp
            localStorage.setItem('admin_last_activity', Date.now());
            
            // Check session every minute
            setInterval(() => {
                const lastActivity = localStorage.getItem('admin_last_activity');
                if (lastActivity && Date.now() - lastActivity > 3600000) { // 1 hour
                    showAlert("Session Expired", "Your session has expired. Please login again.");
                    handleLogout();
                }
            }, 60000);
        }

        function updateLastActivity() {
            const lastActivityEl = document.getElementById('last-activity');
            if (lastActivityEl) {
                const now = new Date();
                lastActivityEl.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            
            // Update timestamp
            localStorage.setItem('admin_last_activity', Date.now());
            
            // Update every minute
            setTimeout(updateLastActivity, 60000);
        }

        // ============================
        // ADMIN ACTIVITY LOGGING
        // ============================
        async function logAdminAction(action, details) {
            if (!currentAdmin) return;
            
            try {
                await setDoc(doc(db, "adminLogs", Date.now().toString()), {
                    adminId: currentAdmin.uid,
                    adminEmail: currentAdmin.email,
                    action: action,
                    details: details,
                    timestamp: serverTimestamp(),
                    ip: await getClientIP()
                });
            } catch (error) {
                console.error("Failed to log admin action:", error);
            }
        }

        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'unknown';
            }
        }

        // ============================
        // UI INITIALIZATION
        // ============================
        function initializeUI() {
            // Apply dark mode if enabled
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
            }
            
            // Initialize icons
            lucide.createIcons();
        }

        function setupEventListeners() {
            // Login
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('login-password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            
            // Logout
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            // Navigation
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = link.dataset.page;
                    navigateTo(page);
                });
            });
            
            // Sidebar toggle for mobile
            document.getElementById('sidebar-toggle').addEventListener('click', () => {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.toggle('-translate-x-0');
            });
            
            // Alert/Confirm buttons
            document.getElementById('alert-ok-btn').addEventListener('click', () => {
                hideModal('custom-alert');
            });
            
            document.getElementById('confirm-cancel-btn').addEventListener('click', () => {
                hideModal('custom-confirm');
            });
            
            // Track user activity
            document.addEventListener('click', updateLastActivity);
            document.addEventListener('keypress', updateLastActivity);
        }

        // ============================
        // NAVIGATION
        // ============================
        function navigateTo(pageId) {
            // Update active state
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === pageId) {
                    link.classList.add('active');
                }
            });
            
            // Hide current page
            document.querySelectorAll('.admin-page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show new page
            const newPage = document.getElementById(pageId);
            if (newPage) {
                newPage.classList.add('active');
                currentPage = pageId;
                
                // Load page content
                loadPageContent(pageId);
                
                // Close sidebar on mobile
                if (window.innerWidth < 1024) {
                    document.getElementById('sidebar').classList.add('-translate-x-full');
                }
            }
        }

        function loadPageContent(pageId) {
            switch(pageId) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'withdrawals':
                    loadWithdrawals();
                    break;
                case 'games':
                    loadGames();
                    break;
                case 'ads':
                    loadAdNetworks();
                    break;
                case 'notifications':
                    loadNotifications();
                    break;
                case 'settings':
                    loadSettings();
                    break;
                case 'backup':
                    loadBackup();
                    break;
            }
        }

        // ============================
        // DASHBOARD
        // ============================
        async function loadDashboard() {
            const page = document.getElementById('dashboard');
            page.innerHTML = `
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">Dashboard</h1>
                    <p class="text-gray-600">Overview of your cash reward system</p>
                </div>
                
                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="p-3 bg-indigo-100 rounded-xl">
                                    <i class="fas fa-users text-indigo-600 text-xl"></i>
                                </div>
                                <span class="text-sm font-medium text-green-600 bg-green-100 px-3 py-1 rounded-full">
                                    <i class="fas fa-arrow-up mr-1"></i> Live
                                </span>
                            </div>
                            <p class="text-gray-500 text-sm mb-1">Total Telegram Users</p>
                            <p class="text-3xl font-bold text-gray-800" id="total-users">0</p>
                            <div class="mt-4 flex items-center text-sm text-gray-600">
                                <i class="fab fa-telegram mr-2"></i>
                                <span>Telegram users only</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="p-3 bg-green-100 rounded-xl">
                                    <i class="fas fa-money-bill-wave text-green-600 text-xl"></i>
                                </div>
                                <span class="text-sm font-medium text-blue-600 bg-blue-100 px-3 py-1 rounded-full">
                                    Active
                                </span>
                            </div>
                            <p class="text-gray-500 text-sm mb-1">Total Withdrawals</p>
                            <p class="text-3xl font-bold text-gray-800" id="total-withdrawals">0</p>
                            <div class="progress-bar mt-4">
                                <div class="progress-fill" id="withdrawal-progress" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="p-3 bg-yellow-100 rounded-xl">
                                    <i class="fas fa-clock text-yellow-600 text-xl"></i>
                                </div>
                                <span class="text-sm font-medium text-yellow-600 bg-yellow-100 px-3 py-1 rounded-full">
                                    Pending
                                </span>
                            </div>
                            <p class="text-gray-500 text-sm mb-1">Pending Withdrawals</p>
                            <p class="text-3xl font-bold text-gray-800" id="pending-withdrawals">0</p>
                            <div class="mt-4">
                                <p class="text-sm text-gray-600" id="pending-amount">₹0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="p-3 bg-purple-100 rounded-xl">
                                    <i class="fas fa-coins text-purple-600 text-xl"></i>
                                </div>
                                <span class="text-sm font-medium text-purple-600 bg-purple-100 px-3 py-1 rounded-full">
                                    Today
                                </span>
                            </div>
                            <p class="text-gray-500 text-sm mb-1">Today's Earnings</p>
                            <p class="text-3xl font-bold text-gray-800" id="today-earnings">0</p>
                            <div class="mt-4 flex items-center text-sm text-gray-600">
                                <i class="fas fa-chart-line mr-2"></i>
                                <span>Points earned today</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts and Recent Activity -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-2xl shadow-sm p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Recent Withdrawals</h3>
                        <div id="recent-withdrawals" class="space-y-4">
                            <div class="flex items-center justify-center py-8">
                                <div class="loader"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-2xl shadow-sm p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Recent Telegram Users</h3>
                        <div id="recent-users" class="space-y-4">
                            <div class="flex items-center justify-center py-8">
                                <div class="loader"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Game Statistics -->
                <div class="bg-white rounded-2xl shadow-sm p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-gray-800">Game Statistics</h3>
                        <button onclick="refreshGameStats()" class="btn btn-sm btn-secondary">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div id="game-stats">
                        <div class="flex items-center justify-center py-8">
                            <div class="loader"></div>
                        </div>
                    </div>
                </div>
            `;
            
            // Load data
            loadDashboardData();
        }

        async function loadDashboardData() {
            try {
                // Real-time updates
                setupDashboardListeners();
                
                // Load initial data
                await loadRecentWithdrawals();
                await loadRecentUsers();
                await loadGameStats();
                
            } catch (error) {
                console.error("Error loading dashboard data:", error);
                showToast("Failed to load dashboard data", "error");
            }
        }

        function setupDashboardListeners() {
            // Total Telegram users (filter by has telegramId)
            const usersUnsub = onSnapshot(collection(db, "users"), (snap) => {
                let telegramUsers = 0;
                snap.forEach(doc => {
                    const userData = doc.data();
                    if (userData.telegramId || userData.platform === 'telegram') {
                        telegramUsers++;
                    }
                });
                document.getElementById('total-users').textContent = telegramUsers.toLocaleString();
            });

            // Withdrawals
            const withdrawalsUnsub = onSnapshot(query(
                collection(db, "withdrawals"),
                orderBy("requestedAt", "desc")
            ), (snap) => {
                document.getElementById('total-withdrawals').textContent = snap.size.toLocaleString();
                
                // Calculate pending amount
                let pendingAmount = 0;
                let pendingCount = 0;
                snap.forEach(doc => {
                    const data = doc.data();
                    if (data.status === 'pending') {
                        pendingAmount += data.amount || 0;
                        pendingCount++;
                    }
                });
                
                document.getElementById('pending-withdrawals').textContent = pendingCount.toLocaleString();
                document.getElementById('pending-amount').textContent = `₹${pendingAmount.toLocaleString()}`;
                
                // Update progress bar
                const total = snap.size;
                const pendingPercentage = total > 0 ? (pendingCount / total) * 100 : 0;
                document.getElementById('withdrawal-progress').style.width = `${pendingPercentage}%`;
            });

            // Today's earnings
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const earningsUnsub = onSnapshot(query(
                collection(db, "pointHistory"),
                where("timestamp", ">=", today),
                where("timestamp", "<", tomorrow)
            ), (snap) => {
                let totalEarnings = 0;
                snap.forEach(doc => {
                    const points = doc.data().points;
                    if (points > 0) totalEarnings += points;
                });
                document.getElementById('today-earnings').textContent = totalEarnings.toLocaleString();
            });

            // Store unsubscribe functions
            window.dashboardUnsubscribers = { usersUnsub, withdrawalsUnsub, earningsUnsub };
        }

        async function loadRecentWithdrawals() {
            try {
                const snap = await getDocs(query(
                    collection(db, "withdrawals"),
                    orderBy("requestedAt", "desc"),
                    limit(5)
                ));
                
                let html = '';
                if (snap.empty) {
                    html = '<p class="text-gray-500 text-center py-4">No withdrawals yet</p>';
                } else {
                    snap.forEach(doc => {
                        const data = doc.data();
                        const date = data.requestedAt?.toDate().toLocaleDateString() || 'N/A';
                        const statusClass = data.status === 'approved' ? 'status-approved' :
                                          data.status === 'pending' ? 'status-pending' : 'status-rejected';
                        
                        html += `
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                                <div>
                                    <p class="font-medium text-gray-800">${data.telegramName || data.userName || 'Unknown'}</p>
                                    <p class="text-sm text-gray-600">${date}</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-gray-800">${data.amount} points</p>
                                    <span class="status-badge ${statusClass}">${data.status}</span>
                                </div>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('recent-withdrawals').innerHTML = html;
            } catch (error) {
                console.error("Error loading recent withdrawals:", error);
                document.getElementById('recent-withdrawals').innerHTML = 
                    '<p class="text-red-500 text-center py-4">Failed to load</p>';
            }
        }

        async function loadRecentUsers() {
            try {
                // Get only Telegram users (those with telegramId or platform = 'telegram')
                const snap = await getDocs(query(
                    collection(db, "users"),
                    where("platform", "==", "telegram"),
                    orderBy("createdAt", "desc"),
                    limit(5)
                ));
                
                let html = '';
                if (snap.empty) {
                    // Try alternative query for telegramId
                    const altSnap = await getDocs(query(
                        collection(db, "users"),
                        where("telegramId", "!=", null),
                        orderBy("telegramId"),
                        limit(5)
                    ));
                    
                    if (altSnap.empty) {
                        html = '<p class="text-gray-500 text-center py-4">No Telegram users yet</p>';
                    } else {
                        altSnap.forEach(doc => {
                            const data = doc.data();
                            const date = data.createdAt?.toDate().toLocaleDateString() || 'N/A';
                            const isBlocked = data.isBlocked || false;
                            const statusClass = isBlocked ? 'status-blocked' : 'status-active';
                            
                            html += `
                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white">
                                            <i class="fab fa-telegram"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium text-gray-800">${data.telegramName || data.name || 'Unknown'}</p>
                                            <p class="text-sm text-gray-600">ID: ${data.telegramId || 'N/A'}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold text-gray-800">${data.balance || 0} points</p>
                                        <span class="status-badge ${statusClass}">${isBlocked ? 'Blocked' : 'Active'}</span>
                                    </div>
                                </div>
                            `;
                        });
                    }
                } else {
                    snap.forEach(doc => {
                        const data = doc.data();
                        const date = data.createdAt?.toDate().toLocaleDateString() || 'N/A';
                        const isBlocked = data.isBlocked || false;
                        const statusClass = isBlocked ? 'status-blocked' : 'status-active';
                        
                        html += `
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white">
                                        <i class="fab fa-telegram"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-800">${data.telegramName || data.name || 'Unknown'}</p>
                                        <p class="text-sm text-gray-600">ID: ${data.telegramId || data.userId || 'N/A'}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-gray-800">${data.balance || 0} points</p>
                                    <span class="status-badge ${statusClass}">${isBlocked ? 'Blocked' : 'Active'}</span>
                                </div>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('recent-users').innerHTML = html;
            } catch (error) {
                console.error("Error loading recent users:", error);
                document.getElementById('recent-users').innerHTML = 
                    '<p class="text-red-500 text-center py-4">Failed to load</p>';
            }
        }

        async function loadGameStats() {
            try {
                const gamesSnap = await getDoc(doc(db, "config", "games"));
                const gamesConfig = gamesSnap.exists() ? gamesSnap.data() : {};
                
                const today = new Date().toISOString().split('T')[0];
                const todayStats = gamesConfig.dailyStats?.[today] || {};
                
                const games = [
                    { id: 'colorGame', name: 'Color Game', icon: 'palette', color: 'bg-purple-500' },
                    { id: 'watchVideo', name: 'Watch Video', icon: 'video', color: 'bg-blue-500' },
                    { id: 'ludoDice', name: 'Ludo Dice', icon: 'dice-five', color: 'bg-green-500' }
                ];
                
                let html = '<div class="grid grid-cols-1 md:grid-cols-3 gap-6">';
                
                games.forEach(game => {
                    const gameData = gamesConfig[game.id] || {};
                    const gameStats = todayStats[game.id] || { playCount: 0, userCount: 0 };
                    const isVisible = gameData.visible !== false;
                    
                    html += `
                        <div class="game-card">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center gap-3">
                                    <div class="${game.color} text-white p-3 rounded-xl">
                                        <i class="fas fa-${game.icon} text-xl"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-gray-800">${game.name}</h4>
                                        <p class="text-sm text-gray-600">${isVisible ? 'Visible' : 'Hidden'}</p>
                                    </div>
                                </div>
                                <span class="status-badge ${isVisible ? 'status-visible' : 'status-hidden'}">
                                    ${isVisible ? 'Visible' : 'Hidden'}
                                </span>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <p class="text-sm text-gray-500 mb-1">Today's Plays</p>
                                    <p class="text-2xl font-bold text-gray-800">${gameStats.playCount || 0}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 mb-1">Reward per Play</p>
                                    <p class="text-lg font-bold text-green-600">${gameData.rewardPerPlay || 0} pts</p>
                                </div>
                                <div class="flex justify-between text-sm text-gray-600">
                                    <span>Daily Limit: ${gameData.dailyPlayLimit > 0 ? gameData.dailyPlayLimit : 'Unlimited'}</span>
                                    <span>Order: ${gameData.order || 1}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                document.getElementById('game-stats').innerHTML = html;
                
            } catch (error) {
                console.error("Error loading game stats:", error);
                document.getElementById('game-stats').innerHTML = 
                    '<p class="text-red-500 text-center py-8">Failed to load game statistics</p>';
            }
        }

        function refreshGameStats() {
            loadGameStats();
            showToast("Game statistics refreshed", "success");
        }

        // ============================
        // USERS MANAGEMENT - FIXED FOR TELEGRAM ONLY
        // ============================
        async function loadUsers() {
            const page = document.getElementById('users');
            page.innerHTML = `
                <div class="mb-8">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">Telegram User Management</h1>
                            <p class="text-gray-600">Manage Telegram users only</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="user-search" placeholder="Search Telegram users..." class="input-field">
                            </div>
                            <button onclick="exportUsersToCSV()" class="btn btn-success">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Bulk Actions -->
                <div id="bulk-actions" class="hidden mb-6 p-4 bg-gray-50 rounded-xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <span id="selected-count" class="font-medium text-gray-800">0 users selected</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="bulkBlockUsers()" class="btn btn-danger btn-sm">
                                <i class="fas fa-ban"></i> Block Selected
                            </button>
                            <button onclick="bulkUnblockUsers()" class="btn btn-success btn-sm">
                                <i class="fas fa-check"></i> Unblock Selected
                            </button>
                            <button onclick="clearSelection()" class="btn btn-secondary btn-sm">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Users Table -->
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table>
                            <thead>
                                <tr>
                                    <th class="w-12">
                                        <input type="checkbox" id="select-all" onchange="toggleSelectAll(this)">
                                    </th>
                                    <th>Telegram User</th>
                                    <th>Telegram ID</th>
                                    <th>Balance</th>
                                    <th>Country</th>
                                    <th>Daily Ads</th>
                                    <th>Status</th>
                                    <th>Joined</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <tr>
                                    <td colspan="9" class="text-center py-12">
                                        <div class="loader mx-auto"></div>
                                        <p class="text-gray-500 mt-2">Loading Telegram users...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div class="p-4 border-t border-gray-200">
                        <div class="flex items-center justify-between">
                            <div class="text-sm text-gray-600" id="users-pagination-info">
                                Loading...
                            </div>
                            <div class="pagination" id="users-pagination">
                                <!-- Pagination buttons will be added here -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add search event listener
            document.getElementById('user-search').addEventListener('input', debounce(searchUsers, 500));
            
            // Load users
            await loadUsersData();
        }

        async function loadUsersData(search = '', page = 1) {
            try {
                showLoader();
                
                // Get config for daily ad limit
                const configSnap = await getDoc(doc(db, "config", "main"));
                const config = configSnap.exists() ? configSnap.data() : {};
                const dailyAdLimit = config.dailyAdLimit || 100;
                
                // Calculate pagination
                const limit = currentPageData.users.limit;
                
                // Get ALL users first (we'll filter for Telegram users in memory)
                const allUsersSnap = await getDocs(collection(db, "users"));
                
                // Filter for Telegram users only (those with telegramId or platform = 'telegram')
                let telegramUsers = [];
                allUsersSnap.forEach(doc => {
                    const user = doc.data();
                    const isTelegramUser = user.telegramId || user.platform === 'telegram';
                    if (isTelegramUser) {
                        telegramUsers.push({ id: doc.id, ...user });
                    }
                });
                
                // Apply search filter if provided
                if (search) {
                    const searchLower = search.toLowerCase();
                    telegramUsers = telegramUsers.filter(user => {
                        return (
                            (user.telegramName && user.telegramName.toLowerCase().includes(searchLower)) ||
                            (user.name && user.name.toLowerCase().includes(searchLower)) ||
                            (user.telegramId && user.telegramId.toString().includes(search)) ||
                            (user.referralCode && user.referralCode.toLowerCase().includes(searchLower))
                        );
                    });
                }
                
                // Sort by creation date (newest first)
                telegramUsers.sort((a, b) => {
                    const dateA = a.createdAt?.toDate?.() || new Date(0);
                    const dateB = b.createdAt?.toDate?.() || new Date(0);
                    return dateB - dateA;
                });
                
                // Apply pagination
                const total = telegramUsers.length;
                const totalPages = Math.ceil(total / limit);
                const startIndex = (page - 1) * limit;
                const endIndex = startIndex + limit;
                const users = telegramUsers.slice(startIndex, endIndex);
                
                // Update UI
                updateUsersTable(users, config);
                updateUsersPagination(page, totalPages, total);
                
            } catch (error) {
                console.error("Error loading users:", error);
                showToast("Failed to load users", "error");
                document.getElementById('users-table-body').innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-12 text-red-500">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                            <p>Failed to load users</p>
                        </td>
                    </tr>
                `;
            } finally {
                hideLoader();
            }
        }

        function updateUsersTable(users, config) {
            const dailyAdLimit = config.dailyAdLimit || 100;
            let html = '';
            
            if (users.length === 0) {
                html = `
                    <tr>
                        <td colspan="9" class="text-center py-12 text-gray-500">
                            <i class="fab fa-telegram text-3xl mb-3 opacity-50"></i>
                            <p>No Telegram users found</p>
                        </td>
                    </tr>
                `;
            } else {
                users.forEach(user => {
                    const isBlocked = user.isBlocked || false;
                    const dailyAdsWatched = user.dailyAdCount || 0;
                    const adsPercent = Math.min((dailyAdsWatched / dailyAdLimit) * 100, 100);
                    const joinedDate = user.createdAt?.toDate?.().toLocaleDateString() || 'N/A';
                    const telegramName = user.telegramName || user.name || 'Unknown';
                    const telegramId = user.telegramId || user.userId || 'N/A';
                    
                    html += `
                        <tr>
                            <td>
                                <input type="checkbox" class="user-checkbox" value="${user.id}" onchange="updateSelection()">
                            </td>
                            <td>
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white">
                                        <i class="fab fa-telegram"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-800">${telegramName}</p>
                                        <p class="text-sm text-gray-600">${user.email || 'No email'}</p>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">${telegramId}</span>
                            </td>
                            <td>
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-gray-800">${user.balance || 0}</span>
                                    <button onclick="editUserPoints('${user.id}', '${telegramName}', ${user.balance || 0})" 
                                            class="btn btn-xs btn-warning">
                                        Edit
                                    </button>
                                </div>
                            </td>
                            <td>
                                <span class="inline-flex items-center gap-1">
                                    <i class="fas fa-globe text-gray-400"></i>
                                    <span>${user.country || 'Unknown'}</span>
                                </span>
                            </td>
                            <td>
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span>${dailyAdsWatched}/${dailyAdLimit}</span>
                                        <span>${Math.round(adsPercent)}%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${adsPercent}%"></div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="status-badge ${isBlocked ? 'status-blocked' : 'status-active'}">
                                    ${isBlocked ? 'Blocked' : 'Active'}
                                </span>
                            </td>
                            <td class="text-gray-600 text-sm">${joinedDate}</td>
                            <td>
                                <div class="flex gap-2">
                                    <button onclick="viewUserPointHistory('${user.id}', '${telegramName}')" 
                                            class="btn btn-xs btn-info">
                                        <i class="fas fa-history"></i> Points
                                    </button>
                                    <button onclick="toggleUserBlock('${user.id}', ${isBlocked})" 
                                            class="btn btn-xs ${isBlocked ? 'btn-success' : 'btn-danger'}">
                                        <i class="fas ${isBlocked ? 'fa-check' : 'fa-ban'}"></i>
                                        ${isBlocked ? 'Unblock' : 'Block'}
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }
            
            document.getElementById('users-table-body').innerHTML = html;
        }

        function updateUsersPagination(page, totalPages, total) {
            const infoEl = document.getElementById('users-pagination-info');
            const paginationEl = document.getElementById('users-pagination');
            
            infoEl.textContent = `Page ${page} of ${totalPages} • ${total.toLocaleString()} Telegram users`;
            
            let html = '';
            
            // Previous button
            html += `
                <button onclick="changeUsersPage(${page - 1})" 
                        ${page <= 1 ? 'disabled' : ''}
                        class="page-btn ${page <= 1 ? 'opacity-50 cursor-not-allowed' : ''}">
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;
            
            // Page numbers
            const maxVisible = 5;
            let startPage = Math.max(1, page - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);
            
            if (endPage - startPage + 1 < maxVisible) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `
                    <button onclick="changeUsersPage(${i})" 
                            class="page-btn ${i === page ? 'active' : ''}">
                        ${i}
                    </button>
                `;
            }
            
            // Next button
            html += `
                <button onclick="changeUsersPage(${page + 1})" 
                        ${page >= totalPages ? 'disabled' : ''}
                        class="page-btn ${page >= totalPages ? 'opacity-50 cursor-not-allowed' : ''}">
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;
            
            paginationEl.innerHTML = html;
        }

        function changeUsersPage(newPage) {
            if (newPage < 1) return;
            currentPageData.users.page = newPage;
            const search = document.getElementById('user-search').value;
            loadUsersData(search, newPage);
        }

        function searchUsers() {
            const search = document.getElementById('user-search').value;
            currentPageData.users.page = 1;
            loadUsersData(search, 1);
        }

        // ============================
        // POINT HISTORY
        // ============================
        async function viewUserPointHistory(userId, userName) {
            currentPageData.pointHistory.userId = userId;
            currentPageData.pointHistory.page = 1;
            currentPageData.pointHistory.lastDoc = null;
            
            // Update modal UI
            document.getElementById('history-user-name').textContent = userName;
            
            // Show modal
            showModal('point-history-modal');
            
            // Load point history
            await loadUserPointHistory(userId);
        }

        async function loadUserPointHistory(userId, page = 1) {
            try {
                showLoader();
                
                const limit = currentPageData.pointHistory.limit;
                const startAfter = page > 1 ? currentPageData.pointHistory.lastDoc : null;
                
                let q = query(
                    collection(db, "pointHistory"),
                    where("userId", "==", userId),
                    orderBy("timestamp", "desc"),
                    limit(limit)
                );
                
                if (startAfter) {
                    q = query(q, startAfter(startAfter));
                }
                
                const snap = await getDocs(q);
                const totalSnap = await getDocs(query(
                    collection(db, "pointHistory"),
                    where("userId", "==", userId)
                ));
                
                // Calculate totals
                let totalPoints = 0;
                let totalEarned = 0;
                let totalSpent = 0;
                
                totalSnap.forEach(doc => {
                    const points = doc.data().points || 0;
                    totalPoints += points;
                    if (points > 0) totalEarned += points;
                    if (points < 0) totalSpent += Math.abs(points);
                });
                
                // Update totals display
                document.getElementById('history-total-points').textContent = totalPoints.toLocaleString();
                document.getElementById('history-earned').textContent = totalEarned.toLocaleString();
                document.getElementById('history-spent').textContent = totalSpent.toLocaleString();
                
                // Update table
                let html = '';
                if (snap.empty) {
                    html = `
                        <tr>
                            <td colspan="5" class="text-center py-8 text-gray-500">
                                <i class="fas fa-history text-2xl mb-2 opacity-50"></i>
                                <p>No point history found</p>
                            </td>
                        </tr>
                    `;
                } else {
                    snap.forEach(doc => {
                        const data = doc.data();
                        const timestamp = data.timestamp?.toDate().toLocaleString() || 'N/A';
                        const points = data.points || 0;
                        const pointsClass = points > 0 ? 'text-green-600' : 'text-red-600';
                        const gameType = getGameTypeLabel(data.taskType);
                        
                        html += `
                            <tr>
                                <td class="text-sm text-gray-600">${timestamp}</td>
                                <td>
                                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-gray-100 text-xs">
                                        ${gameType.icon}
                                        <span>${gameType.label}</span>
                                    </span>
                                </td>
                                <td class="font-bold ${pointsClass}">
                                    ${points > 0 ? '+' : ''}${points}
                                </td>
                                <td class="text-gray-600">${data.gameType || 'N/A'}</td>
                                <td class="text-gray-600 text-sm">${data.details || ''}</td>
                            </tr>
                        `;
                    });
                    
                    // Store last document for pagination
                    if (snap.docs.length > 0) {
                        currentPageData.pointHistory.lastDoc = snap.docs[snap.docs.length - 1];
                    }
                }
                
                document.getElementById('point-history-body').innerHTML = html;
                
                // Update load more button
                const loadMoreBtn = document.getElementById('load-more-history');
                if (snap.size < limit) {
                    loadMoreBtn.style.display = 'none';
                } else {
                    loadMoreBtn.style.display = 'inline-flex';
                }
                
            } catch (error) {
                console.error("Error loading point history:", error);
                document.getElementById('point-history-body').innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-8 text-red-500">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                            <p>Failed to load point history</p>
                        </td>
                    </tr>
                `;
            } finally {
                hideLoader();
            }
        }

        function getGameTypeLabel(taskType) {
            const types = {
                'ad_watch': { label: 'Ad Watch', icon: '<i class="fas fa-ad"></i>' },
                'color_game': { label: 'Color Game', icon: '<i class="fas fa-palette"></i>' },
                'ludo_game': { label: 'Ludo Dice', icon: '<i class="fas fa-dice"></i>' },
                'website_visit': { label: 'Website Visit', icon: '<i class="fas fa-globe"></i>' },
                'social_task': { label: 'Social Task', icon: '<i class="fas fa-share-alt"></i>' },
                'referral': { label: 'Referral', icon: '<i class="fas fa-user-plus"></i>' },
                'withdrawal': { label: 'Withdrawal', icon: '<i class="fas fa-money-bill-wave"></i>' },
                'admin_adjustment': { label: 'Admin', icon: '<i class="fas fa-user-cog"></i>' },
                'special_task': { label: 'Special Task', icon: '<i class="fas fa-star"></i>' }
            };
            
            return types[taskType] || { label: taskType || 'Unknown', icon: '<i class="fas fa-question"></i>' };
        }

        function loadMorePointHistory() {
            currentPageData.pointHistory.page++;
            const userId = currentPageData.pointHistory.userId;
            loadUserPointHistory(userId, currentPageData.pointHistory.page);
        }

        // ============================
        // USER MANAGEMENT FUNCTIONS
        // ============================
        async function toggleUserBlock(userId, isBlocked) {
            showConfirm(
                `Are you sure you want to ${isBlocked ? 'unblock' : 'block'} this Telegram user?`,
                async () => {
                    try {
                        await updateDoc(doc(db, "users", userId), { 
                            isBlocked: !isBlocked 
                        });
                        
                        // Log action
                        await logAdminAction('toggle_user_block', { 
                            userId, 
                            action: isBlocked ? 'unblock' : 'block' 
                        });
                        
                        showToast(`Telegram user ${isBlocked ? 'unblocked' : 'blocked'} successfully`, "success");
                        loadUsersData();
                    } catch (error) {
                        console.error("Error updating user:", error);
                        showToast("Failed to update user", "error");
                    }
                }
            );
        }

        function editUserPoints(userId, userName, currentBalance) {
            // Create edit modal
            const modalHTML = `
                <div class="p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Edit User Points</h3>
                    
                    <div class="space-y-4 mb-6">
                        <div class="p-4 bg-gray-50 rounded-xl">
                            <p class="text-sm text-gray-500">Telegram User</p>
                            <p class="font-bold text-gray-800">${userName}</p>
                        </div>
                        
                        <div class="p-4 bg-gray-50 rounded-xl">
                            <p class="text-sm text-gray-500">Current Balance</p>
                            <p class="text-2xl font-bold text-blue-600">${currentBalance}</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">New Balance</label>
                            <input type="number" id="new-user-balance" value="${currentBalance}" 
                                   class="input-field" min="0" step="1">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Reason (Optional)</label>
                            <textarea id="balance-reason" class="input-field" rows="3" 
                                      placeholder="Reason for adjustment..."></textarea>
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="hideModal('edit-user-modal')" class="btn btn-secondary flex-1">
                            Cancel
                        </button>
                        <button onclick="saveUserPoints('${userId}', '${userName}')" class="btn btn-primary flex-1">
                            Save Changes
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('edit-user-modal').innerHTML = modalHTML;
            showModal('edit-user-modal');
        }

        async function saveUserPoints(userId, userName) {
            const newBalance = parseInt(document.getElementById('new-user-balance').value);
            const reason = document.getElementById('balance-reason').value.trim();
            
            if (isNaN(newBalance) || newBalance < 0) {
                showToast("Please enter a valid balance", "error");
                return;
            }
            
            showLoader();
            try {
                // Get current user data
                const userRef = doc(db, "users", userId);
                const userSnap = await getDoc(userRef);
                const userData = userSnap.data();
                const currentBalance = userData.balance || 0;
                
                // Update balance
                await updateDoc(userRef, { 
                    balance: newBalance,
                    totalEarned: (userData.totalEarned || 0) + Math.max(0, newBalance - currentBalance)
                });
                
                // Add point history
                const adjustment = newBalance - currentBalance;
                await setDoc(doc(db, "pointHistory", Date.now().toString()), {
                    userId: userId,
                    userName: userName,
                    userEmail: userData.email || '',
                    taskType: 'admin_adjustment',
                    points: adjustment,
                    details: reason || `Admin adjusted balance from ${currentBalance} to ${newBalance}`,
                    timestamp: serverTimestamp(),
                    country: userData.country || 'unknown'
                });
                
                // Log admin action
                await logAdminAction('adjust_user_points', {
                    userId,
                    oldBalance: currentBalance,
                    newBalance,
                    adjustment,
                    reason
                });
                
                showToast("User points updated successfully", "success");
                hideModal('edit-user-modal');
                loadUsersData();
                
            } catch (error) {
                console.error("Error updating user points:", error);
                showToast("Failed to update user points", "error");
            } finally {
                hideLoader();
            }
        }

        // ============================
        // BULK OPERATIONS
        // ============================
        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.user-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateSelection();
        }

        function updateSelection() {
            const checkboxes = document.querySelectorAll('.user-checkbox:checked');
            const count = checkboxes.length;
            const bulkActions = document.getElementById('bulk-actions');
            const selectedCount = document.getElementById('selected-count');
            
            if (count > 0) {
                bulkActions.classList.remove('hidden');
                selectedCount.textContent = `${count} Telegram user${count > 1 ? 's' : ''} selected`;
            } else {
                bulkActions.classList.add('hidden');
            }
        }

        function clearSelection() {
            document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('select-all').checked = false;
            updateSelection();
        }

        async function bulkBlockUsers() {
            const checkboxes = document.querySelectorAll('.user-checkbox:checked');
            const userIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (userIds.length === 0) return;
            
            showConfirm(`Block ${userIds.length} Telegram users?`, async () => {
                showLoader();
                const batch = writeBatch(db);
                
                try {
                    userIds.forEach(userId => {
                        const userRef = doc(db, "users", userId);
                        batch.update(userRef, { isBlocked: true });
                    });
                    
                    await batch.commit();
                    
                    // Log action
                    await logAdminAction('bulk_block_users', { count: userIds.length, userIds });
                    
                    showToast(`${userIds.length} Telegram users blocked successfully`, "success");
                    clearSelection();
                    loadUsersData();
                } catch (error) {
                    console.error("Error bulk blocking users:", error);
                    showToast("Failed to block users", "error");
                } finally {
                    hideLoader();
                }
            });
        }

        async function bulkUnblockUsers() {
            const checkboxes = document.querySelectorAll('.user-checkbox:checked');
            const userIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (userIds.length === 0) return;
            
            showConfirm(`Unblock ${userIds.length} Telegram users?`, async () => {
                showLoader();
                const batch = writeBatch(db);
                
                try {
                    userIds.forEach(userId => {
                        const userRef = doc(db, "users", userId);
                        batch.update(userRef, { isBlocked: false });
                    });
                    
                    await batch.commit();
                    
                    // Log action
                    await logAdminAction('bulk_unblock_users', { count: userIds.length, userIds });
                    
                    showToast(`${userIds.length} Telegram users unblocked successfully`, "success");
                    clearSelection();
                    loadUsersData();
                } catch (error) {
                    console.error("Error bulk unblocking users:", error);
                    showToast("Failed to unblock users", "error");
                } finally {
                    hideLoader();
                }
            });
        }

        // ============================
        // EXPORT FUNCTIONALITY
        // ============================
        async function exportUsersToCSV() {
            showLoader();
            try {
                // Get all Telegram users
                const allUsersSnap = await getDocs(collection(db, "users"));
                const telegramUsers = [];
                
                allUsersSnap.forEach(doc => {
                    const user = doc.data();
                    if (user.telegramId || user.platform === 'telegram') {
                        telegramUsers.push({ id: doc.id, ...user });
                    }
                });
                
                let csv = 'Telegram Name,Telegram ID,Email,Balance,Country,Status,Daily Ads,Joined At\n';
                
                telegramUsers.forEach(user => {
                    const isBlocked = user.isBlocked || false;
                    const date = user.createdAt?.toDate().toLocaleDateString() || 'N/A';
                    const telegramName = user.telegramName || user.name || '';
                    const telegramId = user.telegramId || user.userId || '';
                    
                    csv += `"${telegramName}","${telegramId}","${user.email || ''}",${user.balance || 0},"${user.country || ''}","${isBlocked ? 'Blocked' : 'Active'}",${user.dailyAdCount || 0},"${date}"\n`;
                });
                
                // Create and download file
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `telegram_users_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                // Log action
                await logAdminAction('export_users', { count: telegramUsers.length });
                
                showToast("Telegram users exported successfully", "success");
            } catch (error) {
                console.error("Error exporting users:", error);
                showToast("Failed to export users", "error");
            } finally {
                hideLoader();
            }
        }

        // ============================
        // WITHDRAWALS MANAGEMENT - FIXED FOR PAYMENT VALIDATION
        // ============================
        async function loadWithdrawals() {
            const page = document.getElementById('withdrawals');
            page.innerHTML = `
                <div class="mb-8">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">Withdrawal Management</h1>
                            <p class="text-gray-600">Process Telegram user withdrawal requests</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="flex bg-gray-100 p-1 rounded-xl">
                                <button onclick="filterWithdrawals('all')" class="px-4 py-2 rounded-lg ${currentPageData.withdrawals.filter === 'all' ? 'bg-white shadow' : ''}">
                                    All
                                </button>
                                <button onclick="filterWithdrawals('pending')" class="px-4 py-2 rounded-lg ${currentPageData.withdrawals.filter === 'pending' ? 'bg-white shadow' : ''}">
                                    Pending
                                </button>
                                <button onclick="filterWithdrawals('approved')" class="px-4 py-2 rounded-lg ${currentPageData.withdrawals.filter === 'approved' ? 'bg-white shadow' : ''}">
                                    Approved
                                </button>
                                <button onclick="filterWithdrawals('rejected')" class="px-4 py-2 rounded-lg ${currentPageData.withdrawals.filter === 'rejected' ? 'bg-white shadow' : ''}">
                                    Rejected
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Withdrawals Table -->
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table>
                            <thead>
                                <tr>
                                    <th>Telegram User</th>
                                    <th>Amount (Points)</th>
                                    <th>Cash Value</th>
                                    <th>Method</th>
                                    <th>Details</th>
                                    <th>Requested</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="withdrawals-table-body">
                                <tr>
                                    <td colspan="8" class="text-center py-12">
                                        <div class="loader mx-auto"></div>
                                        <p class="text-gray-500 mt-2">Loading withdrawals...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div class="p-4 border-t border-gray-200">
                        <div class="pagination justify-center" id="withdrawals-pagination">
                            <!-- Pagination buttons will be added here -->
                        </div>
                    </div>
                </div>
            `;
            
            await loadWithdrawalsData();
        }

        async function loadWithdrawalsData(page = 1) {
            try {
                showLoader();
                const limit = currentPageData.withdrawals.limit;
                const filter = currentPageData.withdrawals.filter;
                const startAfter = page > 1 ? currentPageData.withdrawals.lastDoc : null;
                
                let q = query(collection(db, "withdrawals"), orderBy("requestedAt", "desc"));
                
                if (filter !== 'all') {
                    q = query(q, where("status", "==", filter));
                }
                
                q = query(q, limit(limit));
                if (startAfter) {
                    q = query(q, startAfter(startAfter));
                }
                
                const snap = await getDocs(q);
                
                // Get coin value from config
                const configSnap = await getDoc(doc(db, "config", "main"));
                const config = configSnap.exists() ? configSnap.data() : {};
                const coinValueCoins = config.coinValueCoins || 1000;
                const coinValueInr = config.coinValueInr || 10;
                
                let html = '';
                if (snap.empty) {
                    html = `
                        <tr>
                            <td colspan="8" class="text-center py-12 text-gray-500">
                                <i class="fas fa-money-bill-wave text-3xl mb-3 opacity-50"></i>
                                <p>No withdrawals found</p>
                            </td>
                        </tr>
                    `;
                } else {
                    snap.forEach(doc => {
                        const data = doc.data();
                        const date = data.requestedAt?.toDate().toLocaleString() || 'N/A';
                        const statusClass = data.status === 'approved' ? 'status-approved' :
                                          data.status === 'pending' ? 'status-pending' : 'status-rejected';
                        
                        // Calculate cash value
                        const points = data.amount || 0;
                        const cashValue = ((points / coinValueCoins) * coinValueInr).toFixed(2);
                        
                        html += `
                            <tr>
                                <td>
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white">
                                            <i class="fab fa-telegram"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium text-gray-800">${data.telegramName || data.userName || 'Unknown'}</p>
                                            <p class="text-sm text-gray-600">ID: ${data.telegramId || 'N/A'}</p>
                                        </div>
                                    </div>
                                </td>
                                <td class="font-bold text-gray-800">${points.toLocaleString()}</td>
                                <td class="font-bold text-green-600">₹${cashValue}</td>
                                <td>
                                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-gray-100 text-sm">
                                        <i class="fas fa-${getPaymentMethodIcon(data.method)}"></i>
                                        <span>${data.method || 'Unknown'}</span>
                                    </span>
                                </td>
                                <td class="text-sm text-gray-600 max-w-xs truncate" title="${data.paymentDetail || ''}">
                                    ${data.paymentDetail || 'No details'}
                                </td>
                                <td class="text-sm text-gray-600">${date}</td>
                                <td>
                                    <span class="status-badge ${statusClass}">${data.status}</span>
                                </td>
                                <td>
                                    ${data.status === 'pending' ? `
                                    <div class="flex gap-2">
                                        <button onclick="processWithdrawal('${doc.id}', 'approved')" 
                                                class="btn btn-xs btn-success">
                                            <i class="fas fa-check"></i> Approve
                                        </button>
                                        <button onclick="processWithdrawal('${doc.id}', 'rejected')" 
                                                class="btn btn-xs btn-danger">
                                            <i class="fas fa-times"></i> Reject
                                        </button>
                                    </div>
                                    ` : '<span class="text-gray-500">Processed</span>'}
                                </td>
                            </tr>
                        `;
                    });
                    
                    // Store last document for pagination
                    if (snap.docs.length > 0) {
                        currentPageData.withdrawals.lastDoc = snap.docs[snap.docs.length - 1];
                    }
                }
                
                document.getElementById('withdrawals-table-body').innerHTML = html;
                
                // Load total count for pagination
                const totalQuery = filter !== 'all' ? 
                    query(collection(db, "withdrawals"), where("status", "==", filter)) :
                    query(collection(db, "withdrawals"));
                    
                const totalSnap = await getDocs(totalQuery);
                const total = totalSnap.size;
                const totalPages = Math.ceil(total / limit);
                
                updateWithdrawalsPagination(page, totalPages);
                
            } catch (error) {
                console.error("Error loading withdrawals:", error);
                showToast("Failed to load withdrawals", "error");
                document.getElementById('withdrawals-table-body').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-12 text-red-500">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                            <p>Failed to load withdrawals</p>
                        </td>
                    </tr>
                `;
            } finally {
                hideLoader();
            }
        }

        function getPaymentMethodIcon(method) {
            const icons = {
                'UPI': 'university',
                'Paytm': 'mobile-alt',
                'PhonePe': 'mobile',
                'Google Pay': 'google',
                'PayPal': 'paypal',
                'Bank Transfer': 'bank',
                'Bkash': 'money-bill-wave',
                'Nagad': 'money-bill-wave',
                'Rocket': 'rocket',
                'default': 'money-bill-wave'
            };
            
            const key = Object.keys(icons).find(k => method?.toLowerCase().includes(k.toLowerCase()));
            return icons[key] || icons.default;
        }

        function updateWithdrawalsPagination(page, totalPages) {
            const paginationEl = document.getElementById('withdrawals-pagination');
            let html = '';
            
            // Previous button
            html += `
                <button onclick="changeWithdrawalsPage(${page - 1})" 
                        ${page <= 1 ? 'disabled' : ''}
                        class="page-btn ${page <= 1 ? 'opacity-50 cursor-not-allowed' : ''}">
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;
            
            // Page numbers
            const maxVisible = 5;
            let startPage = Math.max(1, page - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);
            
            if (endPage - startPage + 1 < maxVisible) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `
                    <button onclick="changeWithdrawalsPage(${i})" 
                            class="page-btn ${i === page ? 'active' : ''}">
                        ${i}
                    </button>
                `;
            }
            
            // Next button
            html += `
                <button onclick="changeWithdrawalsPage(${page + 1})" 
                        ${page >= totalPages ? 'disabled' : ''}
                        class="page-btn ${page >= totalPages ? 'opacity-50 cursor-not-allowed' : ''}">
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;
            
            paginationEl.innerHTML = html;
        }

        function changeWithdrawalsPage(newPage) {
            if (newPage < 1) return;
            currentPageData.withdrawals.page = newPage;
            loadWithdrawalsData(newPage);
        }

        function filterWithdrawals(filter) {
            currentPageData.withdrawals.filter = filter;
            currentPageData.withdrawals.page = 1;
            currentPageData.withdrawals.lastDoc = null;
            loadWithdrawalsData(1);
        }

        async function processWithdrawal(requestId, action) {
            showConfirm(
                `Are you sure you want to ${action} this withdrawal?`,
                async () => {
                    showLoader();
                    try {
                        const requestRef = doc(db, "withdrawals", requestId);
                        const requestSnap = await getDoc(requestRef);
                        
                        if (!requestSnap.exists()) {
                            throw new Error("Withdrawal request not found");
                        }
                        
                        const requestData = requestSnap.data();
                        
                        // Update withdrawal status
                        await updateDoc(requestRef, {
                            status: action,
                            processedAt: serverTimestamp(),
                            processedBy: currentAdmin.uid
                        });
                        
                        // If rejected, refund points to user
                        if (action === 'rejected') {
                            const userRef = doc(db, "users", requestData.userId);
                            const userSnap = await getDoc(userRef);
                            
                            if (userSnap.exists()) {
                                const userData = userSnap.data();
                                const currentBalance = userData.balance || 0;
                                const newBalance = currentBalance + requestData.amount;
                                
                                await updateDoc(userRef, { 
                                    balance: newBalance 
                                });
                                
                                // Add point history
                                await setDoc(doc(db, "pointHistory", Date.now().toString()), {
                                    userId: requestData.userId,
                                    userName: requestData.userName,
                                    userEmail: userData.email || '',
                                    taskType: 'withdrawal',
                                    points: requestData.amount,
                                    details: `Refund for rejected withdrawal #${requestId}`,
                                    timestamp: serverTimestamp(),
                                    country: requestData.country || 'unknown'
                                });
                            }
                        }
                        
                        // Log admin action
                        await logAdminAction('process_withdrawal', {
                            requestId,
                            action,
                            amount: requestData.amount,
                            userId: requestData.userId
                        });
                        
                        showToast(`Withdrawal ${action} successfully`, "success");
                        loadWithdrawalsData();
                        
                    } catch (error) {
                        console.error("Error processing withdrawal:", error);
                        showToast("Failed to process withdrawal", "error");
                    } finally {
                        hideLoader();
                    }
                }
            );
        }

        // ============================
        // GAME MANAGEMENT
        // ============================
        async function loadGames() {
            const page = document.getElementById('games');
            page.innerHTML = `
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">Game Management</h1>
                    <p class="text-gray-600">Configure game settings and limits</p>
                </div>
                
                <!-- Quick Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="stat-card">
                        <div class="p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="p-3 bg-purple-100 rounded-xl">
                                    <i class="fas fa-palette text-purple-600 text-xl"></i>
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-gray-800">Color Game</h3>
                                    <p class="text-sm text-gray-600">Today's plays: <span id="colorGame-today">0</span></p>
                                </div>
                                <button onclick="editGameSettings('colorGame')" class="btn btn-sm btn-primary">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Daily Limit:</span>
                                    <span class="font-medium" id="colorGame-limit">Unlimited</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Reward:</span>
                                    <span class="font-medium text-green-600" id="colorGame-reward">0 pts</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="p-3 bg-blue-100 rounded-xl">
                                    <i class="fas fa-video text-blue-600 text-xl"></i>
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-gray-800">Watch Video</h3>
                                    <p class="text-sm text-gray-600">Today's plays: <span id="watchVideo-today">0</span></p>
                                </div>
                                <button onclick="editGameSettings('watchVideo')" class="btn btn-sm btn-primary">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Daily Limit:</span>
                                    <span class="font-medium" id="watchVideo-limit">Unlimited</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Reward:</span>
                                    <span class="font-medium text-green-600" id="watchVideo-reward">0 pts</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="p-3 bg-green-100 rounded-xl">
                                    <i class="fas fa-dice text-green-600 text-xl"></i>
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-gray-800">Ludo Dice</h3>
                                    <p class="text-sm text-gray-600">Today's plays: <span id="ludoDice-today">0</span></p>
                                </div>
                                <button onclick="editGameSettings('ludoDice')" class="btn btn-sm btn-primary">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Daily Limit:</span>
                                    <span class="font-medium" id="ludoDice-limit">Unlimited</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Reward:</span>
                                    <span class="font-medium text-green-600" id="ludoDice-reward">0 pts</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Global Controls -->
                <div class="bg-white rounded-2xl shadow-sm p-6 mb-8">
                    <h3 class="text-lg font-bold text-gray-800 mb-6">Global Controls</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Set All Games Limit</label>
                            <div class="flex gap-2">
                                <input type="number" id="global-play-limit" placeholder="e.g., 20" class="input-field">
                                <button onclick="applyGlobalPlayLimit()" class="btn btn-primary">
                                    Apply
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Set All Games Reward</label>
                            <div class="flex gap-2">
                                <input type="number" id="global-reward" placeholder="e.g., 10" class="input-field">
                                <button onclick="applyGlobalReward()" class="btn btn-primary">
                                    Apply
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Visibility Control</label>
                            <div class="flex gap-2">
                                <button onclick="showAllGames()" class="btn btn-success flex-1">
                                    <i class="fas fa-eye"></i> Show All
                                </button>
                                <button onclick="hideAllGames()" class="btn btn-danger flex-1">
                                    <i class="fas fa-eye-slash"></i> Hide All
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Game Statistics -->
                <div class="bg-white rounded-2xl shadow-sm p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-gray-800">Game Statistics</h3>
                        <div class="flex gap-2">
                            <button onclick="refreshGameStats()" class="btn btn-sm btn-secondary">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <button onclick="resetGameStats()" class="btn btn-sm btn-danger">
                                <i class="fas fa-trash"></i> Reset Stats
                            </button>
                        </div>
                    </div>
                    <div id="detailed-game-stats">
                        <div class="flex items-center justify-center py-8">
                            <div class="loader"></div>
                        </div>
                    </div>
                </div>
            `;
            
            await loadGamesData();
            await loadDetailedGameStats();
        }

        async function loadGamesData() {
            try {
                const gamesSnap = await getDoc(doc(db, "config", "games"));
                const gamesConfig = gamesSnap.exists() ? gamesSnap.data() : {};
                
                const today = new Date().toISOString().split('T')[0];
                const todayStats = gamesConfig.dailyStats?.[today] || {};
                
                // Update each game card
                const games = [
                    { id: 'colorGame', todayEl: 'colorGame-today', limitEl: 'colorGame-limit', rewardEl: 'colorGame-reward' },
                    { id: 'watchVideo', todayEl: 'watchVideo-today', limitEl: 'watchVideo-limit', rewardEl: 'watchVideo-reward' },
                    { id: 'ludoDice', todayEl: 'ludoDice-today', limitEl: 'ludoDice-limit', rewardEl: 'ludoDice-reward' }
                ];
                
                games.forEach(game => {
                    const gameConfig = gamesConfig[game.id] || {};
                    const gameStats = todayStats[game.id] || { playCount: 0 };
                    
                    document.getElementById(game.todayEl).textContent = gameStats.playCount || 0;
                    document.getElementById(game.limitEl).textContent = 
                        gameConfig.dailyPlayLimit > 0 ? `${gameConfig.dailyPlayLimit} plays` : 'Unlimited';
                    document.getElementById(game.rewardEl).textContent = `${gameConfig.rewardPerPlay || 0} pts`;
                });
                
            } catch (error) {
                console.error("Error loading games data:", error);
                showToast("Failed to load game data", "error");
            }
        }

        async function loadDetailedGameStats() {
            try {
                const gamesSnap = await getDoc(doc(db, "config", "games"));
                const gamesConfig = gamesSnap.exists() ? gamesSnap.data() : {};
                
                const today = new Date().toISOString().split('T')[0];
                const todayStats = gamesConfig.dailyStats?.[today] || {};
                const allTimeStats = gamesConfig.allTimeStats || {};
                
                const games = [
                    { id: 'colorGame', name: 'Color Game' },
                    { id: 'watchVideo', name: 'Watch Video' },
                    { id: 'ludoDice', name: 'Ludo Dice' }
                ];
                
                let html = `
                    <div class="overflow-x-auto">
                        <table>
                            <thead>
                                <tr>
                                    <th>Game</th>
                                    <th>Today's Plays</th>
                                    <th>Today's Users</th>
                                    <th>Total Plays</th>
                                    <th>Total Users</th>
                                    <th>Visibility</th>
                                    <th>Daily Limit</th>
                                    <th>Reward</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                games.forEach(game => {
                    const gameConfig = gamesConfig[game.id] || {};
                    const todayGameStats = todayStats[game.id] || { playCount: 0, userCount: 0 };
                    const allTimeGameStats = allTimeStats[game.id] || { playCount: 0, userCount: 0 };
                    const isVisible = gameConfig.visible !== false;
                    
                    html += `
                        <tr>
                            <td class="font-medium">${game.name}</td>
                            <td class="font-bold text-blue-600">${todayGameStats.playCount}</td>
                            <td>${todayGameStats.userCount}</td>
                            <td class="font-bold">${allTimeGameStats.playCount}</td>
                            <td>${allTimeGameStats.userCount}</td>
                            <td>
                                <span class="status-badge ${isVisible ? 'status-visible' : 'status-hidden'}">
                                    ${isVisible ? 'Visible' : 'Hidden'}
                                </span>
                            </td>
                            <td>${gameConfig.dailyPlayLimit > 0 ? gameConfig.dailyPlayLimit : 'Unlimited'}</td>
                            <td class="font-bold text-green-600">${gameConfig.rewardPerPlay || 0} pts</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('detailed-game-stats').innerHTML = html;
                
            } catch (error) {
                console.error("Error loading detailed game stats:", error);
                document.getElementById('detailed-game-stats').innerHTML = 
                    '<p class="text-red-500 text-center py-8">Failed to load game statistics</p>';
            }
        }

        function editGameSettings(gameId) {
            // Get current game settings
            showLoader();
            getDoc(doc(db, "config", "games")).then(snap => {
                hideLoader();
                const gamesConfig = snap.exists() ? snap.data() : {};
                const gameConfig = gamesConfig[gameId] || {};
                
                const modalHTML = `
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Edit ${gameId === 'colorGame' ? 'Color Game' : gameId === 'watchVideo' ? 'Watch Video' : 'Ludo Dice'} Settings</h3>
                        
                        <div class="space-y-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Daily Play Limit</label>
                                <input type="number" id="edit-game-limit" value="${gameConfig.dailyPlayLimit || 0}" 
                                       class="input-field" min="0" placeholder="0 for unlimited">
                                <p class="text-xs text-gray-500 mt-1">0 means unlimited plays per day</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Reward Per Play (Points)</label>
                                <input type="number" id="edit-game-reward" value="${gameConfig.rewardPerPlay || 0}" 
                                       class="input-field" min="0">
                            </div>
                            
                            <div>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="edit-game-visible" class="rounded" ${gameConfig.visible !== false ? 'checked' : ''}>
                                    <span class="text-sm font-medium text-gray-700">Visible in app</span>
                                </label>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Display Order</label>
                                <input type="number" id="edit-game-order" value="${gameConfig.order || 1}" 
                                       class="input-field" min="1">
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="hideModal('quick-game-settings-modal')" class="btn btn-secondary flex-1">
                                Cancel
                            </button>
                            <button onclick="saveGameSettings('${gameId}')" class="btn btn-primary flex-1">
                                Save Settings
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('quick-game-settings-modal').innerHTML = modalHTML;
                showModal('quick-game-settings-modal');
            }).catch(error => {
                hideLoader();
                console.error("Error loading game settings:", error);
                showToast("Failed to load game settings", "error");
            });
        }

        async function saveGameSettings(gameId) {
            const limit = parseInt(document.getElementById('edit-game-limit').value);
            const reward = parseInt(document.getElementById('edit-game-reward').value);
            const isVisible = document.getElementById('edit-game-visible').checked;
            const order = parseInt(document.getElementById('edit-game-order').value);
            
            if (isNaN(reward) || reward < 0) {
                showToast("Please enter a valid reward amount", "error");
                return;
            }
            
            showLoader();
            try {
                const gameRef = doc(db, "config", "games");
                const gameSnap = await getDoc(gameRef);
                const currentData = gameSnap.exists() ? gameSnap.data() : {};
                
                const updateData = {
                    ...currentData,
                    [gameId]: {
                        ...(currentData[gameId] || {}),
                        dailyPlayLimit: limit || 0,
                        rewardPerPlay: reward,
                        visible: isVisible,
                        order: order || 1,
                        updatedAt: serverTimestamp()
                    },
                    updatedAt: serverTimestamp()
                };
                
                await setDoc(gameRef, updateData);
                
                // Log action
                await logAdminAction('update_game_settings', {
                    gameId,
                    limit,
                    reward,
                    isVisible,
                    order
                });
                
                showToast("Game settings saved successfully", "success");
                hideModal('quick-game-settings-modal');
                loadGamesData();
                loadDetailedGameStats();
                
            } catch (error) {
                console.error("Error saving game settings:", error);
                showToast("Failed to save game settings", "error");
            } finally {
                hideLoader();
            }
        }

        async function applyGlobalPlayLimit() {
            const limit = parseInt(document.getElementById('global-play-limit').value);
            
            if (isNaN(limit) || limit < 0) {
                showToast("Please enter a valid positive number", "error");
                return;
            }
            
            showConfirm(
                `Apply daily play limit of ${limit} to ALL games?`,
                async () => {
                    showLoader();
                    try {
                        const gameRef = doc(db, "config", "games");
                        const gameSnap = await getDoc(gameRef);
                        const currentData = gameSnap.exists() ? gameSnap.data() : {};
                        
                        const updateData = { ...currentData };
                        
                        // Update all games
                        ['colorGame', 'watchVideo', 'ludoDice'].forEach(gameId => {
                            if (!updateData[gameId]) updateData[gameId] = {};
                            updateData[gameId].dailyPlayLimit = limit;
                            updateData[gameId].updatedAt = serverTimestamp();
                        });
                        
                        await setDoc(gameRef, updateData);
                        
                        // Log action
                        await logAdminAction('set_global_play_limit', { limit });
                        
                        showToast(`Daily play limit of ${limit} applied to all games`, "success");
                        loadGamesData();
                        loadDetailedGameStats();
                        
                    } catch (error) {
                        console.error("Error applying global limit:", error);
                        showToast("Failed to apply global limit", "error");
                    } finally {
                        hideLoader();
                    }
                }
            );
        }

        async function applyGlobalReward() {
            const reward = parseInt(document.getElementById('global-reward').value);
            
            if (isNaN(reward) || reward < 0) {
                showToast("Please enter a valid positive number", "error");
                return;
            }
            
            showConfirm(
                `Apply reward of ${reward} points to ALL games?`,
                async () => {
                    showLoader();
                    try {
                        const gameRef = doc(db, "config", "games");
                        const gameSnap = await getDoc(gameRef);
                        const currentData = gameSnap.exists() ? gameSnap.data() : {};
                        
                        const updateData = { ...currentData };
                        
                        // Update all games
                        ['colorGame', 'watchVideo', 'ludoDice'].forEach(gameId => {
                            if (!updateData[gameId]) updateData[gameId] = {};
                            updateData[gameId].rewardPerPlay = reward;
                            updateData[gameId].updatedAt = serverTimestamp();
                        });
                        
                        await setDoc(gameRef, updateData);
                        
                        // Log action
                        await logAdminAction('set_global_reward', { reward });
                        
                        showToast(`Reward of ${reward} points applied to all games`, "success");
                        loadGamesData();
                        loadDetailedGameStats();
                        
                    } catch (error) {
                        console.error("Error applying global reward:", error);
                        showToast("Failed to apply global reward", "error");
                    } finally {
                        hideLoader();
                    }
                }
            );
        }

        async function showAllGames() {
            showConfirm(
                "Make ALL games visible in the app?",
                async () => {
                    showLoader();
                    try {
                        const gameRef = doc(db, "config", "games");
                        const gameSnap = await getDoc(gameRef);
                        const currentData = gameSnap.exists() ? gameSnap.data() : {};
                        
                        const updateData = { ...currentData };
                        
                        // Show all games
                        ['colorGame', 'watchVideo', 'ludoDice'].forEach(gameId => {
                            if (!updateData[gameId]) updateData[gameId] = {};
                            updateData[gameId].visible = true;
                            updateData[gameId].updatedAt = serverTimestamp();
                        });
                        
                        await setDoc(gameRef, updateData);
                        
                        // Log action
                        await logAdminAction('show_all_games', {});
                        
                        showToast("All games are now visible", "success");
                        loadGamesData();
                        loadDetailedGameStats();
                        
                    } catch (error) {
                        console.error("Error showing all games:", error);
                        showToast("Failed to show all games", "error");
                    } finally {
                        hideLoader();
                    }
                }
            );
        }

        async function hideAllGames() {
            showConfirm(
                "Hide ALL games from the app?",
                async () => {
                    showLoader();
                    try {
                        const gameRef = doc(db, "config", "games");
                        const gameSnap = await getDoc(gameRef);
                        const currentData = gameSnap.exists() ? gameSnap.data() : {};
                        
                        const updateData = { ...currentData };
                        
                        // Hide all games
                        ['colorGame', 'watchVideo', 'ludoDice'].forEach(gameId => {
                            if (!updateData[gameId]) updateData[gameId] = {};
                            updateData[gameId].visible = false;
                            updateData[gameId].updatedAt = serverTimestamp();
                        });
                        
                        await setDoc(gameRef, updateData);
                        
                        // Log action
                        await logAdminAction('hide_all_games', {});
                        
                        showToast("All games are now hidden", "success");
                        loadGamesData();
                        loadDetailedGameStats();
                        
                    } catch (error) {
                        console.error("Error hiding all games:", error);
                        showToast("Failed to hide all games", "error");
                    } finally {
                        hideLoader();
                    }
                }
            );
        }

        async function resetGameStats() {
            showConfirm(
                "Are you sure you want to reset ALL game statistics? This cannot be undone.",
                async () => {
                    showLoader();
                    try {
                        const gameRef = doc(db, "config", "games");
                        const gameSnap = await getDoc(gameRef);
                        const currentData = gameSnap.exists() ? gameSnap.data() : {};
                        
                        // Keep game configurations but reset stats
                        const updateData = {
                            ...currentData,
                            dailyStats: {},
                            allTimeStats: {},
                            updatedAt: serverTimestamp()
                        };
                        
                        await setDoc(gameRef, updateData);
                        
                        // Log action
                        await logAdminAction('reset_game_stats', {});
                        
                        showToast("Game statistics reset successfully", "success");
                        loadDetailedGameStats();
                        
                    } catch (error) {
                        console.error("Error resetting game stats:", error);
                        showToast("Failed to reset game statistics", "error");
                    } finally {
                        hideLoader();
                    }
                }
            );
        }

        // ============================
        // AD NETWORKS
        // ============================
        async function loadAdNetworks() {
            const page = document.getElementById('ads');
            page.innerHTML = `
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">Ad Networks Configuration</h1>
                    <p class="text-gray-600">Configure ad network settings for your app</p>
                </div>
                
                <!-- AdsGram Configuration -->
                <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="p-3 bg-green-100 rounded-xl">
                            <i class="fas fa-ad text-green-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">AdsGram Configuration</h3>
                            <p class="text-sm text-gray-600">Configure AdsGram ad blocks</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Interstitial Block ID
                            </label>
                            <input type="text" id="adsgram-interstitial-id" class="input-field" 
                                   placeholder="int-21144">
                            <p class="text-xs text-gray-500 mt-1">AdsGram interstitial ad block ID</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Reward Block ID
                            </label>
                            <input type="text" id="adsgram-reward-id" class="input-field" 
                                   placeholder="21145">
                            <p class="text-xs text-gray-500 mt-1">AdsGram reward video ad block ID</p>
                        </div>
                    </div>
                </div>
                
                <!-- RichAds Configuration -->
                <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="p-3 bg-blue-100 rounded-xl">
                            <i class="fas fa-chart-line text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">RichAds Configuration</h3>
                            <p class="text-sm text-gray-600">Configure RichAds for Telegram</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Publisher ID
                            </label>
                            <input type="text" id="richads-pub-id" class="input-field" 
                                   placeholder="956231">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                App ID
                            </label>
                            <input type="text" id="richads-app-id" class="input-field" 
                                   placeholder="5673">
                        </div>
                    </div>
                </div>
                
                <!-- Taddy.pro Configuration -->
                <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="p-3 bg-purple-100 rounded-xl">
                            <i class="fas fa-rocket text-purple-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Taddy.pro Configuration</h3>
                            <p class="text-gray-600">Configure Taddy.pro ad network</p>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Public ID
                        </label>
                        <input type="text" id="taddy-public-id" class="input-field" 
                               placeholder="6ca0ab17ec8eee8a7ba810ef4f686359">
                        <p class="text-xs text-gray-500 mt-1">Taddy.pro public identifier</p>
                    </div>
                </div>
                
                <!-- Ad Testing -->
                <div class="bg-white rounded-2xl shadow-sm p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-6">Ad Network Testing</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button onclick="testAdsGram()" class="btn btn-success">
                            <i class="fas fa-play"></i> Test AdsGram
                        </button>
                        <button onclick="testRichAds()" class="btn btn-info">
                            <i class="fas fa-play"></i> Test RichAds
                        </button>
                        <button onclick="testTaddy()" class="btn btn-purple-600">
                            <i class="fas fa-play"></i> Test Taddy.pro
                        </button>
                    </div>
                    <div class="mt-4 p-4 bg-gray-50 rounded-xl">
                        <p class="text-sm text-gray-600" id="ad-test-result">
                            Click a test button to check ad network configuration
                        </p>
                    </div>
                </div>
                
                <!-- Save Button -->
                <div class="mt-8">
                    <button onclick="saveAdConfigurations()" class="btn btn-primary px-8 py-3 text-lg w-full">
                        <i class="fas fa-save mr-2"></i> Save All Ad Configurations
                    </button>
                </div>
            `;
            
            await loadAdConfigurations();
        }

        async function loadAdConfigurations() {
            try {
                const configSnap = await getDoc(doc(db, "config", "ads"));
                if (configSnap.exists()) {
                    const config = configSnap.data();
                    
                    if (config.adsgram) {
                        document.getElementById('adsgram-interstitial-id').value = config.adsgram.interstitialId || '';
                        document.getElementById('adsgram-reward-id').value = config.adsgram.rewardId || '';
                    }
                    
                    if (config.richads) {
                        document.getElementById('richads-pub-id').value = config.richads.pubId || '';
                        document.getElementById('richads-app-id').value = config.richads.appId || '';
                    }
                    
                    if (config.taddy) {
                        document.getElementById('taddy-public-id').value = config.taddy.publicId || '';
                    }
                }
            } catch (error) {
                console.error("Error loading ad configurations:", error);
            }
        }

        async function saveAdConfigurations() {
            showLoader();
            try {
                const adConfig = {
                    adsgram: {
                        interstitialId: document.getElementById('adsgram-interstitial-id').value.trim(),
                        rewardId: document.getElementById('adsgram-reward-id').value.trim(),
                        updatedAt: serverTimestamp()
                    },
                    richads: {
                        pubId: document.getElementById('richads-pub-id').value.trim(),
                        appId: document.getElementById('richads-app-id').value.trim(),
                        updatedAt: serverTimestamp()
                    },
                    taddy: {
                        publicId: document.getElementById('taddy-public-id').value.trim(),
                        updatedAt: serverTimestamp()
                    },
                    updatedAt: serverTimestamp()
                };
                
                await setDoc(doc(db, "config", "ads"), adConfig);
                
                // Log action
                await logAdminAction('save_ad_config', {});
                
                showToast("Ad configurations saved successfully", "success");
            } catch (error) {
                console.error("Error saving ad configurations:", error);
                showToast("Failed to save ad configurations", "error");
            } finally {
                hideLoader();
            }
        }

        function testAdsGram() {
            document.getElementById('ad-test-result').innerHTML = 
                '<span class="text-yellow-600"><i class="fas fa-sync-alt fa-spin mr-2"></i>Testing AdsGram configuration...</span>';
            
            setTimeout(() => {
                const interstitialId = document.getElementById('adsgram-interstitial-id').value;
                const rewardId = document.getElementById('adsgram-reward-id').value;
                
                if (interstitialId && rewardId) {
                    document.getElementById('ad-test-result').innerHTML = 
                        '<span class="text-green-600"><i class="fas fa-check-circle mr-2"></i>AdsGram configuration looks valid</span>';
                } else {
                    document.getElementById('ad-test-result').innerHTML = 
                        '<span class="text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>Please enter both AdsGram IDs</span>';
                }
            }, 1000);
        }

        function testRichAds() {
            document.getElementById('ad-test-result').innerHTML = 
                '<span class="text-yellow-600"><i class="fas fa-sync-alt fa-spin mr-2"></i>Testing RichAds configuration...</span>';
            
            setTimeout(() => {
                const pubId = document.getElementById('richads-pub-id').value;
                const appId = document.getElementById('richads-app-id').value;
                
                if (pubId && appId) {
                    document.getElementById('ad-test-result').innerHTML = 
                        '<span class="text-green-600"><i class="fas fa-check-circle mr-2"></i>RichAds configuration looks valid</span>';
                } else {
                    document.getElementById('ad-test-result').innerHTML = 
                        '<span class="text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>Please enter both RichAds IDs</span>';
                }
            }, 1000);
        }

        function testTaddy() {
            document.getElementById('ad-test-result').innerHTML = 
                '<span class="text-yellow-600"><i class="fas fa-sync-alt fa-spin mr-2"></i>Testing Taddy.pro configuration...</span>';
            
            setTimeout(() => {
                const publicId = document.getElementById('taddy-public-id').value;
                
                if (publicId && publicId.length >= 32) {
                    document.getElementById('ad-test-result').innerHTML = 
                        '<span class="text-green-600"><i class="fas fa-check-circle mr-2"></i>Taddy.pro configuration looks valid</span>';
                } else {
                    document.getElementById('ad-test-result').innerHTML = 
                        '<span class="text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>Please enter a valid Taddy.pro public ID</span>';
                }
            }, 1000);
        }

        // ============================
        // NOTIFICATIONS
        // ============================
        async function loadNotifications() {
            const page = document.getElementById('notifications');
            page.innerHTML = `
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">Notifications</h1>
                    <p class="text-gray-600">Send notifications to all Telegram users</p>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Send Notification -->
                    <div class="bg-white rounded-2xl shadow-sm p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-6">Send Notification</h3>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                                <input type="text" id="notification-title" class="input-field" 
                                       placeholder="Important Announcement">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Message</label>
                                <textarea id="notification-message" rows="5" class="input-field" 
                                          placeholder="Enter your notification message here..."></textarea>
                            </div>
                            
                            <div>
                                <label class="flex items-center gap-2 mb-4">
                                    <input type="checkbox" id="notification-urgent" class="rounded">
                                    <span class="text-sm font-medium text-gray-700">Mark as urgent</span>
                                </label>
                                
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="notification-telegram" class="rounded" checked>
                                    <span class="text-sm font-medium text-gray-700">Also send to Telegram</span>
                                </label>
                            </div>
                            
                            <button onclick="sendNotification()" class="btn btn-primary w-full">
                                <i class="fas fa-paper-plane mr-2"></i> Send Notification
                            </button>
                        </div>
                    </div>
                    
                    <!-- Notification History -->
                    <div class="bg-white rounded-2xl shadow-sm p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-gray-800">Recent Notifications</h3>
                            <button onclick="loadNotificationHistory()" class="btn btn-sm btn-secondary">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        
                        <div id="notification-history" class="space-y-4 max-h-[500px] overflow-y-auto">
                            <div class="flex items-center justify-center py-12">
                                <div class="loader"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            await loadNotificationHistory();
        }

        async function sendNotification() {
            const title = document.getElementById('notification-title').value.trim();
            const message = document.getElementById('notification-message').value.trim();
            const isUrgent = document.getElementById('notification-urgent').checked;
            const sendToTelegram = document.getElementById('notification-telegram').checked;
            
            if (!title || !message) {
                showToast("Please enter both title and message", "error");
                return;
            }
            
            showLoader();
            try {
                const notificationData = {
                    title,
                    message,
                    isUrgent,
                    sentToAll: true,
                    sentToTelegram: sendToTelegram,
                    createdAt: serverTimestamp(),
                    sentBy: currentAdmin.uid
                };
                
                // Save to notifications collection
                await setDoc(doc(db, "notifications", Date.now().toString()), notificationData);
                
                // Save to app config for users to see
                const configRef = doc(db, "config", "main");
                const configSnap = await getDoc(configRef);
                const currentConfig = configSnap.exists() ? configSnap.data() : {};
                
                await updateDoc(configRef, {
                    latestNotification: {
                        ...notificationData,
                        createdAt: new Date().toISOString()
                    },
                    updatedAt: serverTimestamp()
                });
                
                // Send to Telegram if enabled
                if (sendToTelegram) {
                    await sendTelegramNotification(title, message);
                }
                
                // Log action
                await logAdminAction('send_notification', {
                    title,
                    messageLength: message.length,
                    isUrgent,
                    sendToTelegram
                });
                
                showToast("Notification sent successfully", "success");
                
                // Clear form
                document.getElementById('notification-title').value = '';
                document.getElementById('notification-message').value = '';
                document.getElementById('notification-urgent').checked = false;
                
                // Reload history
                loadNotificationHistory();
                
            } catch (error) {
                console.error("Error sending notification:", error);
                showToast("Failed to send notification", "error");
            } finally {
                hideLoader();
            }
        }

        async function sendTelegramNotification(title, message) {
            try {
                const configSnap = await getDoc(doc(db, "config", "telegram"));
                if (!configSnap.exists()) return;
                
                const config = configSnap.data();
                if (!config.botToken || !config.chatId) return;
                
                const telegramMessage = `*${title}*\n\n${message}`;
                
                const response = await fetch(`https://api.telegram.org/bot${config.botToken}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: config.chatId,
                        text: telegramMessage,
                        parse_mode: 'Markdown'
                    })
                });
                
                const result = await response.json();
                if (!result.ok) {
                    throw new Error(result.description || 'Telegram API error');
                }
            } catch (error) {
                console.error("Error sending to Telegram:", error);
                // Don't fail the whole operation if Telegram fails
            }
        }

        async function loadNotificationHistory() {
            try {
                const snap = await getDocs(query(
                    collection(db, "notifications"),
                    orderBy("createdAt", "desc"),
                    limit(10)
                ));
                
                let html = '';
                if (snap.empty) {
                    html = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-bell text-3xl mb-3 opacity-50"></i>
                            <p>No notifications sent yet</p>
                        </div>
                    `;
                } else {
                    snap.forEach(doc => {
                        const data = doc.data();
                        const date = data.createdAt?.toDate().toLocaleString() || 'N/A';
                        const isUrgent = data.isUrgent;
                        
                        html += `
                            <div class="p-4 border border-gray-200 rounded-xl ${isUrgent ? 'bg-red-50 border-red-200' : ''}">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-bold text-gray-800">${data.title}</h4>
                                    ${isUrgent ? `
                                        <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">
                                            <i class="fas fa-exclamation-triangle mr-1"></i>Urgent
                                        </span>
                                    ` : ''}
                                </div>
                                <p class="text-gray-600 text-sm mb-3">${data.message}</p>
                                <div class="flex justify-between items-center text-xs text-gray-500">
                                    <span>${date}</span>
                                    ${data.sentToTelegram ? `
                                        <span class="flex items-center gap-1">
                                            <i class="fab fa-telegram text-blue-500"></i>
                                            <span>Telegram</span>
                                        </span>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('notification-history').innerHTML = html;
            } catch (error) {
                console.error("Error loading notification history:", error);
                document.getElementById('notification-history').innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>Failed to load notifications</p>
                    </div>
                `;
            }
        }

        // ============================
        // APP SETTINGS - FIXED FOR PAYMENT VALIDATION
        // ============================
        async function loadSettings() {
            const page = document.getElementById('settings');
            page.innerHTML = `
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">App Settings</h1>
                    <p class="text-gray-600">Configure your application settings</p>
                </div>
                
                <!-- Settings Tabs -->
                <div class="tab-container">
                    <div class="tab active" onclick="switchSettingsTab('general')">General</div>
                    <div class="tab" onclick="switchSettingsTab('points')">Points & Rewards</div>
                    <div class="tab" onclick="switchSettingsTab('payment')">Payment</div>
                    <div class="tab" onclick="switchSettingsTab('security')">Security</div>
                </div>
                
                <!-- General Settings -->
                <div id="general-settings" class="settings-tab active">
                    <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-6">General Settings</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">App Name</label>
                                <input type="text" id="app-name" class="input-field" placeholder="CashReward">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Daily Ad Limit</label>
                                <input type="number" id="daily-ad-limit" class="input-field" placeholder="100">
                                <p class="text-xs text-gray-500 mt-1">Maximum ads per user per day</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Maintenance Mode</label>
                                <label class="switch">
                                    <input type="checkbox" id="maintenance-mode">
                                    <span class="slider"></span>
                                </label>
                                <p class="text-xs text-gray-500 mt-1">When enabled, users cannot use the app</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Maintenance Message</label>
                                <textarea id="maintenance-message" class="input-field" rows="2" 
                                          placeholder="App is under maintenance. Please try again later."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Points & Rewards Settings -->
                <div id="points-settings" class="settings-tab hidden">
                    <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-6">Points & Rewards</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ad Watch Reward</label>
                                <input type="number" id="ad-watch-reward" class="input-field" placeholder="50">
                                <p class="text-xs text-gray-500 mt-1">Points for watching an ad</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Color Game Reward</label>
                                <input type="number" id="color-game-reward" class="input-field" placeholder="100">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ludo Dice Reward</label>
                                <input type="number" id="ludo-dice-reward" class="input-field" placeholder="50">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Referral Bonus</label>
                                <input type="number" id="referral-bonus" class="input-field" placeholder="100">
                            </div>
                            
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Coin Value</label>
                                <div class="flex items-center gap-4">
                                    <div class="flex-1">
                                        <input type="number" id="coin-value-coins" class="input-field" placeholder="1000">
                                        <p class="text-xs text-gray-500 mt-1">Coins</p>
                                    </div>
                                    <span class="text-gray-500">=</span>
                                    <div class="flex-1">
                                        <input type="number" id="coin-value-inr" class="input-field" placeholder="10">
                                        <p class="text-xs text-gray-500 mt-1">₹ INR</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Settings -->
                <div id="payment-settings" class="settings-tab hidden">
                    <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-6">Payment Settings</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Withdrawal (Points)</label>
                                <input type="number" id="min-withdrawal-points" class="input-field" placeholder="1000">
                                <p class="text-xs text-gray-500 mt-1">Minimum points required for withdrawal</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Withdrawal (Cash)</label>
                                <input type="number" id="min-withdrawal-cash" class="input-field" placeholder="10">
                                <p class="text-xs text-gray-500 mt-1">Minimum cash value in ₹</p>
                            </div>
                            
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Payment Methods</label>
                                <textarea id="payment-methods" class="input-field" rows="3" 
                                          placeholder="UPI&#10;Paytm&#10;PhonePe&#10;Google Pay&#10;Bkash&#10;Nagad&#10;Rocket"></textarea>
                                <p class="text-xs text-gray-500 mt-1">One payment method per line</p>
                            </div>
                            
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Withdrawal Processing Time</label>
                                <select id="withdrawal-time" class="input-field">
                                    <option value="instant">Instant (Within minutes)</option>
                                    <option value="24h">24 Hours</option>
                                    <option value="48h">48 Hours</option>
                                    <option value="72h">72 Hours</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Estimated time to process withdrawals</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Security Settings -->
                <div id="security-settings" class="settings-tab hidden">
                    <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-6">Security Settings</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">IPinfo API Token</label>
                                <input type="text" id="ipinfo-api-token" class="input-field" 
                                       placeholder="Enter IPinfo token">
                                <p class="text-xs text-gray-500 mt-1">For country detection</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Allowed Countries</label>
                                <input type="text" id="allowed-countries" class="input-field" 
                                       placeholder="bd, in, pk, us, uk">
                                <p class="text-xs text-gray-500 mt-1">Comma separated country codes</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Session Timeout</label>
                                <select id="session-timeout" class="input-field">
                                    <option value="15">15 minutes</option>
                                    <option value="30">30 minutes</option>
                                    <option value="60" selected>60 minutes</option>
                                    <option value="120">2 hours</option>
                                    <option value="240">4 hours</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Max Login Attempts</label>
                                <input type="number" id="max-login-attempts" class="input-field" value="5" min="1" max="10">
                            </div>
                            
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Blocked Country Message</label>
                                <textarea id="blocked-country-message" class="input-field" rows="3"
                                          placeholder="Sorry, this app is not available in your country."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Save Button -->
                <button onclick="saveAllSettings()" class="btn btn-primary px-8 py-3 text-lg w-full">
                    <i class="fas fa-save mr-2"></i> Save All Settings
                </button>
            `;
            
            await loadSettingsData();
        }

        async function loadSettingsData() {
            try {
                const configSnap = await getDoc(doc(db, "config", "main"));
                if (!configSnap.exists()) return;
                
                const config = configSnap.data();
                
                // General settings
                if (config.appName) document.getElementById('app-name').value = config.appName;
                if (config.dailyAdLimit) document.getElementById('daily-ad-limit').value = config.dailyAdLimit;
                if (config.maintenanceMode) document.getElementById('maintenance-mode').checked = config.maintenanceMode;
                if (config.maintenanceMessage) document.getElementById('maintenance-message').value = config.maintenanceMessage;
                
                // Points settings
                if (config.adWatchReward) document.getElementById('ad-watch-reward').value = config.adWatchReward;
                if (config.colorGameReward) document.getElementById('color-game-reward').value = config.colorGameReward;
                if (config.ludoDiceReward) document.getElementById('ludo-dice-reward').value = config.ludoDiceReward;
                if (config.referralBonus) document.getElementById('referral-bonus').value = config.referralBonus;
                if (config.coinValueCoins) document.getElementById('coin-value-coins').value = config.coinValueCoins;
                if (config.coinValueInr) document.getElementById('coin-value-inr').value = config.coinValueInr;
                
                // Payment settings
                if (config.minWithdrawal) document.getElementById('min-withdrawal-points').value = config.minWithdrawal;
                if (config.minWithdrawalCash) document.getElementById('min-withdrawal-cash').value = config.minWithdrawalCash;
                if (config.paymentMethods) {
                    document.getElementById('payment-methods').value = Array.isArray(config.paymentMethods) 
                        ? config.paymentMethods.join('\n')
                        : config.paymentMethods;
                }
                if (config.withdrawalTime) document.getElementById('withdrawal-time').value = config.withdrawalTime;
                
                // Security settings
                if (config.ipinfoApiToken) document.getElementById('ipinfo-api-token').value = config.ipinfoApiToken;
                if (config.allowedCountries) {
                    document.getElementById('allowed-countries').value = Array.isArray(config.allowedCountries)
                        ? config.allowedCountries.join(', ')
                        : config.allowedCountries;
                }
                if (config.sessionTimeout) document.getElementById('session-timeout').value = config.sessionTimeout;
                if (config.maxLoginAttempts) document.getElementById('max-login-attempts').value = config.maxLoginAttempts;
                if (config.blockedCountryMessage) document.getElementById('blocked-country-message').value = config.blockedCountryMessage;
                
            } catch (error) {
                console.error("Error loading settings:", error);
                showToast("Failed to load settings", "error");
            }
        }

        function switchSettingsTab(tabName) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll(`.tab`).forEach(tab => {
                if (tab.textContent.toLowerCase().includes(tabName)) {
                    tab.classList.add('active');
                }
            });
            
            // Update content
            document.querySelectorAll('.settings-tab').forEach(content => content.classList.add('hidden'));
            document.getElementById(`${tabName}-settings`).classList.remove('hidden');
        }

        async function saveAllSettings() {
            showLoader();
            try {
                const paymentMethodsText = document.getElementById('payment-methods').value;
                const paymentMethods = paymentMethodsText
                    .split('\n')
                    .map(method => method.trim())
                    .filter(method => method.length > 0);
                
                const allowedCountriesText = document.getElementById('allowed-countries').value;
                const allowedCountries = allowedCountriesText
                    .split(',')
                    .map(country => country.trim().toLowerCase())
                    .filter(country => country.length > 0);
                
                const settings = {
                    // General
                    appName: document.getElementById('app-name').value.trim() || 'CashReward',
                    dailyAdLimit: parseInt(document.getElementById('daily-ad-limit').value) || 100,
                    maintenanceMode: document.getElementById('maintenance-mode').checked,
                    maintenanceMessage: document.getElementById('maintenance-message').value.trim() || 'App is under maintenance. Please try again later.',
                    
                    // Points
                    adWatchReward: parseInt(document.getElementById('ad-watch-reward').value) || 50,
                    colorGameReward: parseInt(document.getElementById('color-game-reward').value) || 100,
                    ludoDiceReward: parseInt(document.getElementById('ludo-dice-reward').value) || 50,
                    referralBonus: parseInt(document.getElementById('referral-bonus').value) || 100,
                    coinValueCoins: parseInt(document.getElementById('coin-value-coins').value) || 1000,
                    coinValueInr: parseInt(document.getElementById('coin-value-inr').value) || 10,
                    
                    // Payment - FIXED: Save both points and cash values
                    minWithdrawal: parseInt(document.getElementById('min-withdrawal-points').value) || 1000,
                    minWithdrawalCash: parseInt(document.getElementById('min-withdrawal-cash').value) || 10,
                    paymentMethods: paymentMethods.length > 0 ? paymentMethods : ['UPI', 'Paytm', 'PhonePe'],
                    withdrawalTime: document.getElementById('withdrawal-time').value,
                    
                    // Security
                    ipinfoApiToken: document.getElementById('ipinfo-api-token').value.trim(),
                    allowedCountries: allowedCountries.length > 0 ? allowedCountries : ['bd', 'in', 'pk'],
                    sessionTimeout: parseInt(document.getElementById('session-timeout').value) || 60,
                    maxLoginAttempts: parseInt(document.getElementById('max-login-attempts').value) || 5,
                    blockedCountryMessage: document.getElementById('blocked-country-message').value.trim() || 'Sorry, this app is not available in your country.',
                    
                    updatedAt: serverTimestamp()
                };
                
                await setDoc(doc(db, "config", "main"), settings);
                
                // Log action
                await logAdminAction('save_settings', {});
                
                showToast("Settings saved successfully", "success");
                
            } catch (error) {
                console.error("Error saving settings:", error);
                showToast("Failed to save settings", "error");
            } finally {
                hideLoader();
            }
        }

        // ============================
        // BACKUP & RESTORE
        // ============================
        async function loadBackup() {
            const page = document.getElementById('backup');
            page.innerHTML = `
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">Backup & Restore</h1>
                    <p class="text-gray-600">Backup and restore your application data</p>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Backup Section -->
                    <div class="bg-white rounded-2xl shadow-sm p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-6">Create Backup</h3>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Select Data to Backup</label>
                                <div class="space-y-2">
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="rounded" checked data-collection="users">
                                        <span class="text-gray-700">Users</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="rounded" checked data-collection="withdrawals">
                                        <span class="text-gray-700">Withdrawals</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="rounded" checked data-collection="pointHistory">
                                        <span class="text-gray-700">Point History</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="rounded" checked data-collection="notifications">
                                        <span class="text-gray-700">Notifications</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="rounded" checked data-collection="config">
                                        <span class="text-gray-700">Configuration</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Backup Name</label>
                                <input type="text" id="backup-name" class="input-field" 
                                       value="backup_${new Date().toISOString().split('T')[0]}">
                            </div>
                            
                            <button onclick="createBackup()" class="btn btn-primary w-full">
                                <i class="fas fa-download mr-2"></i> Create Backup
                            </button>
                        </div>
                    </div>
                    
                    <!-- Restore Section -->
                    <div class="bg-white rounded-2xl shadow-sm p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-6">Restore Backup</h3>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Upload Backup File</label>
                                <input type="file" id="backup-file" class="input-field" accept=".json">
                                <p class="text-xs text-gray-500 mt-1">Select a JSON backup file</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Restore Options</label>
                                <div class="space-y-2">
                                    <label class="flex items-center gap-2">
                                        <input type="radio" name="restore-mode" class="rounded" value="merge" checked>
                                        <span class="text-gray-700">Merge with existing data</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="radio" name="restore-mode" class="rounded" value="replace">
                                        <span class="text-gray-700">Replace existing data</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="p-4 bg-yellow-50 rounded-xl border border-yellow-200">
                                <div class="flex items-start gap-2">
                                    <i class="fas fa-exclamation-triangle text-yellow-600 mt-0.5"></i>
                                    <div>
                                        <p class="text-sm text-yellow-800 font-medium mb-1">Warning</p>
                                        <p class="text-xs text-yellow-700">Restoring data will modify your database. Make sure you have a current backup.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <button onclick="restoreBackup()" class="btn btn-danger w-full">
                                <i class="fas fa-upload mr-2"></i> Restore Backup
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Backup History -->
                <div class="bg-white rounded-2xl shadow-sm p-6 mt-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-gray-800">Recent Backups</h3>
                        <button onclick="loadBackupHistory()" class="btn btn-sm btn-secondary">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    
                    <div id="backup-history" class="space-y-4">
                        <div class="flex items-center justify-center py-8">
                            <div class="loader"></div>
                        </div>
                    </div>
                </div>
            `;
            
            await loadBackupHistory();
        }

        async function createBackup() {
            showLoader();
            try {
                const selectedCollections = Array.from(
                    document.querySelectorAll('[data-collection]:checked')
                ).map(cb => cb.dataset.collection);
                
                const backupName = document.getElementById('backup-name').value.trim() || 
                                 `backup_${new Date().toISOString().split('T')[0]}`;
                
                const backup = {
                    metadata: {
                        name: backupName,
                        createdAt: new Date().toISOString(),
                        collections: selectedCollections,
                        admin: currentAdmin.email
                    },
                    data: {}
                };
                
                // Fetch data from selected collections
                for (const collectionName of selectedCollections) {
                    const snap = await getDocs(collection(db, collectionName));
                    backup.data[collectionName] = snap.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                }
                
                // Convert to JSON and download
                const dataStr = JSON.stringify(backup, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${backupName}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                // Save backup info
                await setDoc(doc(db, "backups", Date.now().toString()), {
                    name: backupName,
                    collections: selectedCollections,
                    size: dataStr.length,
                    createdAt: serverTimestamp(),
                    createdBy: currentAdmin.email
                });
                
                // Log action
                await logAdminAction('create_backup', {
                    name: backupName,
                    collections: selectedCollections,
                    size: dataStr.length
                });
                
                showToast("Backup created successfully", "success");
                loadBackupHistory();
                
            } catch (error) {
                console.error("Error creating backup:", error);
                showToast("Failed to create backup", "error");
            } finally {
                hideLoader();
            }
        }

        async function restoreBackup() {
            const fileInput = document.getElementById('backup-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showToast("Please select a backup file", "error");
                return;
            }
            
            const restoreMode = document.querySelector('input[name="restore-mode"]:checked').value;
            
            showConfirm(
                `Are you sure you want to restore backup in ${restoreMode} mode?`,
                async () => {
                    showLoader();
                    try {
                        const text = await file.text();
                        const backup = JSON.parse(text);
                        
                        // Validate backup structure
                        if (!backup.metadata || !backup.data) {
                            throw new Error("Invalid backup file format");
                        }
                        
                        const batch = writeBatch(db);
                        
                        // Process each collection
                        for (const [collectionName, documents] of Object.entries(backup.data)) {
                            if (restoreMode === 'replace') {
                                // Delete existing documents
                                const existingSnap = await getDocs(collection(db, collectionName));
                                existingSnap.forEach(doc => {
                                    batch.delete(doc.ref);
                                });
                            }
                            
                            // Add/update documents from backup
                            documents.forEach(docData => {
                                const docRef = doc(db, collectionName, docData.id);
                                const { id, ...data } = docData;
                                batch.set(docRef, data, { merge: true });
                            });
                        }
                        
                        await batch.commit();
                        
                        // Log action
                        await logAdminAction('restore_backup', {
                            name: backup.metadata.name,
                            mode: restoreMode,
                            collections: Object.keys(backup.data)
                        });
                        
                        showToast("Backup restored successfully", "success");
                        fileInput.value = '';
                        
                    } catch (error) {
                        console.error("Error restoring backup:", error);
                        showToast("Failed to restore backup: " + error.message, "error");
                    } finally {
                        hideLoader();
                    }
                }
            );
        }

        async function loadBackupHistory() {
            try {
                const snap = await getDocs(query(
                    collection(db, "backups"),
                    orderBy("createdAt", "desc"),
                    limit(10)
                ));
                
                let html = '';
                if (snap.empty) {
                    html = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-database text-3xl mb-3 opacity-50"></i>
                            <p>No backups found</p>
                        </div>
                    `;
                } else {
                    snap.forEach(doc => {
                        const data = doc.data();
                        const date = data.createdAt?.toDate().toLocaleString() || 'N/A';
                        const size = formatBytes(data.size || 0);
                        
                        html += `
                            <div class="p-4 border border-gray-200 rounded-xl">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-bold text-gray-800">${data.name}</h4>
                                    <span class="text-xs text-gray-500">${size}</span>
                                </div>
                                <p class="text-sm text-gray-600 mb-3">
                                    <i class="fas fa-layer-group mr-2"></i>
                                    ${data.collections?.join(', ') || 'No collections'}
                                </p>
                                <div class="flex justify-between items-center text-xs text-gray-500">
                                    <span>${date}</span>
                                    <span>By: ${data.createdBy || 'Unknown'}</span>
                                </div>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('backup-history').innerHTML = html;
            } catch (error) {
                console.error("Error loading backup history:", error);
                document.getElementById('backup-history').innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>Failed to load backup history</p>
                    </div>
                `;
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ============================
        // UTILITY FUNCTIONS
        // ============================
        function showLoader() {
            document.getElementById('loader').classList.remove('hidden');
        }

        function hideLoader() {
            document.getElementById('loader').classList.add('hidden');
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');
            
            // Set message and type
            toastMessage.textContent = message;
            toast.className = `toast-notification ${type}`;
            
            // Set icon based on type
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            toastIcon.className = `fas ${icons[type] || icons.info}`;
            
            // Show toast
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Auto hide
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(hideToast, 5000);
        }

        function hideToast() {
            const toast = document.getElementById('toast-notification');
            toast.classList.remove('show');
            setTimeout(() => toast.classList.add('hidden'), 500);
        }

        function showAlert(title, message) {
            const modal = document.getElementById('custom-alert');
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            modal.style.display = 'flex';
        }

        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function showConfirm(message, onConfirm) {
            const modal = document.getElementById('custom-confirm');
            document.getElementById('confirm-message').textContent = message;
            modal.style.display = 'flex';
            
            // Update event listeners
            const okBtn = document.getElementById('confirm-ok-btn');
            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);
            
            newOkBtn.addEventListener('click', () => {
                modal.style.display = 'none';
                onConfirm();
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            localStorage.setItem('darkMode', isDarkMode);
            document.body.classList.toggle('dark-mode', isDarkMode);
            showToast(`Dark mode ${isDarkMode ? 'enabled' : 'disabled'}`, 'info');
        }

        // ============================
        // INITIALIZE APPLICATION
        // ============================
        window.addEventListener('DOMContentLoaded', initializeApp);

        // Make functions available globally
        window.navigateTo = navigateTo;
        window.toggleUserBlock = toggleUserBlock;
        window.editUserPoints = editUserPoints;
        window.viewUserPointHistory = viewUserPointHistory;
        window.closeModal = hideModal;
        window.searchUsers = searchUsers;
        window.filterWithdrawals = filterWithdrawals;
        window.processWithdrawal = processWithdrawal;
        window.changeUsersPage = changeUsersPage;
        window.changeWithdrawalsPage = changeWithdrawalsPage;
        window.toggleSelectAll = toggleSelectAll;
        window.updateSelection = updateSelection;
        window.clearSelection = clearSelection;
        window.bulkBlockUsers = bulkBlockUsers;
        window.bulkUnblockUsers = bulkUnblockUsers;
        window.exportUsersToCSV = exportUsersToCSV;
        window.loadMorePointHistory = loadMorePointHistory;
        window.refreshGameStats = refreshGameStats;
        window.editGameSettings = editGameSettings;
        window.applyGlobalPlayLimit = applyGlobalPlayLimit;
        window.applyGlobalReward = applyGlobalReward;
        window.showAllGames = showAllGames;
        window.hideAllGames = hideAllGames;
        window.resetGameStats = resetGameStats;
        window.saveAdConfigurations = saveAdConfigurations;
        window.testAdsGram = testAdsGram;
        window.testRichAds = testRichAds;
        window.testTaddy = testTaddy;
        window.sendNotification = sendNotification;
        window.loadNotificationHistory = loadNotificationHistory;
        window.switchSettingsTab = switchSettingsTab;
        window.saveAllSettings = saveAllSettings;
        window.createBackup = createBackup;
        window.restoreBackup = restoreBackup;
        window.loadBackupHistory = loadBackupHistory;
        window.toggleDarkMode = toggleDarkMode;

    </script>
</body>
</html>
